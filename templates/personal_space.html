{% extends "base.html" %}

{% block title %}
<title>{{ title }}</title>
<meta name="description" content="{{ description }}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <style>
        .personal-space-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #3e2217 0%, #5a3328 100%);
            border-radius: 12px;
            color: white;
        }

        .personal-space-header h1 {
            color: white;
            margin: 0 0 0.5rem 0;
        }

        .personal-space-header p {
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        .personal-space-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        /* Strong, high-contrast styles for header stats */
        .personal-space-header .stat-number,
        .personal-space-header .stat-label {
            color: #fff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.35);
        }

        .personal-space-header .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .personal-space-header .stat-label {
            font-size: 0.85rem;
            font-weight: 600;
            opacity: 0.95;
        }

        .tab-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .tab-nav button {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-nav button:hover {
            color: #333;
            background: #f5f5f5;
        }

        .tab-nav button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-nav button .badge {
            background: #eee;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .tab-nav button.active .badge {
            background: var(--primary-color);
            color: white;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Card styles for saved posts */
        .saved-post-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .saved-post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .saved-post-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #f0f0f0;
            flex-shrink: 0;
        }

        .saved-post-thumb-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            flex-shrink: 0;
        }

        .saved-post-info {
            flex: 1;
            min-width: 0;
        }

        .saved-post-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            line-height: 1.3;
        }

        .saved-post-title a {
            color: #333;
            text-decoration: none;
        }

        .saved-post-title a:hover {
            color: var(--primary-color);
        }

        .saved-post-meta {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .saved-post-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-icon {
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            transition: background 0.2s;
        }

        .btn-view {
            background: #e8f4fd;
            color: #1976d2;
        }

        .btn-view:hover {
            background: #d0e8f9;
        }

        .btn-remove {
            background: #ffebee;
            color: #d32f2f;
        }

        .btn-remove:hover {
            background: #ffcdd2;
        }

        /* Note card styles */
        .note-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border-left: 4px solid var(--primary-color);
            position: relative;
        }

        .note-card.pinned {
            border-left-color: #ffc107;
            background: #fffdf5;
        }

        .note-content {
            word-break: break-word;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        /* Markdown rendered content styles */
        .note-content h1,
        .note-content h2,
        .note-content h3 {
            margin: 0.5em 0 0.3em 0;
            line-height: 1.3;
        }

        .note-content h1 {
            font-size: 1.4rem;
        }

        .note-content h2 {
            font-size: 1.2rem;
        }

        .note-content h3 {
            font-size: 1.1rem;
        }

        .note-content p {
            margin: 0.5em 0;
        }

        .note-content ul,
        .note-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .note-content li {
            margin: 0.25em 0;
        }

        .note-content blockquote {
            border-left: 3px solid var(--primary-color);
            margin: 0.5em 0;
            padding: 0.5em 1em;
            background: #f9f9f9;
            color: #555;
        }

        .note-content code {
            background: #f4f4f4;
            padding: 0.15em 0.4em;
            border-radius: 3px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .note-content pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .note-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .note-content a {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .note-content table {
            border-collapse: collapse;
            width: auto;
            max-width: 100%;
            margin: 1em 0;
            font-size: 0.95em;
            overflow-x: auto;
            display: block;
        }

        .note-content th,
        .note-content td {
            border: 1px solid #ccc;
            padding: 0.5em 0.75em;
            text-align: left;
            white-space: nowrap;
        }

        .note-content th {
            background: #f0f0f0;
            font-weight: 600;
        }

        .note-content tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .note-content tbody tr:hover {
            background: #f5f5f5;
        }

        /* === CRITICAL: Reset styles for KaTeX internal tables === */
        /* KaTeX uses <table> elements internally for fractions, matrices, etc. */
        /* Without these resets, math renders with data-table borders/backgrounds */
        .note-content .katex table,
        .note-content .katex-display table {
            border-collapse: initial;
            display: inline-table;
            margin: 0;
            border: none;
            overflow: visible;
            font-size: inherit;
            width: auto;
        }

        .note-content .katex td,
        .note-content .katex th,
        .note-content .katex-display td,
        .note-content .katex-display th {
            border: none;
            padding: 0;
            background: none !important;
            white-space: nowrap;
        }

        .note-content .katex tr,
        .note-content .katex-display tr {
            background: none !important;
        }

        .note-content .katex tr:hover,
        .note-content .katex-display tr:hover {
            background: none !important;
        }

        /* KaTeX inside data tables */
        .note-content td .katex,
        .note-content th .katex {
            font-size: 1em;
        }

        .note-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 1em 0;
        }

        /* Math (KaTeX) styles */
        .note-content .katex-display {
            margin: 0.5em 0;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
        }

        .note-content .katex {
            font-size: 1.1em;
        }

        /* Ensure inline KaTeX doesn't break layout */
        .note-content .katex-html {
            white-space: nowrap;
        }




        .note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        .note-date {
            font-size: 0.8rem;
            color: #999;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
        }

        .note-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            color: #666;
            font-size: 0.85rem;
        }

        .note-actions button:hover {
            background: #f5f5f5;
        }

        .note-actions .delete-btn:hover {
            background: #ffebee;
            color: #d32f2f;
        }

        /* Create note form */
        .create-note-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .create-note-card textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.75rem;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 1rem;
        }

        .create-note-card textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(62, 34, 23, 0.1);
        }

        .create-note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .char-count {
            font-size: 0.8rem;
            color: #999;
        }

        .char-count.warning {
            color: #f57c00;
        }

        .char-count.danger {
            color: #d32f2f;
        }

        /* Preview toggle */
        .preview-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #666;
            cursor: pointer;
            user-select: none;
        }

        .preview-toggle input {
            cursor: pointer;
        }

        .note-preview {
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            min-height: 80px;
            max-height: 300px;
            overflow-y: auto;
        }

        .note-preview.active {
            display: block;
        }

        .note-preview-label {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .format-hint {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.5rem;
        }

        .format-hint code {
            background: #f0f0f0;
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-size: 0.85em;
        }

        /* Quick actions */
        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            flex: 1;
            min-width: 140px;
            padding: 1rem;
            border: 2px dashed #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            text-decoration: none;
            color: #666;
        }

        .quick-action-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: #faf8f7;
        }

        .quick-action-btn i {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #888;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 0.5rem;
        }

        /* Search/filter */
        .search-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .search-filter input {
            flex: 1;
            padding: 0.6rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .search-filter input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Mobile optimizations */
        @media (max-width: 600px) {
            .personal-space-header {
                padding: 1rem;
            }

            .personal-space-stats {
                gap: 1rem;
            }

            .tab-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .tab-nav::-webkit-scrollbar {
                display: none;
            }

            .tab-nav button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                white-space: nowrap;
            }

            .saved-post-card {
                flex-direction: column;
            }

            .saved-post-thumb,
            .saved-post-thumb-placeholder {
                width: 100%;
                height: 120px;
            }

            .quick-action-btn {
                min-width: 100px;
                padding: 0.75rem;
            }

            .quick-action-btn i {
                font-size: 1.25rem;
            }


        }

        /* --- Sharing UI Styles --- */
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #666;
            transition: color 0.2s;
            font-size: 1.1rem;
        }

        .share-note-btn:hover {
            color: #3e2217;
        }

        .share-link-item {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-bottom: 0.5rem;
        }

        .share-link-url {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .share-link-url input {
            flex: 1;
            padding: 0.3rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            background: #fff;
        }

        .share-link-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #777;
        }
    </style>

    <!-- Header with stats -->
    <div class="personal-space-header">
        <h1>My Personal Space</h1>
        <p>Your private area for saved posts and personal notes</p>
        <div class="personal-space-stats">
            <div class="stat-item">
                <div class="stat-number">{{ saved_posts|length }}</div>
                <div class="stat-label">Saved Posts</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ personal_posts|length }}</div>
                <div class="stat-label">Notes</div>
            </div>
        </div>
        <div class="encrypt-note" aria-hidden="true">
            <i class="fas fa-lock"></i> Notes are end-to-end encrypted
        </div>
        <style>
            .encrypt-note {
                margin-top: 1rem;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                background: rgba(255, 255, 255, 0.12);
                padding: 0.4rem 0.8rem;
                border-radius: 20px;
                font-size: 0.85rem;
                color: #fff;
            }

            .encrypt-note i {
                color: #fff;
            }
        </style>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{{ url_for('blog') }}" class="quick-action-btn">
            <i class="fas fa-compass"></i>
            Explore Posts
        </a>
        <a href="{{ url_for('create_post') }}" class="quick-action-btn">
            <i class="fas fa-pen"></i>
            Create Post
        </a>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav" role="tablist">
        <button class="active" data-tab="saved" role="tab" aria-selected="true">
            Saved
            <span class="badge">{{ saved_posts|length }}</span>
        </button>
        <button data-tab="notes" role="tab" aria-selected="false">
            Notes
            <span class="badge">{{ personal_posts|length }}</span>
        </button>
    </div>

    <!-- Saved Posts Tab -->
    <div id="tab-saved" class="tab-panel active" role="tabpanel">
        {% if saved_posts %}
        <div class="search-filter">
            <input type="text" id="saved-search" placeholder="Search saved posts..." aria-label="Search saved posts">
        </div>
        <div class="saved-posts-list" id="saved-posts-container">
            {% for post in saved_posts %}
            <div class="saved-post-card" data-title="{{ post.title|lower }}" data-author="{{ post.author|lower }}">
                {% if post.image_urls and post.image_urls|length > 0 %}
                <img src="{{ post.image_urls[0] }}" alt="" class="saved-post-thumb" loading="lazy">
                {% elif post.image_url %}
                <img src="{{ post.image_url }}" alt="" class="saved-post-thumb" loading="lazy">
                {% else %}
                <div class="saved-post-thumb-placeholder">
                    <i class="fas fa-file-alt"></i>
                </div>
                {% endif %}
                <div class="saved-post-info">
                    <h3 class="saved-post-title">
                        <a href="{{ url_for('view_post', slug=post.slug) }}">{{ post.title }}</a>
                    </h3>
                    <div class="saved-post-meta">
                        <i class="fas fa-user"></i> {{ post.author }} &bull;
                        <i class="fas fa-calendar"></i> {{ post.timestamp|localtime('%b %d, %Y') }}
                        {% if post.view_count %}
                        &bull; <i class="fas fa-eye"></i> {{ post.view_count }}
                        {% endif %}
                    </div>
                    <div class="saved-post-actions">
                        <a href="{{ url_for('view_post', slug=post.slug) }}" class="btn-icon btn-view">
                            <i class="fas fa-arrow-right"></i> Read
                        </a>
                        <form action="{{ url_for('toggle_save_post', post_id=post._id) }}" method="POST"
                            style="display:inline;" class="unsave-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn-icon btn-remove">
                                <i class="fas fa-bookmark"></i> Unsave
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="far fa-bookmark"></i>
            <h3>No saved posts yet</h3>
            <p>Save posts you want to read later by clicking the bookmark icon on any post.</p>
            <a href="{{ url_for('blog') }}" class="btn comment-btn" style="margin-top: 1rem;">Explore Posts</a>
        </div>
        {% endif %}
    </div>

    <!-- Notes Tab -->
    <div id="tab-notes" class="tab-panel" role="tabpanel">
        <div class="create-note-card">
            <div
                style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; color: #666; font-size: 0.85rem;">
                Your notes are encrypted and only visible to you
            </div>
            <form action="{{ url_for('create_personal_post') }}" method="POST" id="create-note-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <textarea name="content" id="note-input" placeholder="Write a private note.." maxlength="8000"
                    required></textarea>
                <div class="format-hint">
                    Supports: <code>**bold**</code> <code>*italic*</code> <code>`code`</code> <code>$math$</code>
                    <code>$$block math$$</code>
                </div>
                <div class="create-note-footer">
                    <span class="char-count"><span id="char-count">0</span>/8000</span>
                    <label class="preview-toggle">
                        <input type="checkbox" id="preview-toggle">
                        Preview
                    </label>
                    <button type="submit" class="btn comment-btn" id="add-note-btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </div>
                <div class="note-preview" id="note-preview">
                    <div class="note-preview-label"> Preview</div>
                    <div class="note-content" id="preview-content"></div>
                </div>
            </form>
        </div>

        {% if personal_posts %}
        <div class="personal-notes-list">
            {% for note in personal_posts %}
            <div class="note-card">
                <div class="note-content rendered-note" data-raw="{{ note.content | e }}"></div>
                <div class="note-footer">
                    <span class="note-date">
                        <i class="far fa-clock"></i>
                        {{ note.created_at|localtime }}
                        <span style="margin-left: 0.5rem; color: #4caf50; font-size: 0.75rem;" title="Encrypted">
                            <i class="fas fa-lock"></i>
                        </span>
                    </span>
                    <div class="note-actions">
                        <button type="button" class="copy-note-btn" title="Copy note" data-content="{{ note.content }}">
                            <i class="far fa-copy"></i>
                        </button>
                        <button type="button" class="btn-icon share-note-btn" title="Share note"
                            data-id="{{ note._id }}">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <form action="{{ url_for('delete_personal_post', post_id=note._id) }}" method="POST"
                            style="display:inline;" class="delete-note-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="delete-btn" title="Delete note">
                                <i class="far fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="far fa-sticky-note"></i>
            <h3>No notes yet</h3>
            <p>Write private notes that only you can see.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Share Note Modal -->
<div id="share-modal" class="custom-modal-overlay">
    <div class="custom-modal" style="max-width: 500px; text-align: left;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0; color: #3e2217; font-size: 1.25rem;">
                <i class="fas fa-share-alt"></i> Share Note
            </h2>
            <button class="btn-icon" onclick="closeShareModal()"><i class="fas fa-times"></i></button>
        </div>

        <div id="share-config">
            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.9rem;">Permissions</label>
                <select id="share-permissions"
                    style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #ddd; background: #fff;">
                    <option value="view">View Only</option>
                    <option value="edit">Can Edit</option>
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.9rem;">Expiration</label>
                <select id="share-expiry"
                    style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #ddd; background: #fff;">
                    <option value="never">Never</option>
                    <option value="1h">1 Hour</option>
                    <option value="1d">1 Day</option>
                    <option value="7d">7 Days</option>
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.9rem;">Access Code
                    (Optional)</label>
                <input type="text" id="share-code" placeholder="Leave blank for no code"
                    style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #ddd;">
            </div>

            <button id="generate-share-link" class="btn comment-btn"
                style="width: 100%; padding: 0.75rem; font-weight: 600; border-radius: 8px;">
                Generate Share Link
            </button>
        </div>

        <div id="active-shares-container" style="margin-top: 1.5rem; display: none;">
            <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 1rem;">Active
                Links</label>
            <div id="share-links-list"></div>
        </div>
    </div>
</div>

<!-- KaTeX for math rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- Marked.js for markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<!-- DOMPurify for sanitization -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Function to auto-detect and convert common math patterns to LaTeX
        function autoDetectMath(text) {
            if (!text) return text;



            // Protect code blocks
            const codeBlocks = [];
            text = text.replace(/```[\s\S]*?```/g, (m) => { codeBlocks.push(m); return `%%CODE${codeBlocks.length - 1}%%`; });
            text = text.replace(/`[^`]+`/g, (m) => { codeBlocks.push(m); return `%%CODE${codeBlocks.length - 1}%%`; });

            // Protect EXISTING $...$
            const existingMath = [];
            text = text.replace(/\$\$[\s\S]*?\$\$/g, (m) => { existingMath.push(m); return `%%EXISTING${existingMath.length - 1}%%`; });
            text = text.replace(/\$[^\$]+?\$/g, (m) => { existingMath.push(m); return `%%EXISTING${existingMath.length - 1}%%`; });

            const wrap = (content) => `$${content}$`;

            function extractBracedContent(str, startIndex) {
                // Skip optional whitespace before the brace
                let i = startIndex;
                while (i < str.length && /\s/.test(str[i])) i++;

                if (str[i] !== '{') return null;
                let depth = 1;
                for (let k = i + 1; k < str.length; k++) {
                    if (str[k] === '{') depth++;
                    else if (str[k] === '}') {
                        depth--;
                        if (depth === 0) return { content: str.substring(i + 1, k), endIndex: k };
                    }
                }
                return null;
            }

            // Commands sorted by length (longest first) to ensure greedy matching
            // Comprehensive list for math, physics, chemistry, and advanced notation
            const mathCmds = [
                // === ARROWS & LOGIC ===
                'longleftrightarrow', 'Longleftrightarrow', 'hookrightarrow', 'hookleftarrow',
                'leftrightarrow', 'Leftrightarrow', 'longrightarrow', 'Longrightarrow',
                'longleftarrow', 'Longleftarrow', 'rightarrow', 'Rightarrow', 'leftarrow', 'Leftarrow',
                'uparrow', 'Uparrow', 'downarrow', 'Downarrow', 'updownarrow', 'Updownarrow',
                'nearrow', 'searrow', 'swarrow', 'nwarrow', 'mapsto', 'longmapsto',
                'rightharpoonup', 'rightharpoondown', 'leftharpoonup', 'leftharpoondown',
                'rightleftharpoons', 'leftrightharpoons', 'curvearrowright', 'curvearrowleft',
                'circlearrowright', 'circlearrowleft', 'looparrowright', 'looparrowleft',
                'twoheadrightarrow', 'twoheadleftarrow', 'leadsto',
                'iff', 'implies', 'impliedby', 'neg', 'lnot', 'wedge', 'land', 'vee', 'lor',
                'oplus', 'otimes', 'odot', 'ominus', 'oslash',
                'forall', 'exists', 'nexists', 'therefore', 'because', 'top', 'bot', 'vdash', 'dashv', 'models',

                // === SET THEORY ===
                'emptyset', 'varnothing', 'subset', 'subseteq', 'subsetneq', 'supset', 'supseteq', 'supsetneq',
                'sqsubset', 'sqsubseteq', 'sqsupset', 'sqsupseteq',
                'cup', 'cap', 'bigcup', 'bigcap', 'setminus', 'smallsetminus',
                'in', 'notin', 'ni', 'owns',

                // === RELATIONS & COMPARISONS ===
                'neq', 'ne', 'leq', 'le', 'geq', 'ge', 'leqslant', 'geqslant',
                'll', 'gg', 'lll', 'ggg', 'lesssim', 'gtrsim', 'lessgtr', 'gtrless',
                'prec', 'succ', 'preceq', 'succeq', 'precneq', 'succneq',
                'approx', 'approxeq', 'thickapprox', 'equiv', 'cong', 'ncong', 'sim', 'simeq', 'nsim',
                'propto', 'varpropto', 'parallel', 'nparallel', 'perp', 'asymp',
                'doteq', 'triangleq', 'circeq', 'bumpeq', 'Bumpeq',
                'coloneq', 'eqcolon', 'coloncolon',

                // === GREEK LETTERS (lowercase) ===
                'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'varepsilon', 'zeta', 'eta', 'theta', 'vartheta',
                'iota', 'kappa', 'varkappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'varpi',
                'rho', 'varrho', 'sigma', 'varsigma', 'tau', 'upsilon', 'phi', 'varphi', 'chi', 'psi', 'omega',
                // === GREEK LETTERS (uppercase) ===
                'Gamma', 'Delta', 'Theta', 'Lambda', 'Xi', 'Pi', 'Sigma', 'Upsilon', 'Phi', 'Psi', 'Omega',

                // === CALCULUS & ANALYSIS ===
                'partial', 'nabla', 'grad', 'diverge', 'curl',
                'int', 'iint', 'iiint', 'iiiint', 'oint', 'oiint', 'oiiint', 'intop', 'smallint',
                'sum', 'prod', 'coprod', 'bigoplus', 'bigotimes', 'bigodot', 'biguplus', 'bigsqcup',
                'lim', 'limsup', 'liminf', 'varlimsup', 'varliminf', 'injlim', 'projlim', 'varinjlim', 'varprojlim',
                'to', 'gets', 'infty',

                // === FUNCTIONS ===
                'sin', 'cos', 'tan', 'cot', 'sec', 'csc',
                'arcsin', 'arccos', 'arctan', 'arccot', 'arcsec', 'arccsc',
                'sinh', 'cosh', 'tanh', 'coth', 'sech', 'csch',
                'arcsinh', 'arccosh', 'arctanh', 'arccoth',
                'log', 'ln', 'lg', 'exp', 'Re', 'Im',
                'det', 'dim', 'ker', 'coker', 'image', 'rank', 'nullity',
                'deg', 'gcd', 'lcm', 'hom', 'Hom', 'End', 'Aut', 'Ker', 'Im',
                'min', 'max', 'sup', 'inf', 'arg', 'sgn', 'sign',
                'mod', 'bmod', 'pmod',
                'Pr', 'tr', 'Tr', 'diag', 'erf', 'erfc', 'sinc',

                // === FRACTIONS & ROOTS ===
                'frac', 'dfrac', 'tfrac', 'cfrac', 'sfrac', 'nicefrac',
                'sqrt', 'cbrt', 'root',
                'binom', 'dbinom', 'tbinom', 'choose',

                // === ACCENTS & DECORATIONS ===
                'hat', 'widehat', 'check', 'widecheck', 'tilde', 'widetilde',
                'acute', 'grave', 'breve', 'bar', 'overline', 'underline',
                'vec', 'overrightarrow', 'overleftarrow', 'overleftrightarrow',
                'underrightarrow', 'underleftarrow', 'underleftrightarrow',
                'dot', 'ddot', 'dddot', 'ddddot', 'mathring',
                'overbrace', 'underbrace', 'overgroup', 'undergroup',
                'overlinesegment', 'underlinesegment',
                'boxed', 'cancel', 'bcancel', 'xcancel', 'cancelto', 'sout', 'not',

                // === PHYSICS & VECTORS ===
                'hbar', 'planck', 'hslash',
                'ell', 'wp', 'aleph', 'beth', 'gimel', 'daleth',
                'Angstrom', 'AA',
                'degree', 'celsius', 'ohm', 'micro', 'angstrom',
                'vec', 'bm', 'boldsymbol', 'pmb',
                'tensor', 'ketbra', 'braket', 'Bra', 'Ket', 'bra', 'ket', 'dyad',
                'mel', 'matrixel', 'ev', 'expectationvalue',
                'commutator', 'anticommutator', 'poissonbracket',
                'dd', 'dv', 'pdv', 'var', 'fdv', 'abs', 'norm', 'eval', 'order',
                'gradient', 'divergence', 'laplacian',
                'cross', 'vdot', 'vectorbold', 'vectorarrow', 'vectorunit',
                'qty', 'quantity', 'pqty', 'bqty', 'vqty', 'Bqty', 'absolutevalue',

                // === MATRICES & LINEAR ALGEBRA ===
                'begin', 'end', 'matrix', 'pmatrix', 'bmatrix', 'Bmatrix', 'vmatrix', 'Vmatrix',
                'smallmatrix', 'array', 'cases', 'rcases', 'dcases',
                'aligned', 'gathered', 'split', 'multline', 'equation', 'align',

                // === SPACING ===
                'quad', 'qquad', 'thinspace', 'medspace', 'thickspace', 'negthinspace', 'negmedspace', 'negthickspace',
                'enspace', 'space', 'nobreakspace',

                // === DOTS & MISC SYMBOLS ===
                'cdot', 'cdots', 'ldots', 'dots', 'vdots', 'ddots', 'iddots', 'dotsb', 'dotsc', 'dotsi', 'dotsm', 'dotso',
                'times', 'div', 'pm', 'mp', 'ast', 'star', 'circ', 'bullet', 'diamond', 'lozenge',
                'dagger', 'ddagger', 'amalg',
                'triangle', 'triangledown', 'triangleleft', 'triangleright',
                'bigtriangleup', 'bigtriangledown', 'vartriangle', 'blacktriangle', 'blacktriangledown',
                'square', 'blacksquare', 'Box', 'Diamond',
                'checkmark', 'maltese', 'clubsuit', 'diamondsuit', 'heartsuit', 'spadesuit',
                'sharp', 'flat', 'natural',
                'surd', 'angle', 'measuredangle', 'sphericalangle',
                'prime', 'backprime', 'dprime', 'trprime', 'qprime',

                // === DELIMITERS ===
                'left', 'right', 'bigl', 'bigr', 'Bigl', 'Bigr', 'biggl', 'biggr', 'Biggl', 'Biggr',
                'langle', 'rangle', 'lang', 'rang',
                'lfloor', 'rfloor', 'lceil', 'rceil',
                'lvert', 'rvert', 'lVert', 'rVert',
                'lbrace', 'rbrace', 'lbrack', 'rbrack',
                'ulcorner', 'urcorner', 'llcorner', 'lrcorner',
                'llbracket', 'rrbracket', 'lmoustache', 'rmoustache',

                // === TEXT & FORMATTING ===
                'text', 'textbf', 'textit', 'textrm', 'textsf', 'texttt', 'textup', 'textsl', 'textsc',
                'mathbf', 'mathit', 'mathrm', 'mathsf', 'mathtt', 'mathcal', 'mathbb', 'mathfrak', 'mathscr',
                'bm', 'bold', 'boldsymbol', 'pmb',
                'rm', 'bf', 'it', 'sf', 'tt', 'cal', 'scr', 'frak', 'Bbb',
                'operatorname', 'DeclareMathOperator',
                'displaystyle', 'textstyle', 'scriptstyle', 'scriptscriptstyle',
                'tiny', 'small', 'normalsize', 'large', 'Large', 'LARGE', 'huge', 'Huge',
                'color', 'textcolor', 'colorbox', 'fcolorbox',
                'hspace', 'vspace', 'kern', 'mkern', 'mskip', 'hskip', 'rule', 'Rule', 'phantom', 'vphantom', 'hphantom',

                // === CHEMISTRY (basic) ===
                'ce', 'pu', 'bond', 'arrow',

                // === NUMBER SETS ===
                'N', 'Z', 'Q', 'R', 'C', 'H', 'O', 'F', 'P'
            ];
            const cmdRegex = new RegExp('\\\\{1,4}(' + mathCmds.join('|') + ')(?![a-zA-Z])', 'g');

            let result = '';
            let lastIdx = 0;
            let match;

            // Commands that take two braced arguments like \frac{a}{b}
            const twoArgCmds = ['frac', 'dfrac', 'tfrac', 'cfrac', 'binom', 'dbinom', 'tbinom', 'overset', 'underset', 'stackrel'];
            // Commands that take one braced argument (or optional + braced)
            const oneArgCmds = ['sqrt', 'cbrt', 'hat', 'bar', 'vec', 'dot', 'ddot', 'tilde', 'widehat', 'widetilde',
                'overline', 'underline', 'overbrace', 'underbrace', 'boxed', 'cancel', 'bcancel', 'xcancel',
                'text', 'textbf', 'textit', 'textrm', 'mathbf', 'mathit', 'mathrm', 'mathcal', 'mathbb', 'mathfrak', 'mathscr',
                'bm', 'boldsymbol', 'operatorname', 'color', 'textcolor', 'phantom', 'abs', 'norm'];

            while ((match = cmdRegex.exec(text)) !== null) {
                result += text.substring(lastIdx, match.index);
                const cmd = match[1];
                let matchedWhole = false;

                if (twoArgCmds.includes(cmd)) {
                    // Handle two-argument commands like \frac{a}{b}
                    let j = match.index + match[0].length;
                    const first = extractBracedContent(text, j);
                    if (first) {
                        const second = extractBracedContent(text, first.endIndex + 1);
                        if (second) {
                            result += wrap(text.substring(match.index, second.endIndex + 1));
                            lastIdx = second.endIndex + 1;
                            cmdRegex.lastIndex = lastIdx;
                            matchedWhole = true;
                        }
                    }
                } else if (cmd === 'sqrt' || cmd === 'cbrt' || cmd === 'root') {
                    // Handle sqrt with optional nth root: \sqrt[n]{x}
                    let j = match.index + match[0].length;
                    while (j < text.length && /\s/.test(text[j])) j++;
                    if (text[j] === '[') {
                        const endBrkt = text.indexOf(']', j);
                        if (endBrkt !== -1) j = endBrkt + 1;
                    }
                    const content = extractBracedContent(text, j);
                    if (content) {
                        result += wrap(text.substring(match.index, content.endIndex + 1));
                        lastIdx = content.endIndex + 1;
                        cmdRegex.lastIndex = lastIdx;
                        matchedWhole = true;
                    }
                } else if (cmd === 'left') {
                    // Handle \left...\right pairs
                    const remaining = text.substring(match.index);
                    const leftRightMatch = remaining.match(/^\\{1,4}left[\s]*[\(\[\{\|\\][\s\S]*?\\{1,4}right[\s]*[\)\]\}\|\\]/);
                    if (leftRightMatch) {
                        result += wrap(leftRightMatch[0]);
                        lastIdx = match.index + leftRightMatch[0].length;
                        cmdRegex.lastIndex = lastIdx;
                        matchedWhole = true;
                    }
                } else if (cmd === 'begin') {
                    // Handle \begin{env}...\end{env} blocks
                    const remaining = text.substring(match.index);
                    const envMatch = remaining.match(/^\\begin\{([^}]+)\}([\s\S]*?)\\end\{\1\}/);
                    if (envMatch) {
                        result += wrap(envMatch[0]);
                        lastIdx = match.index + envMatch[0].length;
                        cmdRegex.lastIndex = lastIdx;
                        matchedWhole = true;
                    }
                } else {
                    let currentIdx = match.index + match[0].length;
                    const bracedArg = extractBracedContent(text, currentIdx);
                    if (bracedArg) currentIdx = bracedArg.endIndex + 1;

                    while (currentIdx < text.length) {
                        let i = currentIdx;
                        while (i < text.length && /\s/.test(text[i])) i++;
                        if (text[i] === '_' || text[i] === '^') {
                            i++;
                            const braced = extractBracedContent(text, i);
                            if (braced) currentIdx = braced.endIndex + 1;
                            else if (/[a-zA-Z0-9]/.test(text[i])) currentIdx = i + 1;
                            else break;
                        } else break;
                    }
                    result += wrap(text.substring(match.index, currentIdx));
                    lastIdx = currentIdx;
                    cmdRegex.lastIndex = lastIdx;
                    matchedWhole = true;
                }

                if (!matchedWhole) {
                    result += text.substring(match.index, match.index + match[0].length);
                    lastIdx = match.index + match[0].length;
                }
            }
            result += text.substring(lastIdx);
            text = result;

            // Simple scripts with balanced parentheses
            const tempM = [];
            text = text.replace(/\$[^$]+\$/g, (m) => { tempM.push(m); return `%%TM${tempM.length - 1}%%`; });
            text = text.replace(/(\(([^\(\)]+|(?:\([^\(\)]*\)))\)|[A-Za-z0-9])([\^_])(\{([^}]+)\}|[A-Za-z0-9])/g, (m) => wrap(m));
            text = text.replace(/%%TM(\d+)%%/g, (m, i) => tempM[parseInt(i)]);

            // Numeric fractions like 1/2
            text = text.replace(/(^|[^\/\\\d])(\d+)\/(\d+)(?![\/\d])/g, (m, p, n, d) => p + wrap(`\\frac{${n}}{${d}}`));

            // Symbols
            text = text.replace(/±/g, wrap('\\pm'));
            text = text.replace(/ℏ/g, wrap('\\hbar'));
            text = text.replace(/Å/g, wrap('\\text{Å}'));
            text = text.replace(/(\d+)°/g, (m, num) => wrap(`${num}^{\\circ}`));
            text = text.replace(/≠/g, wrap('\\neq'));
            text = text.replace(/≤/g, wrap('\\leq'));
            text = text.replace(/≥/g, wrap('\\geq'));
            text = text.replace(/≈/g, wrap('\\approx'));

            // Dirac Notation
            text = text.replace(/\|([A-Za-z0-9αβγδεζηθικλμνξπρστυφχψω\s\+\-\*\/\^\_\{\}\\]+)⟩/g, (m, inner) => wrap(`|${inner}\\rangle`));
            text = text.replace(/⟨([A-Za-z0-9αβγδεζηθικλμνξπρστυφχψω\s\+\-\*\/\^\_\{\}\\]+)\|/g, (m, inner) => wrap(`\\langle ${inner}|`));

            // Set/logic symbols
            text = text.replace(/∈/g, wrap('\\in'));
            text = text.replace(/∉/g, wrap('\\notin'));
            text = text.replace(/⊂/g, wrap('\\subset'));
            text = text.replace(/⊆/g, wrap('\\subseteq'));
            text = text.replace(/⊃/g, wrap('\\supset'));
            text = text.replace(/⊇/g, wrap('\\supseteq'));
            text = text.replace(/∪/g, wrap('\\cup'));
            text = text.replace(/∩/g, wrap('\\cap'));
            text = text.replace(/∅/g, wrap('\\emptyset'));
            text = text.replace(/∀/g, wrap('\\forall'));
            text = text.replace(/∃/g, wrap('\\exists'));

            // Arrows
            text = text.replace(/→/g, wrap('\\rightarrow'));
            text = text.replace(/←/g, wrap('\\leftarrow'));
            text = text.replace(/↔/g, wrap('\\leftrightarrow'));
            text = text.replace(/⇒/g, wrap('\\Rightarrow'));
            text = text.replace(/⇐/g, wrap('\\Leftarrow'));
            text = text.replace(/⇔/g, wrap('\\Leftrightarrow'));
            text = text.replace(/↑/g, wrap('\\uparrow'));
            text = text.replace(/↓/g, wrap('\\downarrow'));

            // Calculus symbols
            text = text.replace(/∂/g, wrap('\\partial'));
            text = text.replace(/∇/g, wrap('\\nabla'));
            text = text.replace(/∫/g, wrap('\\int'));
            text = text.replace(/∬/g, wrap('\\iint'));
            text = text.replace(/∭/g, wrap('\\iiint'));
            text = text.replace(/∮/g, wrap('\\oint'));
            text = text.replace(/∑/g, wrap('\\sum'));
            text = text.replace(/∏/g, wrap('\\prod'));
            text = text.replace(/∞/g, wrap('\\infty'));

            // Greek letters (Unicode to LaTeX)
            text = text.replace(/α/g, wrap('\\alpha'));
            text = text.replace(/β/g, wrap('\\beta'));
            text = text.replace(/γ/g, wrap('\\gamma'));
            text = text.replace(/δ/g, wrap('\\delta'));
            text = text.replace(/ε/g, wrap('\\epsilon'));
            text = text.replace(/ζ/g, wrap('\\zeta'));
            text = text.replace(/η/g, wrap('\\eta'));
            text = text.replace(/θ/g, wrap('\\theta'));
            text = text.replace(/ι/g, wrap('\\iota'));
            text = text.replace(/κ/g, wrap('\\kappa'));
            text = text.replace(/λ/g, wrap('\\lambda'));
            text = text.replace(/μ/g, wrap('\\mu'));
            text = text.replace(/ν/g, wrap('\\nu'));
            text = text.replace(/ξ/g, wrap('\\xi'));
            text = text.replace(/π/g, wrap('\\pi'));
            text = text.replace(/ρ/g, wrap('\\rho'));
            text = text.replace(/σ/g, wrap('\\sigma'));
            text = text.replace(/τ/g, wrap('\\tau'));
            text = text.replace(/υ/g, wrap('\\upsilon'));
            text = text.replace(/φ/g, wrap('\\phi'));
            text = text.replace(/χ/g, wrap('\\chi'));
            text = text.replace(/ψ/g, wrap('\\psi'));
            text = text.replace(/ω/g, wrap('\\omega'));
            text = text.replace(/Γ/g, wrap('\\Gamma'));
            text = text.replace(/Δ/g, wrap('\\Delta'));
            text = text.replace(/Θ/g, wrap('\\Theta'));
            text = text.replace(/Λ/g, wrap('\\Lambda'));
            text = text.replace(/Ξ/g, wrap('\\Xi'));
            text = text.replace(/Π/g, wrap('\\Pi'));
            text = text.replace(/Σ/g, wrap('\\Sigma'));
            text = text.replace(/Φ/g, wrap('\\Phi'));
            text = text.replace(/Ψ/g, wrap('\\Psi'));
            text = text.replace(/Ω/g, wrap('\\Omega'));

            // Multiplication: ×
            text = text.replace(/×/g, wrap('\\times'));

            // Division: ÷
            text = text.replace(/÷/g, wrap('\\div'));;

            // Restore
            text = text.replace(/%%EXISTING(\d+)%%/g, (m, i) => existingMath[parseInt(i)]);
            text = text.replace(/%%CODE(\d+)%%/g, (m, i) => codeBlocks[parseInt(i)]);


            return text;
        }


        // Function to render markdown with math support
        function renderMarkdownWithMath(text) {
            if (!text) return '';

            // 1. First, run auto-detection to convert patterns to $...$ 
            let processedText = autoDetectMath(text);

            // 2. Now protect code blocks and extract ALL math patterns for KaTeX rendering
            const placeholders = [];

            // Protect code blocks (triple backticks)
            processedText = processedText.replace(/```[\s\S]*?```/g, (match) => {
                placeholders.push({ type: 'code', content: match });
                return `%%PLACEHOLDER${placeholders.length - 1}%%`;
            });

            // Protect inline code (single backticks)
            processedText = processedText.replace(/`[^`]+`/g, (match) => {
                placeholders.push({ type: 'code', content: match });
                return `%%PLACEHOLDER${placeholders.length - 1}%%`;
            });

            // Extract and render block math ($$...$$)
            processedText = processedText.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                try {
                    if (typeof katex !== 'undefined') {
                        const rendered = katex.renderToString(math, { displayMode: true, throwOnError: false });
                        placeholders.push({ type: 'rendered', content: rendered });
                        return `%%PLACEHOLDER${placeholders.length - 1}%%`;
                    }
                } catch (e) { }
                return match; // Fallback: keep original
            });

            // Extract and render inline math ($...$)
            // Using a more inclusive regex that allows internal newlines
            processedText = processedText.replace(/\$([\s\S]+?)\$/g, (match, math) => {
                try {
                    if (typeof katex !== 'undefined') {
                        const rendered = katex.renderToString(math, { displayMode: false, throwOnError: false });
                        placeholders.push({ type: 'rendered', content: rendered });
                        return `%%PLACEHOLDER${placeholders.length - 1}%%`;
                    }
                } catch (e) { }
                return match;
            });

            // 3. Configure marked and parse markdown
            if (typeof marked !== 'undefined') {
                marked.setOptions({ breaks: true, gfm: true });
                processedText = marked.parse(processedText);
            }

            // 4. Sanitize Markdown HTML BEFORE restoring KaTeX
            if (typeof DOMPurify !== 'undefined') {
                processedText = DOMPurify.sanitize(processedText);
            }

            // 5. Restore ALL placeholders (including rendered KaTeX)
            processedText = processedText.replace(/%%PLACEHOLDER(\d+)%%/g, (match, index) => {
                const item = placeholders[parseInt(index)];
                return item ? item.content : match;
            });

            return processedText;
        }

        // Render all saved notes on page load
        function renderAllNotes() {
            document.querySelectorAll('.rendered-note').forEach(el => {
                const rawContent = el.dataset.raw || '';
                const textarea = document.createElement('textarea');
                textarea.innerHTML = rawContent;
                const decoded = textarea.value;
                el.innerHTML = renderMarkdownWithMath(decoded);
            });
        }

        // Wait for KaTeX to load, then render
        function waitForLibraries(callback, maxWait = 5000) {
            const start = Date.now();
            const check = () => {
                if (typeof katex !== 'undefined' && typeof marked !== 'undefined') {
                    callback();
                } else if (Date.now() - start < maxWait) {
                    setTimeout(check, 100);
                } else {
                    console.warn('Libraries not loaded, rendering plain text');
                    document.querySelectorAll('.rendered-note').forEach(el => {
                        const rawContent = el.dataset.raw || '';
                        const textarea = document.createElement('textarea');
                        textarea.innerHTML = rawContent;
                        el.textContent = textarea.value;
                    });
                }
            };
            check();
        }

        waitForLibraries(renderAllNotes);

        // Tab switching
        const tabButtons = document.querySelectorAll('.tab-nav button');
        const tabPanels = document.querySelectorAll('.tab-panel');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                tabButtons.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-selected', 'false');
                });
                tabPanels.forEach(p => p.classList.remove('active'));
                button.classList.add('active');
                button.setAttribute('aria-selected', 'true');
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        // Character counter for notes
        const noteInput = document.getElementById('note-input');
        const charCount = document.getElementById('char-count');
        const charCountContainer = charCount?.parentElement;

        if (noteInput && charCount) {
            noteInput.addEventListener('input', () => {
                const len = noteInput.value.length;
                charCount.textContent = len;
                charCountContainer.classList.remove('warning', 'danger');
                if (len > 1800) {
                    charCountContainer.classList.add('danger');
                } else if (len > 1500) {
                    charCountContainer.classList.add('warning');
                }
            });
        }

        // Live preview toggle
        const previewToggle = document.getElementById('preview-toggle');
        const previewContainer = document.getElementById('note-preview');
        const previewContent = document.getElementById('preview-content');

        if (previewToggle && previewContainer && noteInput) {
            previewToggle.addEventListener('change', () => {
                previewContainer.classList.toggle('active', previewToggle.checked);
                if (previewToggle.checked) updatePreview();
            });

            let previewTimeout;
            noteInput.addEventListener('input', () => {
                if (previewToggle.checked) {
                    clearTimeout(previewTimeout);
                    previewTimeout = setTimeout(updatePreview, 300);
                }
            });

            function updatePreview() {
                const text = noteInput.value;
                if (text.trim()) {
                    previewContent.innerHTML = renderMarkdownWithMath(text);
                } else {
                    previewContent.innerHTML = '<span style="color: #999; font-style: italic;">Preview will appear here...</span>';
                }
            }
        }

        // Search saved posts
        const searchInput = document.getElementById('saved-search');
        const savedPosts = document.querySelectorAll('.saved-post-card');

        if (searchInput) {
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase().trim();
                savedPosts.forEach(card => {
                    const title = card.dataset.title || '';
                    const author = card.dataset.author || '';
                    if (title.includes(query) || author.includes(query)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        // Copy note content (copies raw markdown, not rendered)
        document.querySelectorAll('.copy-note-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const content = btn.dataset.content;
                navigator.clipboard.writeText(content).then(() => {
                    const icon = btn.querySelector('i');
                    icon.className = 'fas fa-check';
                    setTimeout(() => { icon.className = 'far fa-copy'; }, 1500);
                });
            });
        });

        // Confirm delete for notes
        document.querySelectorAll('.delete-note-form').forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (typeof window.showCustomConfirm === 'function') {
                    window.showCustomConfirm('Delete this note?', confirmed => {
                        if (confirmed) form.submit();
                    });
                } else if (confirm('Delete this note?')) {
                    form.submit();
                }
            });
        });

        // Confirm unsave for posts
        document.querySelectorAll('.unsave-form').forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (typeof window.showCustomConfirm === 'function') {
                    window.showCustomConfirm('Remove this post from your saved list?', confirmed => {
                        if (confirmed) form.submit();
                    });
                } else if (confirm('Remove this post from your saved list?')) {
                    form.submit();
                }
            });
        });

        // Prevent double submission
        const noteForm = document.getElementById('create-note-form');
        const addNoteBtn = document.getElementById('add-note-btn');

        if (noteForm && addNoteBtn) {
            noteForm.addEventListener('submit', () => {
                addNoteBtn.disabled = true;
                addNoteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            });
        }

        // --- Note Sharing Logic ---
        let currentShareNoteId = null;

        document.querySelectorAll('.share-note-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentShareNoteId = btn.dataset.id;
                openShareModal();
                loadExistingShares(currentShareNoteId);
            });
        });

        function openShareModal() {
            const modal = document.getElementById('share-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                // Reset fields
                document.getElementById('share-permissions').value = 'view';
                document.getElementById('share-expiry').value = 'never';
                document.getElementById('share-code').value = '';

                document.addEventListener('keydown', handleShareModalEsc);
            }
        }

        window.closeShareModal = function () {
            const modal = document.getElementById('share-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                document.removeEventListener('keydown', handleShareModalEsc);
            }
        };

        function handleShareModalEsc(e) {
            if (e.key === 'Escape') closeShareModal();
        }

        async function loadExistingShares(noteId) {
            const list = document.getElementById('share-links-list');
            const container = document.getElementById('active-shares-container');
            if (!list || !container) return;

            try {
                const response = await fetch(`/personal_post/shares/${noteId}`);
                const shares = await response.json();

                if (shares.length > 0) {
                    container.style.display = 'block';
                    list.innerHTML = shares.map(s => `
                        <div class="share-link-item">
                            <div class="share-link-url">
                                <input type="text" value="${s.url}" readonly onclick="this.select()">
                                <button class="btn-icon" onclick="copyShareUrl('${s.url}', this)" title="Copy Link">
                                    <i class="far fa-copy"></i>
                                </button>
                            </div>
                            <div class="share-link-meta">
                                <span>
                                    <i class="fas fa-${s.permissions === 'edit' ? 'pen' : 'eye'}"></i> ${s.permissions.charAt(0).toUpperCase() + s.permissions.slice(1)}
                                    ${s.expires_at ? ' | Exp: ' + new Date(s.expires_at).toLocaleDateString() : ''}
                                </span>
                                <button class="revoke-link-btn" style="color: #d9534f; background:none; border:none; padding:5px; font-size:0.8rem; cursor:pointer;" onclick="revokeShare('${s.share_id}', this)" title="Revoke">
                                    <i class="fas fa-trash-alt"></i> Revoke
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.style.display = 'none';
                    list.innerHTML = '';
                }
            } catch (e) {
                console.error('Error loading shares:', e);
            }
        }

        const generateBtn = document.getElementById('generate-share-link');
        if (generateBtn) {
            generateBtn.addEventListener('click', async () => {
                const permissions = document.getElementById('share-permissions').value;
                const expires_in = document.getElementById('share-expiry').value;
                const access_code = document.getElementById('share-code').value;

                generateBtn.disabled = true;
                const originalText = generateBtn.textContent;
                generateBtn.textContent = 'Generating...';

                try {
                    const response = await fetch(`/personal_post/share/${currentShareNoteId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                        },
                        body: JSON.stringify({
                            permissions,
                            expires_in,
                            access_code
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        loadExistingShares(currentShareNoteId);
                        document.getElementById('share-code').value = '';
                    } else {
                        alert('Error: ' + (result.error || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Network error. Try again.');
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = originalText;
                }
            });
        }

        window.revokeShare = async function (shareId, btn) {
            if (!confirm('Revoke this link? It will immediately stop working.')) return;

            try {
                const response = await fetch(`/personal_post/revoke_share/${shareId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    }
                });

                if (response.ok) {
                    loadExistingShares(currentShareNoteId);
                }
            } catch (e) {
                console.error('Error revoking share:', e);
            }
        };

        window.copyShareUrl = function (text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const icon = btn.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'fas fa-check';
                setTimeout(() => { icon.className = originalClass; }, 1500);
            });
        };
    });
</script>
{% endblock %}