{% extends "base.html" %}

{% block title %}
    <title>{{ title }}</title>
    <meta name="description" content="{{ description }}">
{% endblock %}

{% block content %}
<div class="blog-container">
    <div class="blog-header">
        <h1>EchoWithin Blog</h1>
        <h4>Share your real ideas, experiences, and perspectives.</h4>
        
        <!-- Search Form -->
        <form action="{{ url_for('blog') }}" method="GET" class="search-form" style="margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem;">
            <input type="text" name="query" class="form-input" placeholder="Search posts..." value="{{ query or '' }}" style="width: 70%;">
            <button type="submit" class="form-button" style="width: auto; padding: 0 1rem;">Search</button>
        </form>

        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="admin-actions">
            <a href="{{ url_for('admin_posts') }}" class="btn edit-btn">Manage Posts</a>
            <a href="{{ url_for('admin_announcements') }}" class="btn edit-btn">Manage Announcements</a>
        </div>
        {% endif %}
    </div>

    {% if current_user.is_authenticated %}
    <div class="create-post-section">
        <h3>Create a New Post</h3>
        <form action="{{ url_for('post') }}" method="POST" class="post-form" enctype="multipart/form-data">
            <input type="text" name="title" class="form-input" placeholder="Post Title" required>
            <textarea name="content" class="form-input" placeholder="What's on your mind?" rows="5" required></textarea>
            <div>
                <label for="image">Upload an Image (Optional):</label>
                <input type="file" name="image" class="form-input" accept="image/*">
            </div>
            <button type="submit" class="form-button">Post</button>
        </form>
    </div>
    {% endif %}

    <div class="posts-section">
        <h2>{% if query %}Search Results for "{{ query }}"{% else %}Latest Posts{% endif %}</h2>
        {% if posts %}
            {% for post in posts %}
            <div class="post-item">
                <h3><a href="{{ url_for('view_post', slug=post.slug) }}">{{post.title}}</a></h3>

                <!-- Image Display Logic -->
                {% if post.image_url or post.image_filename %}
                    <div class="post-image-container {% if post.image_status == 'processing' %}processing{% endif %}">
                        {% if post.image_url %}
                            {# Display image from Cloudinary #}
                            {% if post.image_status == 'safe' or post.image_status == 'processing' %}
                                <img src="{{ post.image_url }}" alt="Post image for {{ post.title }}" class="post-image">
                            {% elif post.image_status == 'removed_nsfw' %}
                                <div class="nsfw-placeholder">Image removed due to sensitive content.</div>
                            {% endif %}
                        {% elif post.image_filename %}
                            {# Fallback for old posts: Display image from local uploads #}
                            <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" alt="Post image for {{ post.title }}" class="post-image">
                        {% endif %}
                    </div>
                {% endif %}

                <div class="post-content-wrapper">
                    {% if post.content|length > 150 %}
                        <p class="post-content-truncated">{{ post.content|truncate(150, true) }}</p>
                        <p class="post-content-full">{{ post.content }}</p>
                        <a href="#" class="read-more-link read-more-toggle">Read More</a>
                    {% else %}
                        <p>{{ post.content }}</p>
                    {% endif %}
                </div>

                <div class="post-meta">
                    Posted by <strong>{{ post.author }}</strong> on {{ post.timestamp.strftime('%B %d, %Y') }}
                </div>
                <div class="post-actions">
                    {% set comment_count = post.comments|length if post.comments else 0 %}
                    <a href="{{ url_for('view_post', slug=post.slug) }}" class="btn comment-btn">
                        Comments
                        <span class="comment-count-badge">{{ comment_count }}</span>
                    </a>

                    {% if current_user.is_authenticated and post.author_id|string == current_user.id %}
                        <a href="{{ url_for('edit_post', post_id=post._id, action='edit') }}" class="btn edit-btn">Edit</a>
                        <form action="{{ url_for('delete_post', post_id=post._id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this post?');" style="display: inline;">
                            <button type="submit" class="btn delete-btn">Delete</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>No posts found. {% if not query and current_user.is_authenticated %}Why not create the first one?{% endif %}</p>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <nav class="pagination-nav">
        <ul class="pagination">
            {% if page > 1 %}
            <li class="page-item"><a class="page-link" href="{{ url_for('blog', page=page-1, query=query) }}">Previous</a></li>
            {% endif %}
            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="{{ url_for('blog', page=p, query=query) }}">{{ p }}</a></li>
            {% endfor %}
            {% if page < total_pages %}
            <li class="page-item"><a class="page-link" href="{{ url_for('blog', page=page+1, query=query) }}">Next</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}