{% extends "base.html" %}

{% block title %}
    <title>{{ title }}</title>
    <meta name="description" content="{{ description }}">
{% endblock %}

{% block content %}
<div class="blog-container">
    <div class="blog-header">
        <h1>EchoWithin Blog</h1>
        <h4>Share your real ideas, experiences, and perspectives.</h4>
        
        <!-- Search Form -->
        <form action="{{ url_for('blog') }}" method="GET" class="search-form" style="margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem;">
            <input type="text" name="query" class="form-input" placeholder="Search posts..." value="{{ query or '' }}" style="width: 70%;">
            <button type="submit" class="form-button" style="width: auto; padding: 0 1rem;">Search</button>
        </form>

        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="admin-actions">
            <a href="{{ url_for('admin_posts') }}" class="btn edit-btn">Manage Posts</a>
            <a href="{{ url_for('admin_announcements') }}" class="btn edit-btn">Manage Announcements</a>
        </div>
        {% endif %}
    </div>

    {% if current_user.is_authenticated %}
    <div class="create-post-section">
        <h3>Create a New Post</h3>
        <form action="{{ url_for('post') }}" method="POST" class="post-form" id="create-post-form" enctype="multipart/form-data">
            <input type="text" name="title" class="form-input" placeholder="Post Title" required>
            <textarea name="content" class="form-input" placeholder="What's on your mind?" rows="5" required></textarea>
            <div>
                <label for="image">Upload an Image (Optional):</label>
                <input type="file" name="image" class="form-input" accept="image/*">
            </div>
            <div>
                <label for="video">Upload a Video (Optional, max 10 MB):</label>
                <input type="file" name="video" class="form-input" accept="video/*">
            </div>
            <button type="submit" class="form-button" id="create-post-submit-btn">Post</button>
            <button type="button" class="form-button delete-btn" id="cancel-upload-btn" style="display: none; margin-left: 10px;">Cancel</button>
            <small id="upload-status" style="display: none; margin-top: 10px;"></small>
            <div id="progress-container" style="display: none; width: 100%; background-color: #ddd; border-radius: 5px; margin-top: 10px;">
                <div id="progress-bar" style="width: 0%; height: 24px; background-color: #4CAF50; text-align: center; line-height: 24px; color: white; border-radius: 5px;">0%</div>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Pinned Announcement Section -->
    {% if pinned_announcement %}
    <p class="pinned-announcement-section alert alert-info" role="alert" style="padding: 0.5rem 1rem; margin-bottom: 1.5rem; font-size: 0.9rem;">
        <strong>Announcement:</strong> {{ pinned_announcement.content }}</p>
    {% endif %}

    <div class="posts-section">
        <h2>{% if query %}Search Results for "{{ query }}"{% else %}Latest Posts{% endif %}</h2>
        {% if posts %}
            {% for post in posts %}
            <div class="post-item">
                <h3><a href="{{ url_for('view_post', slug=post.slug) }}">{{post.title}}</a></h3>

                <!-- Media Display Logic: show video if present, otherwise image -->
                {% if post.video_url or post.video_filename %}
                    <div class="post-media-container">
                        {% if post.video_url %}
                            <video class="post-video" controls preload="metadata" style="width: 100%; height: auto;">
                                <source src="{{ post.video_url }}" type="video/{{ post.video_url.rsplit('.', 1)[1] if post.video_url and '.' in post.video_url else 'mp4' }}">
                                Your browser does not support the video tag.
                            </video>
                        {% elif post.video_filename %}
                            <video class="post-video" controls preload="metadata" style="width: 100%; height: auto;">
                                <source src="{{ url_for('uploaded_file', filename=post.video_filename) }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        {% endif %}
                    </div>
                {% elif post.image_url or post.image_filename %}
                    <div class="post-image-container {% if post.image_status == 'processing' %}processing{% endif %}">
                        {% if post.image_url %}
                            {# Display image from Cloudinary #}
                            {% if post.image_status == 'safe' or post.image_status == 'processing' %}
                                <img src="{{ post.image_url }}" alt="Post image for {{ post.title }}" class="post-image">
                            {% elif post.image_status == 'removed_nsfw' %}
                                <div class="nsfw-placeholder">Image removed due to sensitive content.</div>
                            {% endif %}
                        {% elif post.image_filename %}
                            {# Fallback for old posts: Display image from local uploads #}
                            <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" alt="Post image for {{ post.title }}" class="post-image">
                        {% endif %}
                    </div>
                {% endif %}

                <div class="post-content-wrapper">
                    {% if post.content|length > 150 %}
                        <p class="post-content-truncated">{{ post.content|truncate(150, true)|linkify|safe }}</p>
                        <p class="post-content-full">{{ post.content|linkify|safe }}</p>
                        <a href="#" class="read-more-link read-more-toggle">Read More</a>
                    {% else %}
                        <p>{{ post.content|linkify|safe }}</p>
                    {% endif %}
                </div>

                <div class="post-meta">
                    Posted by <strong>{{ post.author }}</strong> on {{ post.timestamp.strftime('%B %d, %Y') }}
                </div>
                <div class="post-actions">
                    {% set comment_count = post.comments|length if post.comments else 0 %}
                    <a href="{{ url_for('view_post', slug=post.slug) }}" class="btn comment-btn">
                        Comments
                        <span class="comment-count-badge">{{ comment_count }}</span>
                    </a>

                    {% if current_user.is_authenticated and post.author_id|string == current_user.id %}
                        <a href="{{ url_for('edit_post', post_id=post._id, action='edit') }}" class="btn edit-btn">Edit</a>
                        <form action="{{ url_for('delete_post', post_id=post._id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this post?');" style="display: inline;">
                            <button type="submit" class="btn delete-btn">Delete</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>No posts found. {% if not query and current_user.is_authenticated %}Why not create the first one?{% endif %}</p>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <nav class="pagination-nav">
        <ul class="pagination">
            {% if page > 1 %}
            <li class="page-item"><a class="page-link" href="{{ url_for('blog', page=page-1, query=query) }}">Previous</a></li>
            {% endif %}
            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="{{ url_for('blog', page=p, query=query) }}">{{ p }}</a></li>
            {% endfor %}
            {% if page < total_pages %}
            <li class="page-item"><a class="page-link" href="{{ url_for('blog', page=page+1, query=query) }}">Next</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const createPostForm = document.getElementById('create-post-form');
    let xhr; // Define xhr in a scope accessible to the cancel handler
    const MAX_VIDEO_SIZE = 10 * 1024 * 1024; // 10 MB client-side check (matches server)

    if (createPostForm) {
        createPostForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Stop the default form submission

            const videoInput = this.querySelector('input[name="video"]');
            const submitButton = document.getElementById('create-post-submit-btn');
            const cancelButton = document.getElementById('cancel-upload-btn');
            const statusElement = document.getElementById('upload-status');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');

            if (videoInput.files.length > 0) {
                const videoFile = videoInput.files[0];

                // Client-side basic checks
                if (videoFile.size > MAX_VIDEO_SIZE) {
                    statusElement.textContent = 'Video exceeds maximum allowed size of 10 MB.';
                    statusElement.style.display = 'block';
                    return;
                }

                // Disable button and show status
                submitButton.disabled = true;
                submitButton.textContent = 'Uploading...';
                statusElement.textContent = 'Uploading video...';
                statusElement.style.display = 'block';
                cancelButton.style.display = 'inline-block';
                progressContainer.style.display = 'block';

                // Create FormData and append all fields, including the video file
                const formData = new FormData();
                formData.append('title', this.querySelector('input[name="title"]').value);
                formData.append('content', this.querySelector('textarea[name="content"]').value);
                if (this.querySelector('input[name="image"]').files.length > 0) {
                    formData.append('image', this.querySelector('input[name="image"]').files[0]);
                }
                formData.append('video', videoFile, videoFile.name);

                xhr = new XMLHttpRequest();
                xhr.open('POST', this.action, true);

                // Update progress bar
                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        progressBar.textContent = percentComplete + '%';
                    }
                };

                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        window.location.href = xhr.responseURL;
                    } else {
                        statusElement.textContent = 'Upload failed. Server responded with an error.';
                        resetUploadUI();
                    }
                };

                xhr.onabort = function() {
                    statusElement.textContent = 'Upload cancelled.';
                    resetUploadUI();
                };

                xhr.onerror = function() {
                    statusElement.textContent = 'Upload failed due to a network error.';
                    resetUploadUI();
                };

                cancelButton.onclick = function() {
                    if (xhr) xhr.abort();
                };

                xhr.send(formData);
            } else {
                // If no video, submit the form normally
                this.submit();
            }
        });

        function resetUploadUI(message) {
            const submitButton = document.getElementById('create-post-submit-btn');
            const cancelButton = document.getElementById('cancel-upload-btn');
            const progressContainer = document.getElementById('progress-container');
            const videoInput = createPostForm.querySelector('input[name="video"]');
            const statusElement = document.getElementById('upload-status');

            if (message) {
                statusElement.textContent = message;
                statusElement.style.display = 'block';
            }
            submitButton.disabled = false;
            submitButton.textContent = 'Post';
            cancelButton.style.display = 'none';
            progressContainer.style.display = 'none';
            // Clear the file input to prevent re-uploading the same file
            videoInput.value = '';
        }
    }
});
</script>
{% endblock %}