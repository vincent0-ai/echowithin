{% macro render_post_item(post, current_user, now=none) %}
{% set post_age_hours = ((now - post.timestamp).total_seconds() / 3600) if (now and post.timestamp) else 999 %}
{% set engagement = (post.likes_count|default(0)) + (post.comment_count|default(0) * 2) %}
<div class="post-item">
    <div class="post-header">
        <div class="post-title-row">
            <h3 class="post-title"><a href="{{ post.url }}" class="record-view-link"
                    data-post-id="{{ post._id|string }}">{{ post.title }}</a></h3>
            <div class="post-badges">
                {% if post.is_pinned %}
                <span class="badge badge-pinned" title="Pinned by Admin">
                    <i class="fas fa-thumbtack"></i> Pinned
                </span>
                {% endif %}
                {% if post_age_hours < 24 %} <span class="badge badge-new" title="Posted less than 24 hours ago">
                    New</span>
                    {% endif %}
                    {% if engagement >= 10 and post_age_hours < 168 %} <span class="badge badge-hot"
                        title="Trending this week">Hot</span>
                        {% elif engagement >= 5 %}
                        <span class="badge badge-trending" title="Getting attention">Trending</span>
                        {% endif %}
            </div>
        </div>
        <div class="post-views">
            <i class="fa-regular fa-eye"></i>
            <span id="view-count-{{ post._id|string }}">{{ post.view_count if post.view_count is defined else 0
                }}</span>
        </div>
    </div>

    {% if post.status == 'processing_media' %}
    <div class="media-processing-placeholder">
        <div class="spinner"></div>
        <p>Your media is being processed...</p>
    </div>
    {% else %}
    {# --- Existing Media Display Logic --- #}
    {% if post.video_url %}
    <div class="post-media-container">
        <video class="post-video" controls preload="metadata">
            <source src="{{ post.video_url }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    {% elif post.video_filename %}
    <div class="post-media-container">
        <video class="post-video" controls preload="metadata">
            <source src="{{ url_for('uploaded_file', filename=post.video_filename) }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    {% elif post.image_urls %}
    {# Support multiple image URLs (list). Render a gallery if more than one. #}
    {% set images = post.image_urls %}
    {% if images|length > 1 %}
    <div class="post-gallery">
        {% for img in images %}
        <div class="post-gallery-item">
            <img src="{{ img }}" data-full-url="{{ img }}" alt="Image {{ loop.index }} for {{ post.title }}"
                class="gallery-thumb" />
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="post-image-container {% if post.image_status == 'processing' %}processing{% endif %}">
        {% if post.image_status in ['safe', 'processing'] %}
        <img src="{{ images[0] }}" alt="Post image for {{ post.title }}" class="post-image"
            data-full-url="{{ images[0] }}">
        {% elif post.image_status == 'removed_nsfw' %}
        <div class="nsfw-placeholder">Image removed due to sensitive content.</div>
        {% endif %}
    </div>
    {% endif %}

    {% elif post.image_filenames %}
    {# Support list of uploaded filenames #}
    {% set files = post.image_filenames %}
    {% if files|length > 1 %}
    <div class="post-gallery">
        {% for fname in files %}
        <div class="post-gallery-item">
            <img src="{{ url_for('uploaded_file', filename=fname) }}"
                data-full-url="{{ url_for('uploaded_file', filename=fname) }}"
                alt="Image {{ loop.index }} for {{ post.title }}" class="gallery-thumb" />
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="post-image-container">
        <img src="{{ url_for('uploaded_file', filename=files[0]) }}" alt="Post image for {{ post.title }}"
            class="post-image" data-full-url="{{ url_for('uploaded_file', filename=files[0]) }}">
    </div>
    {% endif %}

    {% elif post.image_url %}
    <div class="post-image-container {% if post.image_status == 'processing' %}processing{% endif %}">
        {% if post.image_status in ['safe', 'processing'] %}
        <img src="{{ post.image_url }}" alt="Post image for {{ post.title }}" class="post-image"
            data-full-url="{{ post.image_url }}">
        {% elif post.image_status == 'removed_nsfw' %}
        <div class="nsfw-placeholder">Image removed due to sensitive content.</div>
        {% endif %}
    </div>

    {% elif post.image_filename %}
    <div class="post-image-container">
        <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" alt="Post image for {{ post.title }}"
            class="post-image" data-full-url="{{ url_for('uploaded_file', filename=post.image_filename) }}">
    </div>
    {% endif %}
    {% endif %}

    {# --- Content with Markdown rendering --- #}
    <div class="post-content-wrapper">
        {% if post.content|length > 150 %}
        <div class="post-content-truncated">{{ post.content|truncate(150, true)|markdown|safe }}</div>
        <div class="post-content-full">{{ post.content|markdown|safe }}</div>
        <a href="#" class="read-more-link read-more-toggle" data-post-id="{{ post._id|string }}">Read More</a>
        {% else %}
        <div class="post-content-rendered">{{ post.content|markdown|safe }}</div>
        {% endif %}
    </div>

    {# --- Timestamp with relative time --- #}
    <div class="post-meta">
        {% if post.edited_at %}
        Edited <span class="relative-time"
            data-timestamp="{{ post.edited_at.isoformat() if post.edited_at else '' }}">{{ post.edited_at|localtime
            }}</span> by <strong><a href="{{ url_for('profile', username=post.author) }}">{{ post.author }}</a></strong>
        {% else %}
        Posted by <strong><a href="{{ url_for('profile', username=post.author) }}">{{ post.author }}</a></strong> Â·
        <span class="relative-time" data-timestamp="{{ post.timestamp.isoformat() if post.timestamp else '' }}">{{
            post.timestamp|localtime }}</span>
        {% endif %}

        {% if post.author_achievements %}
        <span class="author-achievements-inline"
            style="display: inline-flex; gap: 4px; margin-left: 8px; vertical-align: middle;">
            {% if 'most_active' in post.author_achievements %}
            <span
                style="background: #e0f2f1; color: #00796b; border: 1px solid #b2dfdb; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; cursor: default;"
                title="Most platform activity last week">ACTIVE</span>
            {% endif %}
            {% if 'most_engager' in post.author_achievements %}
            <span
                style="background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; cursor: default;"
                title="Most comments written last week">ENGAGER</span>
            {% endif %}
            {% if 'top_contributor' in post.author_achievements %}
            <span
                style="background: #ede7f6; color: #512da8; border: 1px solid #d1c4e9; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; cursor: default;"
                title="Most likes received last week">TOP</span>
            {% endif %}
        </span>
        {% endif %}
    </div>

    {# --- Actions: Like button + Share button + Comment count + Edit/Delete --- #}
    <div class="post-actions" style="margin-top: 10px;">
        {# Reaction Button and Menu #}
        {% set reactions = post.reactions|default({}) %}
        {% set ns = namespace(user_reaction=None) %}
        {% if current_user.is_authenticated %}
        {% for r_type, users in reactions.items() %}
        {% if current_user.id|string in users|map('string')|list %}
        {% set ns.user_reaction = r_type %}
        {% endif %}
        {% endfor %}
        {% endif %}

        <div class="reaction-container" data-post-id="{{ post._id|string }}">
            <button class="reaction-btn {% if ns.user_reaction %}reacted{% endif %}"
                data-current-reaction="{{ ns.user_reaction|default('') }}" {% if not current_user.is_authenticated
                %}disabled title="Log in to react" {% endif %}>
                <span class="reaction-icon">
                    {% if ns.user_reaction == 'heart' %}<i class="fas fa-heart"></i>
                    {% elif ns.user_reaction == 'wow' %}ðŸ˜®
                    {% elif ns.user_reaction == 'insightful' %}ðŸ’¡
                    {% elif ns.user_reaction == 'laugh' %}ðŸ˜‚
                    {% elif ns.user_reaction == 'sad' %}ðŸ˜¢
                    {% else %}<i class="far fa-heart"></i>{% endif %}
                </span>
                <span class="likes-count">{{ post.likes_count|default(0) }}</span>
            </button>
            <div class="reaction-menu">
                <button class="reaction-option" data-reaction="heart" title="Love"><i class="fas fa-heart"></i></button>
                <button class="reaction-option" data-reaction="wow" title="Wow">ðŸ˜®</button>
                <button class="reaction-option" data-reaction="insightful" title="Insightful">ðŸ’¡</button>
                <button class="reaction-option" data-reaction="laugh" title="Haha">ðŸ˜‚</button>
                <button class="reaction-option" data-reaction="sad" title="Sad">ðŸ˜¢</button>
            </div>
        </div>

        {# Share Button #}
        <button class="share-btn" data-post-id="{{ post._id|string }}" title="Share this post">
            <i class="fas fa-share-alt"></i>
            <span class="share-count">{{ post.share_count|default(0) }}</span>
        </button>

        <a href="{{ post.url }}" class="btn comment-btn record-view-link" data-post-id="{{ post._id|string }}">
            Comments
            <span class="comment-count-display">
                {{ post.comment_count if post.comment_count is defined else 0 }}
            </span>
        </a>

        {% if current_user.is_authenticated and (post.author_id|string == current_user.id) %}
        <a href="{{ url_for('edit_post', post_id=post._id, action='edit') }}" class="btn edit-btn">Edit</a>

        <form action="{{ url_for('delete_post', post_id=post._id) }}" method="POST" class="delete-post-form"
            style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn delete-btn">Delete</button>
        </form>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro post_polling_script() %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const postsToPoll = document.querySelectorAll('.post-media-container[data-status="processing_media"]');

        postsToPoll.forEach(container => {
            const postId = container.getAttribute('data-post-id');
            if (postId) {
                pollPostStatus(postId, container);
            }
        });

        function pollPostStatus(postId, container) {
            let attempts = 0;
            const maxAttempts = 30; // Poll for 5 minutes (30 * 10s)
            const interval = 10000; // 10 seconds

            const poller = setInterval(() => {
                if (attempts >= maxAttempts) {
                    clearInterval(poller);
                    container.innerHTML = '<div class="media-processing-placeholder"><p>Media processing timed out. Please refresh the page.</p></div>';
                    return;
                }

                fetch(`/api/posts/${postId}/status`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(post => {
                        if (post.status === 'published') {
                            clearInterval(poller);
                            updatePostMedia(post, container);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling post status:', error);
                        // Optional: stop polling on error or just continue
                    });

                attempts++;
            }, interval);
        }

        function updatePostMedia(post, container) {
            let mediaHtml = '';
            const altText = `Post image for ${post.title}`;

            if (post.video_url) {
                mediaHtml = `
                <video class="post-video" controls preload="metadata">
                    <source src="${post.video_url}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            `;
            } else if (post.image_urls && post.image_urls.length > 0) {
                if (post.image_urls.length > 1) {
                    // Simplified gallery for now, can be expanded
                    mediaHtml = post.image_urls.map(url => `<img src="${url}" alt="${altText}" class="post-image" style="max-width: 48%; margin: 1%;">`).join('');
                } else {
                    mediaHtml = `<img src="${post.image_urls[0]}" alt="${altText}" class="post-image">`;
                }
            }

            container.innerHTML = mediaHtml;
        }
    });
</script>
{% endmacro %}