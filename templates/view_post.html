{% extends "base.html" %}

{% block title %}
    <title>{{ title }}</title>
    <meta name="description" content="{{ description }}">
{% endblock %}

{% block head_meta %}
{% if meta_url %}
    <link rel="canonical" href="{{ meta_url }}">
    <meta property="og:url" content="{{ meta_url }}" />
{% endif %}
{% if title %}
    <meta property="og:title" content="{{ title }}" />
{% endif %}
{% if description %}
    <meta property="og:description" content="{{ description }}" />
{% endif %}
{% if meta_image %}
    <meta property="og:image" content="{{ meta_image }}" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="{{ meta_image }}" />
{% endif %}
{% if meta_jsonld %}
    <script type="application/ld+json">{{ meta_jsonld|safe }}</script>
{% endif %}
<style>
    .comment-replies { margin-left: 32px; border-left: 2px solid #f4f4f4; padding-left: 12px; }
    .comment-item { margin-bottom: 6px; }
    
    /* Unify all comment action buttons and links */
    .comment-actions .reply-btn,
    .comment-actions .edit-btn,
    .comment-actions .delete-comment,
    .comment-actions .toggle-replies,
    .comment-actions .action-link {
        background: none;
        border: none;
        color: var(--info-color); /* Light blue from your root variables */
        padding: 0;
        margin-right: 12px;
        cursor: pointer;
        font-size: 0.85rem;
        text-decoration: none;
    }
    .comment-actions .reply-btn:hover,
    .comment-actions .edit-btn:hover,
    .comment-actions .delete-comment:hover,
    .comment-actions .toggle-replies:hover,
    .comment-actions .action-link:hover {
        text-decoration: underline;
        color: #1e88e5; /* A slightly darker blue on hover */
    }

    /* Hide reply comment items by default (they will have data-parent attr) */
    .comment-item[data-parent] { display: none; margin-left: 28px; }
    /* Post comment button (maroon) */
    #comment-submit { background: #800000; color: #fff; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    #comment-submit:hover { opacity: 0.95; }
    #comment-form textarea, .reply-form textarea, .edit-form textarea { border: 1px solid #ccc; padding: 8px; border-radius: 4px; }
    #comment-form button, .reply-form button, .edit-form button { margin-top: 6px; }

    /* Styles for comment text size */
    .comment-meta {
        font-size: 0.8rem; /* Smaller font for username and date */
        color: #666;
    }
    .comment-body {
        font-size: 0.95rem; /* Slightly smaller font for the comment content */
    }

    /* Styles for comment voting */
    .comment-voting {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.85rem;
        color: #555;
    }
    .upvote-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #888;
        padding: 2px 4px;
    }
    .upvote-btn.voted, .upvote-btn:hover {
        color: var(--primary-color); /* Use your site's primary color */
    }

</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="post-item" style="position: relative; border-left: none; box-shadow: none; padding: 20px; background-color: white;">
            <div class="post-header" style="align-items: flex-start; gap: 0.6rem;">
                <h1 class="post-title single-post-title" style="margin:0;">{{ post.title }}</h1>
                <div class="post-views">
                    <i class="fa-regular fa-eye"></i>
                    <span id="view-count-{{ post._id|string }}">{{ post.view_count if post.view_count is defined else 0 }}</span>
                </div>
            </div>
        <div class="post-meta">
            {% if post.edited_at %}
                Edited on {{ post.edited_at.strftime('%b %d, %Y at %I:%M %p') if post.edited_at.strftime else post.edited_at }} by <strong><a href="{{ url_for('profile', username=post.author) }}">{{ post.author }}</a></strong><br>
            {% else %}
                Posted by <strong>{{ post.author }}</strong> on {{ post.timestamp.strftime('%b %d, %Y at %I:%M %p') }}
            {% endif %}
        </div>

        {% if post.video_url %}
            <div class="post-media-container">
                <video class="post-video" controls preload="metadata">
                    <source src="{{ post.video_url }}" type="video/{{ post.video_url.rsplit('.', 1)[1] if '.' in post.video_url else 'mp4' }}">
                    Your browser does not support the video tag.
                </video>
            </div>
        {% elif post.image_urls %}
            {% set images = post.image_urls %}
            {% if images|length > 1 %}
                <div class="post-gallery">
                    {% for img in images %}
                        <div class="post-gallery-item">
                            <img src="{{ img }}" data-full-url="{{ img }}" alt="Image {{ loop.index }} for {{ post.title }}" class="gallery-thumb" />
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="post-image-container {% if post.image_status == 'processing' %}processing{% endif %}">
                    {% if post.image_status == 'safe' %}
                        <img src="{{ images[0] }}" alt="Post image for {{ post.title }}" class="post-image" data-full-url="{{ images[0] }}">
                    {% elif post.image_status == 'removed_nsfw' %}
                        <div class="nsfw-placeholder">Image removed for containing sensitive content.</div>
                    {% endif %}
                </div>
            {% endif %}
        {% elif post.image_filenames %}
            {% set files = post.image_filenames %}
            {% if files|length > 1 %}
                <div class="post-gallery">
                    {% for fname in files %}
                        <div class="post-gallery-item">
                            <img src="{{ url_for('uploaded_file', filename=fname) }}" data-full-url="{{ url_for('uploaded_file', filename=fname) }}" alt="Image {{ loop.index }} for {{ post.title }}" class="gallery-thumb" />
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="post-image-container">
                    <img src="{{ url_for('uploaded_file', filename=files[0]) }}" alt="Post image for {{ post.title }}" class="post-image" data-full-url="{{ url_for('uploaded_file', filename=files[0]) }}">
                </div>
            {% endif %}
        {% endif %}

        <div class="post-content" style="white-space: pre-wrap; margin-top: 1rem;">{{ post.content|linkify|safe }}</div>

        {% if related_posts %}
        <div class="related-posts-section" style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3 id="toggle-related-posts" style="cursor: pointer; display: inline-block;">
                Related Posts <i class="fa-solid fa-chevron-down" style="font-size: 0.8em;"></i>
            </h3>
            <div id="related-posts-list" class="related-posts-list" style="display: none; margin-top: 10px;">
                {% for r_post in related_posts %}
                    <div class="related-post-item" style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 5px 0; font-size: 1.1rem;">
                            {# The title from Meilisearch might contain highlight tags, so it needs to be marked safe #}
                            <a href="{{ url_for('view_post', slug=r_post.slug) }}">{{ r_post.title|safe }}</a>
                        </h4>
                        <div class="related-post-meta" style="font-size: 0.85rem; color: #666;">
                            by {{ r_post.author_username }} on {{ r_post.created_at.strftime('%b %d, %Y') if r_post.created_at and r_post.created_at.strftime else '' }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="comments-section" style="margin-top: 30px;">
            <h3>Comments ({{ comment_count or 0 }})</h3>

            {# reply_counts mapping provided by server (reply_counts[comment_id] -> int) #}

            {% if current_user.is_authenticated %}
                <form id="comment-form">
                    <textarea id="comment-content" name="content" rows="3" style="width:100%;" placeholder="Write a comment..."></textarea>
                    <button id="comment-submit" type="submit">Post Comment</button>
                </form>
            {% else %}
                <p><a href="{{ url_for('login') }}">Log in</a> to post comments.</p>
            {% endif %}

            <div id="comments-list" style="margin-top: 1rem;">
                {% for c in comments %}
                    {# compute reply count for this comment (number of items with parent_id == c._id) #}
                    {% set reply_count = (reply_counts.get(c._id|string) if reply_counts is defined else 0) | int %}
                    <div class="comment-item" data-id="{{ c._id|string }}" {% if c.parent_id %}data-parent="{{ c.parent_id|string }}"{% endif %} style="border-bottom:1px solid #eee; padding: 8px 0;">
                        <div class="comment-meta">
                            <strong>{% if c.is_deleted %}Deleted{% else %}{{ c.author_username }}{% endif %}</strong>
                            {% if c.created_at %}
                                — {% if c.created_at.strftime %}{{ c.created_at.strftime('%b %d, %Y at %I:%M %p') }}{% else %}{{ c.created_at }}{% endif %}
                            {% endif %}
                        </div>
                        <div class="comment-body" style="margin-top:4px;">{% if c.is_deleted %}<em>Comment deleted</em>{% else %}{{ c.content|linkify|safe }}{% endif %}</div>
                        
                        {% if not c.is_deleted and current_user.is_authenticated %}
                        <div class="comment-voting" style="margin-top: 8px;">
                            <button class="upvote-btn {% if current_user.id and (current_user.id|string) in c.upvoted_by|map('string')|list %}voted{% endif %}" data-id="{{ c._id|string }}" aria-label="Upvote">
                                <i class="fa-solid fa-arrow-up"></i>
                            </button>
                            <span class="upvote-count">{{ c.upvote_count|default(0) }}</span>
                        </div>
                        {% endif %}
                        <div class="comment-actions" style="margin-top:6px;">
                            {% if c.parent_id %}
                                {% if current_user.is_authenticated and not c.is_deleted %}
                                    <a href="#" class="reply-btn action-link" data-id="{{ c._id|string }}">Reply</a>
                                {% endif %}
                            {% else %}
                                {% if current_user.is_authenticated and not c.is_deleted %}
                                    <button class="reply-btn" data-id="{{ c._id|string }}">Reply</button>
                                {% endif %}
                                {% if reply_count and reply_count > 0 %}
                                    <a href="#" class="toggle-replies action-link" data-id="{{ c._id|string }}">Show replies ({{ reply_count }})</a>
                                {% endif %}
                            {% endif %}
                        {% if not c.is_deleted and current_user.is_authenticated and (current_user.is_admin or (c.author_id and (c.author_id|string) == current_user.id)) %}
                            {% if c.parent_id %}
                                <a href="#" class="edit-btn action-link" data-id="{{ c._id|string }}">Edit</a>
                                <a href="#" class="delete-comment action-link" data-id="{{ c._id|string }}">Delete</a>
                            {% else %}
                                <button class="edit-btn" data-id="{{ c._id|string }}">Edit</button>
                                <button class="delete-comment" data-id="{{ c._id|string }}">Delete</button>
                            {% endif %}
                        {% endif %}
                        </div>
                        <div class="comment-replies" style="margin-top:8px; margin-left:18px;"></div>
                    </div>
                {% endfor %}
            </div>
            {% if has_more %}
                <div style="text-align:center; margin-top:8px;"><button id="load-more-comments">Load more comments</button></div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const CURRENT_USER_ID = '{{ current_user.id if current_user.is_authenticated else "" }}';
    const IS_ADMIN = {{ 'true' if current_user.is_authenticated and current_user.is_admin else 'false' }};
    const form = document.getElementById('comment-form');
    let currentPage = {{ comment_page | default(1) }};
    const perPage = {{ per_page | default(10) }};

    function createCommentElement(comment) {
        const el = document.createElement('div');
        el.className = 'comment-item';
        el.setAttribute('data-id', comment.id);
        if (comment.parent_id) el.setAttribute('data-parent', comment.parent_id);
        el.style.borderBottom = '1px solid #eee';
        el.style.padding = '8px 0';

        const meta = document.createElement('div');
        meta.className = 'comment-meta';
        const date = comment.created_at ? new Date(comment.created_at).toLocaleString() : '';
        meta.innerHTML = `<strong>${comment.author_username}</strong> — ${date}`;

        const body = document.createElement('div');
        body.className = 'comment-body';
        body.style.marginTop = '4px';
        body.innerHTML = comment.content;

        el.appendChild(meta);
        el.appendChild(body);

        // Actions: Reply (if logged in), Edit/Delete (if owner or admin)
        const actions = document.createElement('div');
        actions.className = 'comment-actions';
        actions.style.marginTop = '6px';

        if (CURRENT_USER_ID) {
            const voting = document.createElement('div');
            voting.className = 'comment-voting';
            const upvoteBtn = document.createElement('button');
            upvoteBtn.className = 'upvote-btn';
            upvoteBtn.setAttribute('data-id', comment.id);
            upvoteBtn.setAttribute('aria-label', 'Upvote');
            upvoteBtn.innerHTML = '<i class="fa-solid fa-arrow-up"></i> <span class="upvote-count">0</span>';
            voting.appendChild(upvoteBtn);
            actions.appendChild(voting);
        }

        if (CURRENT_USER_ID) {
            if (comment.parent_id) {
                const replyLink = document.createElement('a');
                replyLink.href = '#';
                replyLink.className = 'reply-btn action-link';
                replyLink.setAttribute('data-id', comment.id);
                replyLink.textContent = 'Reply';
                actions.appendChild(replyLink);
            } else {
                const replyBtn = document.createElement('button');
                replyBtn.className = 'reply-btn';
                replyBtn.setAttribute('data-id', comment.id);
                replyBtn.textContent = 'Reply';
                actions.appendChild(replyBtn);
                // placeholder for toggle link; client appended replies might update counts
            }
        }

        const canModify = IS_ADMIN || (CURRENT_USER_ID && comment.author_id && comment.author_id === CURRENT_USER_ID);
        if (canModify) {
            if (comment.parent_id) {
                const editLink = document.createElement('a');
                editLink.href = '#';
                editLink.className = 'edit-btn action-link';
                editLink.setAttribute('data-id', comment.id);
                editLink.textContent = 'Edit';
                actions.appendChild(editLink);

                const delLink = document.createElement('a');
                delLink.href = '#';
                delLink.className = 'delete-comment action-link';
                delLink.setAttribute('data-id', comment.id);
                delLink.textContent = 'Delete';
                actions.appendChild(delLink);
            } else {
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.setAttribute('data-id', comment.id);
                editBtn.textContent = 'Edit';
                actions.appendChild(editBtn);

                const del = document.createElement('button');
                del.className = 'delete-comment';
                del.setAttribute('data-id', comment.id);
                del.style.marginLeft = '8px';
                del.textContent = 'Delete';
                actions.appendChild(del);
            }
        }

        el.appendChild(actions);

        const repliesContainer = document.createElement('div');
        repliesContainer.className = 'comment-replies';
        repliesContainer.style.marginTop = '8px';
        repliesContainer.style.marginLeft = '18px';
        el.appendChild(repliesContainer);

        return el;
    }

    async function appendComments(comments, toBottom=true) {
        const list = document.getElementById('comments-list');
        for (const c of comments) {
            const el = createCommentElement(c);
            if (c.parent_id) {
                const parent = document.querySelector(`[data-id="${c.parent_id}"]`);
                if (parent) {
                    const replies = parent.querySelector('.comment-replies');
                    if (replies) {
                        replies.appendChild(el);
                        continue;
                    }
                }
            }
            if (toBottom) list.appendChild(el);
            else list.insertBefore(el, list.firstChild);
        }
    }

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const contentField = document.getElementById('comment-content');
            const content = contentField.value;
            if (!content || !content.trim()) return;

            const resp = await fetch('{{ url_for('api_post_comments', slug=post.slug) }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            if (resp.ok) {
                const newComment = await resp.json();
                // Append new comment to the list (bottom) or under parent
                appendComments([newComment], true);
                // Clear textarea
                contentField.value = '';
                // Increment local count display
                const header = document.querySelector('.comments-section h3');
                if (header) {
                    const m = header.textContent.match(/Comments \((\d+)\)/);
                    if (m) {
                        const n = parseInt(m[1], 10) + 1;
                        header.textContent = `Comments (${n})`;
                    }
                }
            } else {
                const data = await resp.json();
                alert(data.error || 'Failed to post comment');
            }
        });
    }

    document.getElementById('comments-list')?.addEventListener('click', async (e) => {
        // Toggle replies
        if (e.target && e.target.classList.contains('toggle-replies')) {
            e.preventDefault();
            const pid = e.target.getAttribute('data-id');
            const replies = document.querySelectorAll(`.comment-item[data-parent="${pid}"]`);
            if (!replies || replies.length === 0) return;
            const first = replies[0];
            const hidden = getComputedStyle(first).display === 'none';
            if (hidden) {
                replies.forEach(el => el.style.display = 'block');
                e.target.textContent = e.target.textContent.replace(/^Show replies/, 'Hide replies');
            } else {
                replies.forEach(el => el.style.display = 'none');
                e.target.textContent = e.target.textContent.replace(/^Hide replies/, 'Show replies');
            }
            return;
        }
        // Delete
        if (e.target && e.target.classList.contains('delete-comment')) {
            e.preventDefault();
            const id = e.target.getAttribute('data-id');
            if (typeof window.showCustomConfirm === 'function') {
                window.showCustomConfirm('Delete this comment?', async (confirmed) => {
                    if (!confirmed) return;
                    const resp = await fetch('/api/comments/' + id, { method: 'DELETE' });
                    if (resp.ok) {
                        // Decide whether to remove the comment node entirely or show a placeholder.
                        // If the comment has any non-deleted replies, keep a placeholder so replies remain nested.
                        const item = e.target.closest('.comment-item');
                        if (item) {
                            const id = item.getAttribute('data-id');
                            // find replies that are not already marked deleted
                            const repliesSelector = `.comment-item[data-parent="${id}"]:not([data-deleted="1"])`;
                            const liveReplies = document.querySelectorAll(repliesSelector);
                            if (!liveReplies || liveReplies.length === 0) {
                                // No existing replies: remove the comment element completely
                                item.remove();
                            } else {
                                // There are replies: replace body with placeholder and keep the node
                                const body = item.querySelector('.comment-body');
                                if (body) body.innerHTML = '<em>Comment deleted</em>';
                                // remove action buttons
                                const actions = item.querySelector('.comment-actions');
                                if (actions) actions.remove();
                                item.setAttribute('data-deleted', '1');
                            }
                        }
                        // Decrement header count
                        const header = document.querySelector('.comments-section h3');
                        if (header) {
                            const m = header.textContent.match(/Comments \((\d+)\)/);
                            if (m) {
                                const n = Math.max(0, parseInt(m[1], 10) - 1);
                                header.textContent = `Comments (${n})`;
                            }
                        }
                        if (typeof window.showCustomAlert === 'function') window.showCustomAlert('Comment deleted.', 'success');
                    } else {
                        if (typeof window.showCustomAlert === 'function') window.showCustomAlert('Could not delete comment', 'danger');
                        else alert('Could not delete comment');
                    }
                });
            } else {
                if (!confirm('Delete this comment?')) return;
            }
            return;
        }

        // Upvote
        if (e.target && e.target.closest('.upvote-btn')) {
            e.preventDefault();
            const button = e.target.closest('.upvote-btn');
            const id = button.getAttribute('data-id');
            const resp = await fetch('/api/comments/' + id + '/vote', { method: 'POST' });
            if (resp.ok) {
                const data = await resp.json();
                const commentEl = button.closest('.comment-item');
                if (commentEl) {
                    const countEl = commentEl.querySelector('.upvote-count');
                    if (countEl) countEl.textContent = data.upvote_count;
                }
                if (data.voted) {
                    button.classList.add('voted');
                } else {
                    button.classList.remove('voted');
                }
            }
            return;
        }

        // Reply
        if (e.target && e.target.classList.contains('reply-btn')) {
            e.preventDefault();
            const parentId = e.target.getAttribute('data-id');
            // If a reply form already exists under this parent, focus it
            const parentEl = document.querySelector(`[data-id="${parentId}"]`);
            if (!parentEl) return;
            const replies = parentEl.querySelector('.comment-replies');
            if (!replies) return;
            // Prevent multiple reply boxes
            if (replies.querySelector('.reply-form')) return;

            const form = document.createElement('form');
            form.className = 'reply-form';
            form.style.marginTop = '8px';
            form.innerHTML = `<textarea rows="2" style="width:100%;" class="reply-content"></textarea><button type="submit">Reply</button> <button type="button" class="cancel-reply">Cancel</button>`;
            replies.insertBefore(form, replies.firstChild);

            form.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const content = form.querySelector('.reply-content').value;
                if (!content || !content.trim()) return;
                const resp = await fetch('{{ url_for('api_post_comments', slug=post.slug) }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, parent_id: parentId })
                });
                if (resp.ok) {
                    const newComment = await resp.json();
                    appendComments([newComment], true);
                    // Ensure replies are visible for this parent after posting
                    try {
                        const parentEl = document.querySelector(`[data-id="${parentId}"]`);
                        if (parentEl) {
                            // show any reply items
                            document.querySelectorAll(`.comment-item[data-parent="${parentId}"]`).forEach(el => el.style.display = 'block');
                            // update toggle link text if present
                            const toggle = parentEl.querySelector('.toggle-replies');
                            if (toggle) {
                                const m = toggle.textContent.match(/Show replies \((\d+)\)/);
                                if (m) {
                                    const n = parseInt(m[1], 10) + 1;
                                    toggle.textContent = `Hide replies (${n})`;
                                } else {
                                    // if it was already 'Hide replies (n)', try to increment
                                    const mm = toggle.textContent.match(/Hide replies \((\d+)\)/);
                                    if (mm) {
                                        const nn = parseInt(mm[1], 10) + 1;
                                        toggle.textContent = `Hide replies (${nn})`;
                                    }
                                }
                            }
                        }
                    } catch (err) {
                        console.warn('Failed to update reply toggle', err);
                    }
                    form.remove();
                    // Increment header count
                    const header = document.querySelector('.comments-section h3');
                    if (header) {
                        const m = header.textContent.match(/Comments \((\d+)\)/);
                        if (m) {
                            const n = parseInt(m[1], 10) + 1;
                            header.textContent = `Comments (${n})`;
                        }
                    }
                } else {
                    const data = await resp.json();
                    alert(data.error || 'Failed to post reply');
                }
            });

            form.querySelector('.cancel-reply').addEventListener('click', () => form.remove());
            return;
        }

        // Edit
        if (e.target && e.target.classList.contains('edit-btn')) {
            e.preventDefault();
            const cid = e.target.getAttribute('data-id');
            const commentEl = document.querySelector(`[data-id="${cid}"]`);
            if (!commentEl) return;
            const bodyEl = commentEl.querySelector('.comment-body');
            const oldHtml = bodyEl.innerHTML;
            // Prevent multiple edit boxes
            if (commentEl.querySelector('.edit-form')) return;

            const editForm = document.createElement('form');
            editForm.className = 'edit-form';
            editForm.style.marginTop = '8px';
            editForm.innerHTML = `<textarea rows="3" style="width:100%;" class="edit-content">${bodyEl.textContent}</textarea><button type="submit">Save</button> <button type="button" class="cancel-edit">Cancel</button>`;
            bodyEl.style.display = 'none';
            bodyEl.parentNode.insertBefore(editForm, bodyEl.nextSibling);

            editForm.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const newContent = editForm.querySelector('.edit-content').value;
                if (!newContent || !newContent.trim()) return;
                const resp = await fetch('/api/comments/' + cid, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: newContent })
                });
                if (resp.ok) {
                    const updated = await resp.json();
                    bodyEl.innerHTML = updated.content;
                    bodyEl.style.display = '';
                    editForm.remove();
                } else {
                    const data = await resp.json();
                    alert(data.error || 'Failed to edit comment');
                }
            });

            editForm.querySelector('.cancel-edit').addEventListener('click', () => {
                editForm.remove();
                bodyEl.style.display = '';
            });
            return;
        }
    });

    const loadMoreBtn = document.getElementById('load-more-comments');
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', async (e) => {
            loadMoreBtn.disabled = true;
            const nextPage = currentPage + 1;
            try {
                const resp = await fetch('{{ url_for('api_post_comments', slug=post.slug) }}?page=' + nextPage + '&per_page=' + perPage);
                if (!resp.ok) throw new Error('Failed to load');
                const data = await resp.json();
                if (data.comments && data.comments.length) {
                    await appendComments(data.comments, true);
                    currentPage = data.page;
                }
                if (!data.has_more) {
                    loadMoreBtn.remove();
                } else {
                    loadMoreBtn.disabled = false;
                }
            } catch (err) {
                console.error(err);
                alert('Unable to load more comments');
                loadMoreBtn.disabled = false;
            }
        });
    }

    // On page load, record a view for this post
    if (typeof window.recordPostView === 'function') {
        window.recordPostView('{{ post._id|string }}');
    }

    // Lightbox support for single-post view (gallery or single image)
    (function setupLightboxView(){
        let modal = document.querySelector('.lightbox-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.className = 'lightbox-modal';
            modal.innerHTML = `
                <button class="lightbox-close" aria-label="Close">&times;</button>
                <button class="lightbox-prev" aria-label="Previous">&#10094;</button>
                <button class="lightbox-next" aria-label="Next">&#10095;</button>
                <img src="" alt="" />
            `;
            document.body.appendChild(modal);
        }
        const modalImg = modal.querySelector('img');
        const closeBtn = modal.querySelector('.lightbox-close');
        const prevBtn = modal.querySelector('.lightbox-prev');
        const nextBtn = modal.querySelector('.lightbox-next');

        let currentGallery = [];
        let currentIndex = 0;

        function openLightboxWithGallery(gallery, index) {
            currentGallery = gallery || [];
            currentIndex = index || 0;
            modalImg.src = currentGallery[currentIndex] || '';
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            prevBtn.style.display = currentGallery.length > 1 ? 'block' : 'none';
            nextBtn.style.display = currentGallery.length > 1 ? 'block' : 'none';
        }

        function closeLightbox(){
            modal.style.display = 'none';
            modalImg.src = '';
            currentGallery = [];
            currentIndex = 0;
            document.body.style.overflow = '';
        }

        document.body.addEventListener('click', function(e){
            const t = e.target;
            if (t.matches('.gallery-thumb')) {
                e.preventDefault();
                const galleryContainer = t.closest('.post-gallery') || document;
                const thumbs = Array.from(galleryContainer.querySelectorAll('.gallery-thumb'));
                const gallery = thumbs.map(x => x.dataset.fullUrl || x.src).filter(Boolean);
                const index = thumbs.indexOf(t);
                openLightboxWithGallery(gallery, index);
                return;
            }
            if (t.matches('.post-image')) {
                const src = t.dataset.fullUrl || t.src;
                openLightboxWithGallery([src], 0);
                return;
            }
            if (t.classList && (t.classList.contains('lightbox-close') || t === modal)) {
                closeLightbox();
            }
        });

        closeBtn.addEventListener('click', closeLightbox);
        prevBtn.addEventListener('click', function(ev){ ev.stopPropagation(); if (!currentGallery.length) return; currentIndex = (currentIndex - 1 + currentGallery.length) % currentGallery.length; modalImg.src = currentGallery[currentIndex]; });
        nextBtn.addEventListener('click', function(ev){ ev.stopPropagation(); if (!currentGallery.length) return; currentIndex = (currentIndex + 1) % currentGallery.length; modalImg.src = currentGallery[currentIndex]; });
        document.addEventListener('keydown', function(ev){ if (ev.key === 'Escape') closeLightbox(); if (ev.key === 'ArrowLeft' && currentGallery.length>1) { currentIndex = (currentIndex - 1 + currentGallery.length) % currentGallery.length; modalImg.src = currentGallery[currentIndex]; } if (ev.key === 'ArrowRight' && currentGallery.length>1) { currentIndex = (currentIndex + 1) % currentGallery.length; modalImg.src = currentGallery[currentIndex]; } });
    })();

    // Toggle for related posts
    const toggleRelatedBtn = document.getElementById('toggle-related-posts');
    if (toggleRelatedBtn) {
        toggleRelatedBtn.addEventListener('click', function() {
            const relatedList = document.getElementById('related-posts-list');
            const icon = this.querySelector('i');
            if (relatedList.style.display === 'none') {
                relatedList.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                relatedList.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        });
    }
});
</script>
{% endblock %}