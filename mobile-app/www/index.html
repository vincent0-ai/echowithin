<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#FFFFFF">
    <title>EchoWithin</title>
    <style>
        body {
            height: 100vh;
            background: #FFFFFF;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            font-family: sans-serif;
            color: #6366f1;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid #f1f5f9;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        h2 {
            margin-top: 20px;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="spinner"></div>
    <h2>EchoWithin</h2>
    <p>Connecting to server...</p>

    <script src="capacitor.js"></script>
    <script>
        // REDIRECTION SCRIPT
        const LIVE_SITE = 'https://blog.echowithin.xyz';

        // Helper function to parse deep link and get target URL
        function parseDeepLink(deepLinkUrl) {
            if (!deepLinkUrl) return null;
            try {
                const url = new URL(deepLinkUrl);
                if (url.protocol === 'echowithin:' && url.host === 'open') {
                    let path = url.searchParams.get('path') || '/';
                    const params = new URLSearchParams(url.search);
                    params.delete('path');
                    const search = params.toString();
                    if (search) path += '?' + search;
                    return LIVE_SITE + path;
                }
            } catch (e) {
                console.error('Error parsing deep link:', e);
            }
            return null;
        }

        async function run() {
            console.log("Bridge: Starting...");

            // 1. Give Capacitor a moment to initialize
            await new Promise(r => setTimeout(r, 200));

            const { SplashScreen, App, Browser } = (window.Capacitor && window.Capacitor.Plugins) || {};

            // 2. ALWAYS hide splash screen immediately here.
            // This prevents the "stuck at loading" state.
            if (SplashScreen) {
                console.log("Bridge: Hiding Splash...");
                try {
                    await SplashScreen.hide();
                } catch (e) { console.error(e); }
            }

            // 3. Set up listener for warm-start deep links (in case app stays on this page)
            if (App) {
                App.addListener('appUrlOpen', function(event) {
                    console.log("Bridge: appUrlOpen received:", event.url);
                    const targetUrl = parseDeepLink(event.url);
                    if (targetUrl) {
                        // Close the OAuth browser if open
                        if (Browser) {
                            Browser.close().catch(function() {});
                        }
                        console.log("Bridge: Warm-start redirect to", targetUrl);
                        window.location.replace(targetUrl);
                    }
                });
            }

            // 4. Detect cold-start deep link path
            let path = '';
            if (App) {
                try {
                    const launch = await App.getLaunchUrl();
                    if (launch && launch.url) {
                        console.log("Bridge: Cold-start launch URL:", launch.url);
                        const url = new URL(launch.url);
                        if (url.protocol === 'echowithin:' && url.host === 'open') {
                            path = url.searchParams.get('path') || '/';
                            const params = new URLSearchParams(url.search);
                            params.delete('path');
                            const search = params.toString();
                            if (search) path += '?' + search;
                            
                            // Close the OAuth browser if open
                            if (Browser) {
                                Browser.close().catch(function() {});
                            }
                        }
                    }
                } catch (e) { console.error(e); }
            }

            const targetUrl = path ? LIVE_SITE + path : LIVE_SITE;
            console.log("Bridge: Redirecting to", targetUrl);

            // 5. Final safety hide and redirect
            setTimeout(() => {
                window.location.replace(targetUrl);
            }, 100);
        }

        run();

        // 6. Global safety backup
        setTimeout(() => {
            window.location.replace(LIVE_SITE);
        }, 6000);
    </script>
</body>

</html>