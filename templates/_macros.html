{% macro render_post_item(post, current_user) %}
    <div class="post-item">
        <h3><a href="{{ url_for('view_post', slug=post.slug) }}">{{post.title}}</a></h3>

        <!-- Media Display Logic: show video if present, otherwise image -->
        {% if post.video_url or post.video_filename %}
            <div class="post-media-container">
                {% if post.video_url %}
                    <video class="post-video" controls preload="metadata">
                        <source src="{{ post.video_url }}" type="video/{{ post.video_url.rsplit('.', 1)[1] if post.video_url and '.' in post.video_url else 'mp4' }}">
                        Your browser does not support the video tag.
                    </video>
                {% elif post.video_filename %}
                    <video class="post-video" controls preload="metadata">
                        <source src="{{ url_for('uploaded_file', filename=post.video_filename) }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% endif %}
            </div>
        {% elif post.image_url or post.image_filename %}
            <div class="post-image-container {% if post.image_status == 'processing' %}processing{% endif %}">
                {% if post.image_url %}
                    {# Display image from Cloudinary #}
                    {% if post.image_status == 'safe' or post.image_status == 'processing' %}
                        <img src="{{ post.image_url }}" alt="Post image for {{ post.title }}" class="post-image">
                    {% elif post.image_status == 'removed_nsfw' %}
                        <div class="nsfw-placeholder">Image removed due to sensitive content.</div>
                    {% endif %}
                {% elif post.image_filename %}
                    {# Fallback for old posts: Display image from local uploads #}
                    <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" alt="Post image for {{ post.title }}" class="post-image">
                {% endif %}
            </div>
        {% endif %}

        <div class="post-content-wrapper">
            {% if post.content|length > 150 %}
                <p class="post-content-truncated">{{ post.content|truncate(150, true)|linkify|safe }}</p>
                <p class="post-content-full">{{ post.content|linkify|safe }}</p>
                <a href="#" class="read-more-link read-more-toggle">Read More</a>
            {% else %}
                <p>{{ post.content|linkify|safe }}</p>
            {% endif %}
        </div>

        <div class="post-meta">
            Posted by <strong>{{ post.author }}</strong> on 
            {# The timestamp might be a datetime object (server-rendered) or a string (client-rendered) #}
            {% if post.timestamp.strftime %}
                {{ post.timestamp.strftime('%b %d, %Y at %I:%M %p') }}
            {% else %}{{ post.timestamp }}{% endif %}
        </div>
        <div class="post-actions">
            <a href="{{ url_for('view_post', slug=post.slug) }}" class="btn comment-btn">
                Comments
                <span class="remark42__counter" data-remark-url="{{ url_for('view_post', slug=post.slug) }}"></span>
            </a>

            {% if current_user.is_authenticated and post.author_id|string == current_user.id %}
                <a href="{{ url_for('edit_post', post_id=post._id, action='edit') }}" class="btn edit-btn">Edit</a>
                <form action="{{ url_for('delete_post', post_id=post._id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this post?');" style="display: inline;">
                    <button type="submit" class="btn delete-btn">Delete</button>
                </form>
            {% endif %}
        </div>
    </div>
{% endmacro %}