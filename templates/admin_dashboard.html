{% extends 'base.html' %}

{% block title %} <title>Admin Dashboard</title> {% endblock %}
{% block content %} 
<div class="container admin-dashboard-page-container py-4 px-3">
  <h1>Admin Dashboard</h1>
  <div class="d-flex flex-column flex-sm-row gap-2 mb-4">
    <button id="reindex-btn" class="btn btn-primary ">Reindex Search</button>
    <a id="export-csv" class="btn btn-secondary" href="/admin/export_csv?metric=posts_per_day">Export Posts CSV</a>
  </div>

  <h3>Posts per Day</h3>
  <div class="chart-container"><canvas id="postsChart"></canvas></div>

  <h3>Comments per Day</h3>
  <div class="chart-container"><canvas id="commentsChart"></canvas></div>

  <h3>Top Posts by Comments</h3>
  <ul id="top-posts" class="mb-4"></ul>

  <h3>Users</h3>
  <p>Total confirmed users: <span id="total-users"></span></p>
  <p>Active users (window): <span id="active-users"></span></p>
    <h3>Traffic (visits)</h3>
    <h3>Currently Active Users (<span id="active-now-count">0</span>)</h3>
    <ul id="active-now-list"></ul>

    <div class="chart-container"><canvas id="trafficChart"></canvas></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .chart-container {
    position: relative;
    margin-bottom: 2rem;
    height: 300px; /* Default height for charts */
    width: 100%;
  }
</style>

<script>
async function loadMetrics(){
  const res = await fetch('/admin/metrics');
  const data = await res.json();

  // Posts chart
  const postsLabels = data.posts_per_day.map(x=>x._id);
  const postsCounts = data.posts_per_day.map(x=>x.count);
  const ctx1 = document.getElementById('postsChart').getContext('2d');
  new Chart(ctx1, {
    type:'line', 
    data:{labels:postsLabels,datasets:[{label:'Posts',data:postsCounts,borderColor:'blue',fill:false}]},
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // Comments chart
  const comLabels = data.comments_per_day.map(x=>x._id);
  const comCounts = data.comments_per_day.map(x=>x.count);
  const ctx2 = document.getElementById('commentsChart').getContext('2d');
  new Chart(ctx2, {
    type:'line', 
    data:{
      labels:comLabels,
      datasets:[{label:'Comments',data:comCounts,borderColor:'green',fill:false}]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // Top posts
  const topList = document.getElementById('top-posts');
  topList.innerHTML = '';
  (data.top_posts_by_comments || []).forEach(p=>{
    const li = document.createElement('li');
    const link = document.createElement('a');
    link.href = `/post/${p.slug}`;
    link.textContent = `${p.title} â€” ${p.count} comments`;
    link.target = '_blank'; // Open in new tab
    li.appendChild(link);
    topList.appendChild(li);
  });

  document.getElementById('total-users').textContent = data.total_users;
  document.getElementById('active-users').textContent = data.active_users;
    // Load traffic data
    try{
      const tRes = await fetch('/admin/traffic');
      const tData = await tRes.json();
      const tLabels = tData.visits_per_day.map(x=>x._id);
      const tCounts = tData.visits_per_day.map(x=>x.count);
      const ctx3 = document.getElementById('trafficChart').getContext('2d');
      new Chart(ctx3, {
        type:'bar', 
        data:{
          labels:tLabels,
          datasets:[{label:'Visits',data:tCounts,backgroundColor:'rgba(102,126,234,0.6)'}]},
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

    }catch(e){
      console.debug('Failed to load traffic metrics', e);
    }
}

async function loadActiveNow() {
    try {
        const res = await fetch('/admin/active_users');
        const data = await res.json();
        const activeList = document.getElementById('active-now-list');
        const activeCount = document.getElementById('active-now-count');
        
        activeList.innerHTML = '';
        activeCount.textContent = data.active_users.length;

        (data.active_users || []).forEach(u => {
            const li = document.createElement('li');
            const link = document.createElement('a');
            link.href = `/profile/${u.username}`;
            link.textContent = `${u.username} (Last seen: ${u.last_active})`;
            li.appendChild(link);
            activeList.appendChild(li);
        });
    } catch (e) {
        console.debug('Failed to load active users', e);
    }
}

loadMetrics();
loadActiveNow();
setInterval(loadActiveNow, 30000); // Refresh every 30 seconds

document.getElementById('reindex-btn').addEventListener('click', async ()=>{
  const btn = document.getElementById('reindex-btn');
  btn.disabled = true;
  btn.textContent = 'Reindexing...';
  const res = await fetch('/admin/reindex_meili', {method:'POST'});
  const json = await res.json();
  alert(JSON.stringify(json));
  btn.disabled = false;
  btn.textContent = 'Reindex Search';
});
</script>
{% endblock %}
