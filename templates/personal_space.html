{% extends "base.html" %}

{% block title %}
<title>{{ title }}</title>
<meta name="description" content="{{ description }}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <style>
        .personal-space-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #3e2217 0%, #5a3328 100%);
            border-radius: 12px;
            color: white;
        }

        .personal-space-header h1 {
            color: white;
            margin: 0 0 0.5rem 0;
        }

        .personal-space-header p {
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        .personal-space-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        /* Strong, high-contrast styles for header stats */
        .personal-space-header .stat-number,
        .personal-space-header .stat-label {
            color: #fff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.35);
        }

        .personal-space-header .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .personal-space-header .stat-label {
            font-size: 0.85rem;
            font-weight: 600;
            opacity: 0.95;
        }

        .tab-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .tab-nav button {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-nav button:hover {
            color: #333;
            background: #f5f5f5;
        }

        .tab-nav button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-nav button .badge {
            background: #eee;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .tab-nav button.active .badge {
            background: var(--primary-color);
            color: white;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Card styles for saved posts */
        .saved-post-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .saved-post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .saved-post-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #f0f0f0;
            flex-shrink: 0;
        }

        .saved-post-thumb-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            flex-shrink: 0;
        }

        .saved-post-info {
            flex: 1;
            min-width: 0;
        }

        .saved-post-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            line-height: 1.3;
        }

        .saved-post-title a {
            color: #333;
            text-decoration: none;
        }

        .saved-post-title a:hover {
            color: var(--primary-color);
        }

        .saved-post-meta {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .saved-post-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-icon {
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            transition: background 0.2s;
        }

        .btn-view {
            background: #e8f4fd;
            color: #1976d2;
        }

        .btn-view:hover {
            background: #d0e8f9;
        }

        .btn-remove {
            background: #ffebee;
            color: #d32f2f;
        }

        .btn-remove:hover {
            background: #ffcdd2;
        }

        /* Note card styles */
        .note-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border-left: 4px solid var(--primary-color);
            position: relative;
        }

        .note-card.pinned {
            border-left-color: #ffc107;
            background: #fffdf5;
        }

        .note-content {
            word-break: break-word;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        /* Markdown rendered content styles */
        .note-content h1,
        .note-content h2,
        .note-content h3 {
            margin: 0.5em 0 0.3em 0;
            line-height: 1.3;
        }

        .note-content h1 {
            font-size: 1.4rem;
        }

        .note-content h2 {
            font-size: 1.2rem;
        }

        .note-content h3 {
            font-size: 1.1rem;
        }

        .note-content p {
            margin: 0.5em 0;
        }

        .note-content ul,
        .note-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .note-content li {
            margin: 0.25em 0;
        }

        .note-content blockquote {
            border-left: 3px solid var(--primary-color);
            margin: 0.5em 0;
            padding: 0.5em 1em;
            background: #f9f9f9;
            color: #555;
        }

        .note-content code {
            background: #f4f4f4;
            padding: 0.15em 0.4em;
            border-radius: 3px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .note-content pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .note-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .note-content a {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .note-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5em 0;
        }

        .note-content th,
        .note-content td {
            border: 1px solid #ddd;
            padding: 0.5em;
            text-align: left;
        }

        .note-content th {
            background: #f5f5f5;
        }

        .note-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 1em 0;
        }

        /* Math (KaTeX) styles */
        .note-content .katex-display {
            margin: 0.5em 0;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
        }

        .note-content .katex {
            font-size: 1.1em;
        }

        /* Ensure inline KaTeX doesn't break layout */
        .note-content .katex-html {
            white-space: nowrap;
        }

        /* Better table styling for math/truth tables */
        .note-content table {
            border-collapse: collapse;
            width: auto;
            max-width: 100%;
            margin: 1em 0;
            font-size: 0.95em;
            overflow-x: auto;
            display: block;
        }

        .note-content th,
        .note-content td {
            border: 1px solid #ccc;
            padding: 0.5em 0.75em;
            text-align: center;
            white-space: nowrap;
        }

        .note-content th {
            background: #f0f0f0;
            font-weight: 600;
        }

        .note-content tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .note-content tbody tr:hover {
            background: #f5f5f5;
        }

        /* KaTeX inside tables */
        .note-content td .katex,
        .note-content th .katex {
            font-size: 1em;
        }

        .note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        .note-date {
            font-size: 0.8rem;
            color: #999;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
        }

        .note-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            color: #666;
            font-size: 0.85rem;
        }

        .note-actions button:hover {
            background: #f5f5f5;
        }

        .note-actions .delete-btn:hover {
            background: #ffebee;
            color: #d32f2f;
        }

        /* Create note form */
        .create-note-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .create-note-card textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.75rem;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 1rem;
        }

        .create-note-card textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(62, 34, 23, 0.1);
        }

        .create-note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .char-count {
            font-size: 0.8rem;
            color: #999;
        }

        .char-count.warning {
            color: #f57c00;
        }

        .char-count.danger {
            color: #d32f2f;
        }

        /* Preview toggle */
        .preview-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #666;
            cursor: pointer;
            user-select: none;
        }

        .preview-toggle input {
            cursor: pointer;
        }

        .note-preview {
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            min-height: 80px;
            max-height: 300px;
            overflow-y: auto;
        }

        .note-preview.active {
            display: block;
        }

        .note-preview-label {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .format-hint {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.5rem;
        }

        .format-hint code {
            background: #f0f0f0;
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-size: 0.85em;
        }

        /* Quick actions */
        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            flex: 1;
            min-width: 140px;
            padding: 1rem;
            border: 2px dashed #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            text-decoration: none;
            color: #666;
        }

        .quick-action-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: #faf8f7;
        }

        .quick-action-btn i {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #888;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 0.5rem;
        }

        /* Search/filter */
        .search-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .search-filter input {
            flex: 1;
            padding: 0.6rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .search-filter input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Mobile optimizations */
        @media (max-width: 600px) {
            .personal-space-header {
                padding: 1rem;
            }

            .personal-space-stats {
                gap: 1rem;
            }

            .tab-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .tab-nav::-webkit-scrollbar {
                display: none;
            }

            .tab-nav button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                white-space: nowrap;
            }

            .saved-post-card {
                flex-direction: column;
            }

            .saved-post-thumb,
            .saved-post-thumb-placeholder {
                width: 100%;
                height: 120px;
            }

            .quick-action-btn {
                min-width: 100px;
                padding: 0.75rem;
            }

            .quick-action-btn i {
                font-size: 1.25rem;
            }
        }
    </style>

    <!-- Header with stats -->
    <div class="personal-space-header">
        <h1>My Personal Space</h1>
        <p>Your private area for saved posts and personal notes</p>
        <div class="personal-space-stats">
            <div class="stat-item">
                <div class="stat-number">{{ saved_posts|length }}</div>
                <div class="stat-label">Saved Posts</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ personal_posts|length }}</div>
                <div class="stat-label">Notes</div>
            </div>
        </div>
        <div class="encrypt-note" aria-hidden="true">
            <i class="fas fa-lock"></i> Notes are end-to-end encrypted
        </div>
        <style>
            .encrypt-note {
                margin-top: 1rem;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                background: rgba(255, 255, 255, 0.12);
                padding: 0.4rem 0.8rem;
                border-radius: 20px;
                font-size: 0.85rem;
                color: #fff;
            }

            .encrypt-note i {
                color: #fff;
            }
        </style>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{{ url_for('blog') }}" class="quick-action-btn">
            <i class="fas fa-compass"></i>
            Explore Posts
        </a>
        <a href="{{ url_for('create_post') }}" class="quick-action-btn">
            <i class="fas fa-pen"></i>
            Create Post
        </a>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav" role="tablist">
        <button class="active" data-tab="saved" role="tab" aria-selected="true">
            Saved
            <span class="badge">{{ saved_posts|length }}</span>
        </button>
        <button data-tab="notes" role="tab" aria-selected="false">
            Notes <i class="fas fa-lock" style="font-size: 0.7rem; opacity: 0.7;"></i>
            <span class="badge">{{ personal_posts|length }}</span>
        </button>
    </div>

    <!-- Saved Posts Tab -->
    <div id="tab-saved" class="tab-panel active" role="tabpanel">
        {% if saved_posts %}
        <div class="search-filter">
            <input type="text" id="saved-search" placeholder="Search saved posts..." aria-label="Search saved posts">
        </div>
        <div class="saved-posts-list" id="saved-posts-container">
            {% for post in saved_posts %}
            <div class="saved-post-card" data-title="{{ post.title|lower }}" data-author="{{ post.author|lower }}">
                {% if post.image_urls and post.image_urls|length > 0 %}
                <img src="{{ post.image_urls[0] }}" alt="" class="saved-post-thumb" loading="lazy">
                {% elif post.image_url %}
                <img src="{{ post.image_url }}" alt="" class="saved-post-thumb" loading="lazy">
                {% else %}
                <div class="saved-post-thumb-placeholder">
                    <i class="fas fa-file-alt"></i>
                </div>
                {% endif %}
                <div class="saved-post-info">
                    <h3 class="saved-post-title">
                        <a href="{{ url_for('view_post', slug=post.slug) }}">{{ post.title }}</a>
                    </h3>
                    <div class="saved-post-meta">
                        <i class="fas fa-user"></i> {{ post.author }} &bull;
                        <i class="fas fa-calendar"></i> {{ post.timestamp|localtime('%b %d, %Y') }}
                        {% if post.view_count %}
                        &bull; <i class="fas fa-eye"></i> {{ post.view_count }}
                        {% endif %}
                    </div>
                    <div class="saved-post-actions">
                        <a href="{{ url_for('view_post', slug=post.slug) }}" class="btn-icon btn-view">
                            <i class="fas fa-arrow-right"></i> Read
                        </a>
                        <form action="{{ url_for('toggle_save_post', post_id=post._id) }}" method="POST"
                            style="display:inline;" class="unsave-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn-icon btn-remove">
                                <i class="fas fa-bookmark"></i> Unsave
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="far fa-bookmark"></i>
            <h3>No saved posts yet</h3>
            <p>Save posts you want to read later by clicking the bookmark icon on any post.</p>
            <a href="{{ url_for('blog') }}" class="btn comment-btn" style="margin-top: 1rem;">Explore Posts</a>
        </div>
        {% endif %}
    </div>

    <!-- Notes Tab -->
    <div id="tab-notes" class="tab-panel" role="tabpanel">
        <div class="create-note-card">
            <div
                style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; color: #666; font-size: 0.85rem;">
                <i class="fas fa-shield-alt"></i> Your notes are encrypted and only visible to you
            </div>
            <form action="{{ url_for('create_personal_post') }}" method="POST" id="create-note-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <textarea name="content" id="note-input" placeholder="Write a private note.." maxlength="8000"
                    required></textarea>
                <div class="format-hint">
                    <i class="fas fa-info-circle"></i>
                    Supports: <code>**bold**</code> <code>*italic*</code> <code>`code`</code> <code>$math$</code>
                    <code>$$block math$$</code>
                </div>
                <div class="create-note-footer">
                    <span class="char-count"><span id="char-count">0</span>/8000</span>
                    <label class="preview-toggle">
                        <input type="checkbox" id="preview-toggle">
                        <i class="fas fa-eye"></i> Preview
                    </label>
                    <button type="submit" class="btn comment-btn" id="add-note-btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </div>
                <div class="note-preview" id="note-preview">
                    <div class="note-preview-label"><i class="fas fa-eye"></i> Preview</div>
                    <div class="note-content" id="preview-content"></div>
                </div>
            </form>
        </div>

        {% if personal_posts %}
        <div class="personal-notes-list">
            {% for note in personal_posts %}
            <div class="note-card">
                <div class="note-content rendered-note" data-raw="{{ note.content | e }}"></div>
                <div class="note-footer">
                    <span class="note-date">
                        <i class="far fa-clock"></i>
                        {{ note.created_at|localtime }}
                        <span style="margin-left: 0.5rem; color: #4caf50; font-size: 0.75rem;" title="Encrypted">
                            <i class="fas fa-lock"></i>
                        </span>
                    </span>
                    <div class="note-actions">
                        <button type="button" class="copy-note-btn" title="Copy note" data-content="{{ note.content }}">
                            <i class="far fa-copy"></i>
                        </button>
                        <form action="{{ url_for('delete_personal_post', post_id=note._id) }}" method="POST"
                            style="display:inline;" class="delete-note-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="delete-btn" title="Delete note">
                                <i class="far fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="far fa-sticky-note"></i>
            <h3>No notes yet</h3>
            <p>Write private notes that only you can see.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- KaTeX for math rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- Marked.js for markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<!-- DOMPurify for sanitization -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Function to auto-detect and convert common math patterns to LaTeX
        function autoDetectMath(text) {
            if (!text) return text;



            // Protect code blocks
            const codeBlocks = [];
            text = text.replace(/```[\s\S]*?```/g, (m) => { codeBlocks.push(m); return `%%CODE${codeBlocks.length - 1}%%`; });
            text = text.replace(/`[^`]+`/g, (m) => { codeBlocks.push(m); return `%%CODE${codeBlocks.length - 1}%%`; });

            // Protect EXISTING $...$
            const existingMath = [];
            text = text.replace(/\$\$[\s\S]*?\$\$/g, (m) => { existingMath.push(m); return `%%EXISTING${existingMath.length - 1}%%`; });
            text = text.replace(/\$[^\$]+?\$/g, (m) => { existingMath.push(m); return `%%EXISTING${existingMath.length - 1}%%`; });

            const wrap = (content) => `$${content}$`;

            function extractBracedContent(str, startIndex) {
                // Skip optional whitespace before the brace
                let i = startIndex;
                while (i < str.length && /\s/.test(str[i])) i++;

                if (str[i] !== '{') return null;
                let depth = 1;
                for (let k = i + 1; k < str.length; k++) {
                    if (str[k] === '{') depth++;
                    else if (str[k] === '}') {
                        depth--;
                        if (depth === 0) return { content: str.substring(i + 1, k), endIndex: k };
                    }
                }
                return null;
            }

            // Commands sorted by length (longest first) to ensure greedy matching
            const mathCmds = [
                // Logic & relations
                'rightarrow', 'Rightarrow', 'leftarrow', 'Leftarrow', 'leftrightarrow', 'Leftrightarrow',
                'longrightarrow', 'Longrightarrow', 'longleftarrow', 'Longleftarrow',
                'iff', 'implies', 'sim', 'neg', 'lnot', 'wedge', 'land', 'vee', 'lor', 'oplus', 'otimes',
                'forall', 'exists', 'nexists', 'therefore', 'because',
                // Set theory
                'emptyset', 'varnothing', 'subset', 'subseteq', 'supset', 'supseteq', 'cup', 'cap', 'setminus',
                'in', 'notin', 'ni',
                // Comparisons
                'neq', 'ne', 'leq', 'le', 'geq', 'ge', 'approx', 'equiv', 'cong', 'propto', 'sim',
                // Greek letters
                'alpha', 'beta', 'gamma', 'Gamma', 'delta', 'Delta', 'epsilon', 'varepsilon', 'zeta',
                'eta', 'theta', 'Theta', 'vartheta', 'iota', 'kappa', 'lambda', 'Lambda', 'mu', 'nu',
                'xi', 'Xi', 'omicron', 'pi', 'Pi', 'varpi', 'rho', 'varrho', 'sigma', 'Sigma', 'varsigma',
                'tau', 'upsilon', 'Upsilon', 'phi', 'Phi', 'varphi', 'chi', 'psi', 'Psi', 'omega', 'Omega',
                // Operators & functions
                'frac', 'sqrt', 'sum', 'prod', 'int', 'iint', 'iiint', 'oint', 'lim', 'limsup', 'liminf',
                'sin', 'cos', 'tan', 'cot', 'sec', 'csc', 'arcsin', 'arccos', 'arctan',
                'sinh', 'cosh', 'tanh', 'coth', 'log', 'ln', 'exp', 'det', 'dim', 'ker', 'deg', 'gcd', 'lcm',
                'min', 'max', 'sup', 'inf', 'arg', 'mod', 'bmod', 'pmod',
                // Accents & decorations
                'hat', 'bar', 'vec', 'dot', 'ddot', 'tilde', 'widehat', 'widetilde', 'overline', 'underline',
                'overbrace', 'underbrace',
                // Spacing & misc
                'cdot', 'cdots', 'ldots', 'dots', 'vdots', 'ddots', 'times', 'div', 'pm', 'mp',
                'infty', 'partial', 'nabla', 'degree', 'micro',
                // Delimiters
                'left', 'right', 'langle', 'rangle', 'lfloor', 'rfloor', 'lceil', 'rceil', 'lvert', 'rvert',
                // Formatting
                'text', 'textbf', 'textit', 'textrm', 'textsf', 'texttt',
                'mathbf', 'mathit', 'mathrm', 'mathsf', 'mathtt', 'mathcal', 'mathbb', 'mathfrak', 'bm', 'bold',
                // Misc symbols
                'bullet', 'circ', 'star', 'dagger', 'ddagger', 'checkmark', 'prime'
            ];
            const cmdRegex = new RegExp('\\\\{1,4}(' + mathCmds.join('|') + ')(?![a-zA-Z])', 'g');

            let result = '';
            let lastIdx = 0;
            let match;
            while ((match = cmdRegex.exec(text)) !== null) {
                result += text.substring(lastIdx, match.index);
                const cmd = match[1];
                let matchedWhole = false;

                if (cmd === 'frac') {
                    let j = match.index + match[0].length;
                    const first = extractBracedContent(text, j);
                    if (first) {
                        const second = extractBracedContent(text, first.endIndex + 1);
                        if (second) {
                            result += wrap(text.substring(match.index, second.endIndex + 1));
                            lastIdx = second.endIndex + 1;
                            cmdRegex.lastIndex = lastIdx;
                            matchedWhole = true;
                        }
                    }
                } else if (cmd === 'sqrt') {
                    let j = match.index + match[0].length;
                    while (j < text.length && /\s/.test(text[j])) j++;
                    if (text[j] === '[') {
                        const endBrkt = text.indexOf(']', j);
                        if (endBrkt !== -1) j = endBrkt + 1;
                    }
                    const content = extractBracedContent(text, j);
                    if (content) {
                        result += wrap(text.substring(match.index, content.endIndex + 1));
                        lastIdx = content.endIndex + 1;
                        cmdRegex.lastIndex = lastIdx;
                        matchedWhole = true;
                    }
                } else if (cmd === 'left') {
                    const remaining = text.substring(match.index);
                    const leftRightMatch = remaining.match(/^\\{1,4}left[\s]*[\(\[\{][\s\S]*?\\{1,4}right[\s]*[\)\]\}]/);
                    if (leftRightMatch) {
                        result += wrap(leftRightMatch[0]);
                        lastIdx = match.index + leftRightMatch[0].length;
                        cmdRegex.lastIndex = lastIdx;
                        matchedWhole = true;
                    }
                } else {
                    let currentIdx = match.index + match[0].length;
                    const bracedArg = extractBracedContent(text, currentIdx);
                    if (bracedArg) currentIdx = bracedArg.endIndex + 1;

                    while (currentIdx < text.length) {
                        let i = currentIdx;
                        while (i < text.length && /\s/.test(text[i])) i++;
                        if (text[i] === '_' || text[i] === '^') {
                            i++;
                            const braced = extractBracedContent(text, i);
                            if (braced) currentIdx = braced.endIndex + 1;
                            else if (/[a-zA-Z0-9]/.test(text[i])) currentIdx = i + 1;
                            else break;
                        } else break;
                    }
                    result += wrap(text.substring(match.index, currentIdx));
                    lastIdx = currentIdx;
                    cmdRegex.lastIndex = lastIdx;
                    matchedWhole = true;
                }

                if (!matchedWhole) {
                    result += text.substring(match.index, match.index + match[0].length);
                    lastIdx = match.index + match[0].length;
                }
            }
            result += text.substring(lastIdx);
            text = result;

            // Simple scripts with balanced parentheses
            const tempM = [];
            text = text.replace(/\$[^$]+\$/g, (m) => { tempM.push(m); return `%%TM${tempM.length - 1}%%`; });
            // Matches (expr)^2 or x^2
            text = text.replace(/(\(([^\(\)]+|(?:\([^\(\)]*\)))\)|[A-Za-z0-9])([\^_])(\{([^}]+)\}|[A-Za-z0-9])/g, (m) => wrap(m));
            text = text.replace(/%%TM(\d+)%%/g, (m, i) => tempM[parseInt(i)]);

            // Numeric fractions 1/2
            text = text.replace(/(^|[^\/\\\d])(\d+)\/(\d+)(?![\/\d])/g, (m, p, n, d) => p + wrap(`\\frac{${n}}{${d}}`));

            // Restore
            text = text.replace(/%%EXISTING(\d+)%%/g, (m, i) => existingMath[parseInt(i)]);
            text = text.replace(/%%CODE(\d+)%%/g, (m, i) => codeBlocks[parseInt(i)]);


            return text;
        }


        // Function to render markdown with math support
        function renderMarkdownWithMath(text) {
            if (!text) return '';

            // 1. First, run auto-detection to convert patterns to $...$ 
            let processedText = autoDetectMath(text);

            // 2. Now protect code blocks and extract ALL math patterns for KaTeX rendering
            const placeholders = [];

            // Protect code blocks (triple backticks)
            processedText = processedText.replace(/```[\s\S]*?```/g, (match) => {
                placeholders.push({ type: 'code', content: match });
                return `%%PLACEHOLDER${placeholders.length - 1}%%`;
            });

            // Protect inline code (single backticks)
            processedText = processedText.replace(/`[^`]+`/g, (match) => {
                placeholders.push({ type: 'code', content: match });
                return `%%PLACEHOLDER${placeholders.length - 1}%%`;
            });

            // Extract and render block math ($$...$$)
            processedText = processedText.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                try {
                    if (typeof katex !== 'undefined') {
                        const rendered = katex.renderToString(math, { displayMode: true, throwOnError: false });
                        placeholders.push({ type: 'rendered', content: rendered });
                        return `%%PLACEHOLDER${placeholders.length - 1}%%`;
                    }
                } catch (e) { }
                return match; // Fallback: keep original
            });

            // Extract and render inline math ($...$)
            // Using a more inclusive regex that allows internal newlines
            processedText = processedText.replace(/\$([\s\S]+?)\$/g, (match, math) => {
                try {
                    if (typeof katex !== 'undefined') {
                        const rendered = katex.renderToString(math, { displayMode: false, throwOnError: false });
                        placeholders.push({ type: 'rendered', content: rendered });
                        return `%%PLACEHOLDER${placeholders.length - 1}%%`;
                    }
                } catch (e) { }
                return match;
            });

            // 3. Configure marked and parse markdown
            if (typeof marked !== 'undefined') {
                marked.setOptions({ breaks: true, gfm: true });
                processedText = marked.parse(processedText);
            }

            // 4. Sanitize Markdown HTML BEFORE restoring KaTeX
            if (typeof DOMPurify !== 'undefined') {
                processedText = DOMPurify.sanitize(processedText);
            }

            // 5. Restore ALL placeholders (including rendered KaTeX)
            processedText = processedText.replace(/%%PLACEHOLDER(\d+)%%/g, (match, index) => {
                const item = placeholders[parseInt(index)];
                return item ? item.content : match;
            });

            return processedText;
        }

        // Render all saved notes on page load
        function renderAllNotes() {
            document.querySelectorAll('.rendered-note').forEach(el => {
                const rawContent = el.dataset.raw || '';
                const textarea = document.createElement('textarea');
                textarea.innerHTML = rawContent;
                const decoded = textarea.value;
                el.innerHTML = renderMarkdownWithMath(decoded);
            });
        }

        // Wait for KaTeX to load, then render
        function waitForLibraries(callback, maxWait = 5000) {
            const start = Date.now();
            const check = () => {
                if (typeof katex !== 'undefined' && typeof marked !== 'undefined') {
                    callback();
                } else if (Date.now() - start < maxWait) {
                    setTimeout(check, 100);
                } else {
                    console.warn('Libraries not loaded, rendering plain text');
                    document.querySelectorAll('.rendered-note').forEach(el => {
                        const rawContent = el.dataset.raw || '';
                        const textarea = document.createElement('textarea');
                        textarea.innerHTML = rawContent;
                        el.textContent = textarea.value;
                    });
                }
            };
            check();
        }

        waitForLibraries(renderAllNotes);

        // Tab switching
        const tabButtons = document.querySelectorAll('.tab-nav button');
        const tabPanels = document.querySelectorAll('.tab-panel');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                tabButtons.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-selected', 'false');
                });
                tabPanels.forEach(p => p.classList.remove('active'));
                button.classList.add('active');
                button.setAttribute('aria-selected', 'true');
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        // Character counter for notes
        const noteInput = document.getElementById('note-input');
        const charCount = document.getElementById('char-count');
        const charCountContainer = charCount?.parentElement;

        if (noteInput && charCount) {
            noteInput.addEventListener('input', () => {
                const len = noteInput.value.length;
                charCount.textContent = len;
                charCountContainer.classList.remove('warning', 'danger');
                if (len > 1800) {
                    charCountContainer.classList.add('danger');
                } else if (len > 1500) {
                    charCountContainer.classList.add('warning');
                }
            });
        }

        // Live preview toggle
        const previewToggle = document.getElementById('preview-toggle');
        const previewContainer = document.getElementById('note-preview');
        const previewContent = document.getElementById('preview-content');

        if (previewToggle && previewContainer && noteInput) {
            previewToggle.addEventListener('change', () => {
                previewContainer.classList.toggle('active', previewToggle.checked);
                if (previewToggle.checked) updatePreview();
            });

            let previewTimeout;
            noteInput.addEventListener('input', () => {
                if (previewToggle.checked) {
                    clearTimeout(previewTimeout);
                    previewTimeout = setTimeout(updatePreview, 300);
                }
            });

            function updatePreview() {
                const text = noteInput.value;
                if (text.trim()) {
                    previewContent.innerHTML = renderMarkdownWithMath(text);
                } else {
                    previewContent.innerHTML = '<span style="color: #999; font-style: italic;">Preview will appear here...</span>';
                }
            }
        }

        // Search saved posts
        const searchInput = document.getElementById('saved-search');
        const savedPosts = document.querySelectorAll('.saved-post-card');

        if (searchInput) {
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase().trim();
                savedPosts.forEach(card => {
                    const title = card.dataset.title || '';
                    const author = card.dataset.author || '';
                    if (title.includes(query) || author.includes(query)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        // Copy note content (copies raw markdown, not rendered)
        document.querySelectorAll('.copy-note-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const content = btn.dataset.content;
                navigator.clipboard.writeText(content).then(() => {
                    const icon = btn.querySelector('i');
                    icon.className = 'fas fa-check';
                    setTimeout(() => { icon.className = 'far fa-copy'; }, 1500);
                });
            });
        });

        // Confirm delete for notes
        document.querySelectorAll('.delete-note-form').forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (typeof window.showCustomConfirm === 'function') {
                    window.showCustomConfirm('Delete this note?', confirmed => {
                        if (confirmed) form.submit();
                    });
                } else if (confirm('Delete this note?')) {
                    form.submit();
                }
            });
        });

        // Confirm unsave for posts
        document.querySelectorAll('.unsave-form').forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (typeof window.showCustomConfirm === 'function') {
                    window.showCustomConfirm('Remove this post from your saved list?', confirmed => {
                        if (confirmed) form.submit();
                    });
                } else if (confirm('Remove this post from your saved list?')) {
                    form.submit();
                }
            });
        });

        // Prevent double submission
        const noteForm = document.getElementById('create-note-form');
        const addNoteBtn = document.getElementById('add-note-btn');

        if (noteForm && addNoteBtn) {
            noteForm.addEventListener('submit', () => {
                addNoteBtn.disabled = true;
                addNoteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            });
        }
    });
</script>
{% endblock %}