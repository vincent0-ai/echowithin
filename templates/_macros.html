{% macro render_post_item(post, current_user) %}
<div class="post-item">
    <div class="post-header">
        <h3 class="post-title"><a href="{{ post.url }}" class="record-view-link" data-post-id="{{ post._id|string }}">{{ post.title }}</a></h3>
        <div class="post-views">
            <i class="fa-regular fa-eye"></i>
            <span id="view-count-{{ post._id|string }}">{{ post.view_count if post.view_count is defined else 0 }}</span>
        </div>
    </div>

    {# --- Media Display Logic (matches JS version) --- #}
    {% if post.video_url %}
        <div class="post-media-container">
            <video class="post-video" controls preload="metadata">
                <source src="{{ post.video_url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>

    {% elif post.video_filename %}
        <div class="post-media-container">
            <video class="post-video" controls preload="metadata">
                <source src="{{ url_for('uploaded_file', filename=post.video_filename) }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>

    {% elif post.image_url %}
        <div class="post-image-container {% if post.image_status == 'processing' %}processing{% endif %}">
            {% if post.image_status in ['safe', 'processing'] %}
                <img src="{{ post.image_url }}" alt="Post image for {{ post.title }}" class="post-image" data-full-url="{{ post.image_url }}">
            {% elif post.image_status == 'removed_nsfw' %}
                <div class="nsfw-placeholder">Image removed due to sensitive content.</div>
            {% endif %}
        </div>

    {% elif post.image_filename %}
        <div class="post-image-container">
            <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" alt="Post image for {{ post.title }}" class="post-image" data-full-url="{{ url_for('uploaded_file', filename=post.image_filename) }}">
        </div>

    {% elif post.image_urls %}
        {# Support multiple image URLs (list). Render a gallery if more than one. #}
        {% set images = post.image_urls %}
        {% if images|length > 1 %}
            <div class="post-gallery">
                {% for img in images %}
                    <div class="post-gallery-item">
                        <img src="{{ img }}" data-full-url="{{ img }}" alt="Image {{ loop.index }} for {{ post.title }}" class="gallery-thumb" />
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="post-image-container {% if post.image_status == 'processing' %}processing{% endif %}">
                {% if post.image_status in ['safe', 'processing'] %}
                    <img src="{{ images[0] }}" alt="Post image for {{ post.title }}" class="post-image">
                {% elif post.image_status == 'removed_nsfw' %}
                    <div class="nsfw-placeholder">Image removed due to sensitive content.</div>
                {% endif %}
            </div>
        {% endif %}

    {% elif post.image_filenames %}
        {# Support list of uploaded filenames #}
        {% set files = post.image_filenames %}
        {% if files|length > 1 %}
            <div class="post-gallery">
                {% for fname in files %}
                    <div class="post-gallery-item">
                        <img src="{{ url_for('uploaded_file', filename=fname) }}" data-full-url="{{ url_for('uploaded_file', filename=fname) }}" alt="Image {{ loop.index }} for {{ post.title }}" class="gallery-thumb" />
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="post-image-container">
                <img src="{{ url_for('uploaded_file', filename=files[0]) }}" alt="Post image for {{ post.title }}" class="post-image">
            </div>
        {% endif %}
    {% endif %}

    {# --- Content (unchanged) --- #}
    <div class="post-content-wrapper">
        {% if post.content|length > 150 %}
            <p class="post-content-truncated">{{ post.content|truncate(150, true)|linkify|safe }}</p>
            <p class="post-content-full">{{ post.content|linkify|safe }}</p>
            <a href="#" class="read-more-link read-more-toggle" data-post-id="{{ post._id|string }}">Read More</a>
        {% else %}
            <p>{{ post.content|linkify|safe }}</p>
        {% endif %}
    </div>

    {# --- Timestamp --- #}
    <div class="post-meta">
        Posted by <strong>{{ post.author }}</strong> on
        {% if post.timestamp.strftime %}
            {{ post.timestamp.strftime('%b %d, %Y at %I:%M %p') }}
        {% else %}
            {{ post.timestamp }}
        {% endif %}
    </div>

    {# --- Actions: Comment count + Edit/Delete --- #}
    <div class="post-actions" style="margin-top: 10px;">
        <a href="{{ post.url }}" class="btn comment-btn record-view-link" data-post-id="{{ post._id|string }}">
            Comments
            <span class="comment-count-display">
                {{ post.comment_count if post.comment_count is defined else 0 }}
            </span>
        </a>

        {% if current_user.is_authenticated and (post.author_id|string == current_user.id) %}
            <a href="{{ url_for('edit_post', post_id=post._id, action='edit') }}"
               class="btn edit-btn">Edit</a>

            <form action="{{ url_for('delete_post', post_id=post._id) }}"
                  method="POST"
                  class="delete-post-form"
                  style="display: inline;">
                <button type="submit" class="btn delete-btn">Delete</button>
            </form>
        {% endif %}
    </div>
</div>
{% endmacro %}
