{% extends "base.html" %}

{% block title %}
<title>{{ title }}</title>
<meta name="description" content="{{ description }}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <style>
        .personal-space-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #3e2217 0%, #5a3328 100%);
            border-radius: 12px;
            color: white;
        }

        .personal-space-header h1 {
            color: white;
            margin: 0 0 0.5rem 0;
        }

        .personal-space-header p {
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        .personal-space-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        /* Strong, high-contrast styles for header stats */
        .personal-space-header .stat-number,
        .personal-space-header .stat-label {
            color: #fff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.35);
        }

        .personal-space-header .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .personal-space-header .stat-label {
            font-size: 0.85rem;
            font-weight: 600;
            opacity: 0.95;
        }

        .tab-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .tab-nav button {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-nav button:hover {
            color: #333;
            background: #f5f5f5;
        }

        .tab-nav button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-nav button .badge {
            background: #eee;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .tab-nav button.active .badge {
            background: var(--primary-color);
            color: white;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Card styles for saved posts */
        .saved-post-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .saved-post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .saved-post-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #f0f0f0;
            flex-shrink: 0;
        }

        .saved-post-thumb-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            flex-shrink: 0;
        }

        .saved-post-info {
            flex: 1;
            min-width: 0;
        }

        .saved-post-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            line-height: 1.3;
        }

        .saved-post-title a {
            color: #333;
            text-decoration: none;
        }

        .saved-post-title a:hover {
            color: var(--primary-color);
        }

        .saved-post-meta {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .saved-post-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-icon {
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            transition: background 0.2s;
        }

        .btn-view {
            background: #e8f4fd;
            color: #1976d2;
        }

        .btn-view:hover {
            background: #d0e8f9;
        }

        .btn-remove {
            background: #ffebee;
            color: #d32f2f;
        }

        .btn-remove:hover {
            background: #ffcdd2;
        }

        /* Note card styles */
        .note-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border-left: 4px solid var(--primary-color);
            position: relative;
        }

        .note-card.pinned {
            border-left-color: #ffc107;
            background: #fffdf5;
        }

        .note-content {
            word-break: break-word;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        /* Markdown rendered content styles */
        .note-content h1,
        .note-content h2,
        .note-content h3 {
            margin: 0.5em 0 0.3em 0;
            line-height: 1.3;
        }

        .note-content h1 {
            font-size: 1.4rem;
        }

        .note-content h2 {
            font-size: 1.2rem;
        }

        .note-content h3 {
            font-size: 1.1rem;
        }

        .note-content p {
            margin: 0.5em 0;
        }

        .note-content ul,
        .note-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .note-content li {
            margin: 0.25em 0;
        }

        .note-content blockquote {
            border-left: 3px solid var(--primary-color);
            margin: 0.5em 0;
            padding: 0.5em 1em;
            background: #f9f9f9;
            color: #555;
        }

        .note-content code {
            background: #f4f4f4;
            padding: 0.15em 0.4em;
            border-radius: 3px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .note-content pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .note-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .note-content a {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 1.5rem 0;
            border-radius: 8px;
            border: 1px solid #eee;
            background: white;
            width: 100%;
        }

        .note-content table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.95em;
        }

        .note-content th,
        .note-content td {
            border: 1px solid #ccc;
            padding: 0.5em 0.75em;
            text-align: left;
            min-width: 150px;
            max-width: 500px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .note-content th {
            background: #f0f0f0;
            font-weight: 600;
        }

        .note-content tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .note-content tbody tr:hover {
            background: #f5f5f5;
        }

        /* === CRITICAL: Reset styles for KaTeX internal tables === */
        /* KaTeX uses <table> elements internally for fractions, matrices, etc. */
        /* Without these resets, math renders with data-table borders/backgrounds */
        .note-content .katex table,
        .note-content .katex-display table {
            border-collapse: initial;
            display: inline-table;
            margin: 0;
            border: none;
            overflow: visible;
            font-size: inherit;
            width: auto;
        }

        .note-content .katex td,
        .note-content .katex th,
        .note-content .katex-display td,
        .note-content .katex-display th {
            border: none;
            padding: 0;
            background: none !important;
            white-space: nowrap;
        }

        .note-content .katex tr,
        .note-content .katex-display tr {
            background: none !important;
        }

        .note-content .katex tr:hover,
        .note-content .katex-display tr:hover {
            background: none !important;
        }

        /* KaTeX inside data tables */
        .note-content td .katex,
        .note-content th .katex {
            font-size: 1em;
        }

        .note-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 1em 0;
        }

        /* Math (KaTeX) styles */
        .note-content .katex-display {
            margin: 0.5em 0;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
        }

        .note-content .katex {
            font-size: 1.1em;
        }

        /* Ensure inline KaTeX doesn't break layout */
        .note-content .katex-html {
            white-space: nowrap;
        }




        .note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        .note-date {
            font-size: 0.8rem;
            color: #999;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
        }

        .note-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            color: #666;
            font-size: 0.85rem;
        }

        .note-actions button:hover {
            background: #f5f5f5;
        }

        .note-actions .delete-btn:hover {
            background: #ffebee;
            color: #d32f2f;
        }

        .note-actions .edit-note-btn:hover {
            color: #1565c0;
            background: #e3f2fd;
        }

        .note-actions .sync-note-btn {
            color: #2e7d32;
        }

        .note-actions .sync-note-btn:hover {
            background: #e8f5e9;
            color: #1b5e20;
        }

        .note-actions .sync-note-btn.syncing {
            pointer-events: none;
            opacity: 0.6;
        }

        /* Source badge for saved/cloned notes */
        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 20px;
            padding: 0.15rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Edit modal */
        .edit-note-textarea {
            width: 100%;
            min-height: 150px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.75rem;
            resize: vertical;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
        }

        .edit-note-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(62, 34, 23, 0.1);
        }

        .edit-char-count {
            font-size: 0.8rem;
            color: #999;
            text-align: right;
            margin-top: 0.3rem;
        }

        /* Create note form */
        .create-note-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .create-note-card textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.75rem;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 1rem;
        }

        .create-note-card textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(62, 34, 23, 0.1);
        }

        .create-note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .char-count {
            font-size: 0.8rem;
            color: #999;
        }

        .char-count.warning {
            color: #f57c00;
        }

        .char-count.danger {
            color: #d32f2f;
        }

        /* Preview toggle */
        .preview-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #666;
            cursor: pointer;
            user-select: none;
        }

        .preview-toggle input {
            cursor: pointer;
        }

        .note-preview {
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            min-height: 80px;
            max-height: 300px;
            overflow-y: auto;
        }

        .note-preview.active {
            display: block;
        }

        .note-preview-label {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .format-hint {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.5rem;
        }

        .format-hint code {
            background: #f0f0f0;
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-size: 0.85em;
        }

        /* Quick actions */
        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            flex: 1;
            min-width: 140px;
            padding: 1rem;
            border: 2px dashed #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            text-decoration: none;
            color: #666;
        }

        .quick-action-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: #faf8f7;
        }

        .quick-action-btn i {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #888;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 0.5rem;
        }

        /* Search/filter */
        .search-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .search-filter input {
            flex: 1;
            padding: 0.6rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .search-filter input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Note Search Styles */
        .note-search-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .note-search-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 0.5rem 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .note-search-bar:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(62, 34, 23, 0.08);
        }

        .note-search-bar i.search-icon {
            color: #999;
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .note-search-bar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.95rem;
            padding: 0.3rem 0;
            background: transparent;
        }

        .note-search-bar input::placeholder {
            color: #bbb;
        }

        .note-search-bar .search-clear {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 0.2rem;
            font-size: 0.85rem;
            display: none;
            transition: color 0.2s;
        }

        .note-search-bar .search-clear:hover {
            color: #d32f2f;
        }

        .note-search-bar .search-clear.visible {
            display: inline-flex;
        }

        .note-search-hint {
            font-size: 0.72rem;
            color: #aaa;
            margin-top: 0.3rem;
            padding-left: 0.25rem;
        }

        .note-search-hint code {
            background: #f0f0f0;
            padding: 0.05em 0.3em;
            border-radius: 3px;
            font-size: 0.85em;
        }

        .note-search-status {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.75rem;
            font-size: 0.85rem;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .note-search-status.visible {
            display: flex;
        }

        .note-search-status .search-stats {
            margin-left: auto;
            font-size: 0.75rem;
            color: #aaa;
        }

        .search-results-container {
            display: none;
        }

        .search-results-container.visible {
            display: block;
        }

        .search-result-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border-left: 4px solid #e8a87c;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .search-result-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .search-result-snippet {
            font-size: 0.92rem;
            color: #444;
            line-height: 1.6;
            word-break: break-word;
        }

        .search-result-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.78rem;
            color: #999;
        }

        /* Highlighted match in search results */
        mark.search-highlight,
        .search-result-snippet mark.search-highlight {
            background: linear-gradient(120deg, #fff3cd 0%, #ffe69c 100%);
            color: #333;
            padding: 0.05em 0.2em;
            border-radius: 3px;
            font-weight: 600;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        .note-card.search-active-match {
            animation: searchPulse 1.5s ease;
            box-shadow: 0 0 0 3px rgba(232, 168, 124, 0.5);
        }

        @keyframes searchPulse {
            0% { box-shadow: 0 0 0 0 rgba(232, 168, 124, 0.6); }
            50% { box-shadow: 0 0 0 6px rgba(232, 168, 124, 0.2); }
            100% { box-shadow: 0 0 0 3px rgba(232, 168, 124, 0.5); }
        }

        /* Mobile optimizations */
        @media (max-width: 600px) {
            .personal-space-header {
                padding: 1rem;
            }

            .personal-space-stats {
                gap: 1rem;
            }

            .tab-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .tab-nav::-webkit-scrollbar {
                display: none;
            }

            .tab-nav button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                white-space: nowrap;
            }

            .saved-post-card {
                flex-direction: column;
            }

            .saved-post-thumb,
            .saved-post-thumb-placeholder {
                width: 100%;
                height: 120px;
            }

            .quick-action-btn {
                min-width: 100px;
                padding: 0.75rem;
            }

            .quick-action-btn i {
                font-size: 1.25rem;
            }


        }

        /* --- Sharing UI Styles --- */
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #666;
            transition: color 0.2s;
            font-size: 1.1rem;
        }

        .share-note-btn:hover {
            color: #3e2217;
        }

        .share-link-item {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-bottom: 0.5rem;
        }

        .share-link-url {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .share-link-url input {
            flex: 1;
            padding: 0.3rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            background: #fff;
        }

        .share-link-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #777;
        }

        /* --- Offline Sync Styles --- */
        .offline-banner {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1rem;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 1rem;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .offline-banner.offline {
            display: flex;
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #e65100;
            border: 1px solid #ffcc80;
        }

        .offline-banner.syncing {
            display: flex;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        .offline-banner i {
            font-size: 1rem;
        }

        .pending-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: #fff3e0;
            color: #e65100;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid #ffcc80;
        }

        .pending-badge i {
            font-size: 0.65rem;
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .note-card.pending-note {
            border-left: 3px solid #ff9800;
            opacity: 0.9;
        }
    </style>

    <!-- Header with stats -->
    <div class="personal-space-header">
        <h1>My Personal Space</h1>
        <p>Your private area for saved posts and personal notes</p>
        <div class="personal-space-stats">
            <div class="stat-item">
                <div class="stat-number">{{ saved_posts|length }}</div>
                <div class="stat-label">Saved Posts</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ personal_posts|length }}</div>
                <div class="stat-label">Notes</div>
            </div>
        </div>
        <div class="encrypt-note" aria-hidden="true">
            <i class="fas fa-lock"></i> Notes are end-to-end encrypted
        </div>
        <style>
            .encrypt-note {
                margin-top: 1rem;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                background: rgba(255, 255, 255, 0.12);
                padding: 0.4rem 0.8rem;
                border-radius: 20px;
                font-size: 0.85rem;
                color: #fff;
            }

            .encrypt-note i {
                color: #fff;
            }
        </style>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{{ url_for('blog') }}" class="quick-action-btn">
            <i class="fas fa-compass"></i>
            Explore Posts
        </a>
        <button type="button" id="quick-create-note" class="quick-action-btn">
            <i class="fas fa-sticky-note"></i>
            Create a Note
        </button>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav" role="tablist">
        <button data-tab="saved" role="tab" aria-selected="false">
            Saved Posts
            <span class="badge">{{ saved_posts|length }}</span>
        </button>
        <button class="active" data-tab="notes" role="tab" aria-selected="true">
            Notes
            <span class="badge">{{ personal_posts|length }}</span>
        </button>
    </div>

    <!-- Saved Posts Tab -->
    <div id="tab-saved" class="tab-panel" role="tabpanel">
        {% if saved_posts %}
        <div class="search-filter">
            <input type="text" id="saved-search" placeholder="Search saved posts..." aria-label="Search saved posts">
        </div>
        <div class="saved-posts-list" id="saved-posts-container">
            {% for post in saved_posts %}
            <div class="saved-post-card" data-title="{{ post.title|lower }}" data-author="{{ post.author|lower }}">
                {% if post.image_urls and post.image_urls|length > 0 %}
                <img src="{{ post.image_urls[0] }}" alt="" class="saved-post-thumb" loading="lazy">
                {% elif post.image_url %}
                <img src="{{ post.image_url }}" alt="" class="saved-post-thumb" loading="lazy">
                {% else %}
                <div class="saved-post-thumb-placeholder">
                    <i class="fas fa-file-alt"></i>
                </div>
                {% endif %}
                <div class="saved-post-info">
                    <h3 class="saved-post-title">
                        <a href="{{ url_for('view_post', slug=post.slug) }}">{{ post.title }}</a>
                    </h3>
                    <div class="saved-post-meta">
                        <i class="fas fa-user"></i> {{ post.author }} &bull;
                        <i class="fas fa-calendar"></i> {{ post.timestamp|localtime('%b %d, %Y') }}
                        {% if post.view_count %}
                        &bull; <i class="fas fa-eye"></i> {{ post.view_count }}
                        {% endif %}
                    </div>
                    <div class="saved-post-actions">
                        <a href="{{ url_for('view_post', slug=post.slug) }}" class="btn-icon btn-view">
                            <i class="fas fa-arrow-right"></i> Read
                        </a>
                        <form action="{{ url_for('toggle_save_post', post_id=post._id) }}" method="POST"
                            style="display:inline;" class="unsave-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn-icon btn-remove">
                                <i class="fas fa-bookmark"></i> Unsave
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="far fa-bookmark"></i>
            <h3>No saved posts yet</h3>
            <p>Save posts you want to read later by clicking the bookmark icon on any post.</p>
            <a href="{{ url_for('blog') }}" class="btn comment-btn" style="margin-top: 1rem;">Explore Posts</a>
        </div>
        {% endif %}
    </div>

    <!-- Notes Tab -->
    <div id="tab-notes" class="tab-panel active" role="tabpanel">
        <!-- Offline Status Banner -->
        <div id="offline-banner" class="offline-banner">
            <i class="fas fa-wifi-slash"></i>
            <span id="offline-banner-text">You're offline ‚Äî notes will sync when you reconnect</span>
        </div>
        <div id="pending-notes-container"></div>
        <div class="create-note-card">
            <div
                style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; color: #666; font-size: 0.85rem;">
                Your notes are encrypted and only visible to you
            </div>
            <form action="{{ url_for('create_personal_post') }}" method="POST" id="create-note-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <textarea name="content" id="note-input" placeholder="Write a private note.." maxlength="8000"
                    required></textarea>
                <div class="format-hint">
                    Supports: <code>**bold**</code> <code>*italic*</code> <code>`code`</code> <code>$math$</code>
                    <code>$$block math$$</code>
                </div>
                <div class="create-note-footer">
                    <span class="char-count"><span id="char-count">0</span>/8000</span>
                    <label class="preview-toggle">
                        <input type="checkbox" id="preview-toggle">
                        Preview
                    </label>
                    <button type="submit" class="btn comment-btn" id="add-note-btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </div>
                <div class="note-preview" id="note-preview">
                    <div class="note-preview-label"> Preview</div>
                    <div class="note-content" id="preview-content"></div>
                </div>
            </form>
        </div>

        {% if personal_posts %}
        <!-- Note Search -->
        <div class="note-search-wrapper">
            <div class="note-search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="note-search-input" placeholder="Search your notes..." autocomplete="off" aria-label="Search notes">
                <button type="button" class="search-clear" id="note-search-clear" title="Clear search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="note-search-hint">
                Tip: Use <code>"quotes"</code> for exact phrases
            </div>
        </div>

        <div class="note-search-status" id="note-search-status">
            <i class="fas fa-search"></i>
            <span id="note-search-status-text"></span>
            <span class="search-stats" id="note-search-stats"></span>
        </div>

        <div class="search-results-container" id="search-results-container">
        </div>

        <div class="personal-notes-list" id="notes-list-container">
            {% for note in personal_posts %}
            <div class="note-card" data-note-id="{{ note._id }}" {% if note.source_note_id %}data-source-note-id="{{ note.source_note_id }}"{% endif %} {% if note.source_share_id %}data-source-share-id="{{ note.source_share_id }}"{% endif %}>
                <div class="note-content rendered-note" data-raw="{{ note.content | e }}"></div>
                <div class="note-footer">
                    <span class="note-date">
                        <i class="far fa-clock"></i>
                        {{ note.created_at|localtime }}
                        {% if note.source_note_id %}
                        <span class="source-badge" title="Saved from a shared note">
                             Saved copy
                        </span>
                        {% endif %}
                    </span>
                    {% set note_id_str = note._id|string %}
                    {% if active_shares_map.get(note_id_str) %}
                    <div class="active-links-badge"
                        style="position: relative; display: inline-flex; align-items: center;">
                        <button type="button" class="active-link-toggle"
                            style="background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 20px; padding: 0.2rem 0.6rem; font-size: 0.72rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.3rem;"
                            title="This note has active share links ‚Äî click to view or manage them">
                            <i class="fas fa-link"></i> {{ active_shares_map[note_id_str]|length }} Shared Link{{ 's' if
                            active_shares_map[note_id_str]|length > 1 }}
                        </button>
                        <div class="share-dropdown"
                            style="display: none; position: absolute; top: 100%; right: 0; margin-top: 0.4rem; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 0.5rem; min-width: 260px; z-index: 100;">
                            {% for share in active_shares_map[note_id_str] %}
                            <div class="share-link-item"
                                style="display: flex; align-items: center; gap: 0.4rem; padding: 0.4rem; border-radius: 8px; background: #f9f9f9; margin-bottom: 0.3rem; font-size: 0.78rem;">
                                <span
                                    style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #555;">
                                    {% if share.surprise_theme != 'none' %}<i class="fas fa-gift"
                                        style="color: #ff4d6d;"></i>{% endif %}
                                    <i class="fas fa-{{ 'pen' if share.permissions == 'edit' else 'eye' }}"
                                        style="color: #888; margin-right: 2px;"
                                        title="{{ share.permissions }} access"></i>
                                    {{ share.share_url[-20:] }}
                                </span>
                                <button type="button" class="copy-btn" data-copy-text="{{ share.share_url }}"
                                    title="Copy link"
                                    style="background: #3e2217; color: white; border: none; border-radius: 6px; padding: 0.25rem 0.5rem; font-size: 0.7rem; cursor: pointer;">
                                    <i class="far fa-copy"></i>
                                </button>
                                <button type="button" class="revoke-btn" data-share-id="{{ share.share_id }}"
                                    title="Revoke link"
                                    style="background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; border-radius: 6px; padding: 0.25rem 0.5rem; font-size: 0.7rem; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <div class="note-actions">
                        <button type="button" class="copy-btn" title="Copy note" data-copy-text="{{ note.content }}">
                            <i class="far fa-copy"></i>
                        </button>
                        <button type="button" class="btn-icon edit-note-btn" title="Edit note"
                            data-id="{{ note._id }}" data-raw="{{ note.content | e }}">
                            <i class="fas fa-pen"></i>
                        </button>
                        {% if note.source_note_id and note.source_share_id %}
                        <button type="button" class="btn-icon sync-note-btn" title="Sync with original"
                            data-id="{{ note._id }}" data-source-share-id="{{ note.source_share_id }}">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        {% endif %}
                        <button type="button" class="btn-icon share-note-btn" title="Share note"
                            data-id="{{ note._id }}">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button type="button" class="btn-icon version-history-btn" title="Version history"
                            data-id="{{ note._id }}">
                            <i class="fas fa-clock-rotate-left"></i>
                        </button>
                        {% set nid_str = note._id|string %}
                        <form action="{{ url_for('delete_personal_post', post_id=note._id) }}" method="POST"
                            style="display:inline;" class="delete-note-form"
                            data-has-shares="{{ 'true' if active_shares_map.get(nid_str) else 'false' }}"
                            data-has-clones="{{ 'true' if has_clones_map.get(nid_str) else 'false' }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="delete-btn" title="Delete note">
                                <i class="far fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="far fa-sticky-note"></i>
            <h3>No notes yet</h3>
            <p>Write private notes that only you can see.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Share Note Modal -->
<div id="share-modal" class="custom-modal-overlay" onclick="if(event.target === this) closeShareModal()">
    <div class="custom-modal" style="max-width: 500px; text-align: left;">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: sticky; top: 0; background: white; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; z-index: 10;">
            <h2 style="margin: 0; color: #3e2217; font-size: 1.25rem;">
                <i class="fas fa-share-alt"></i> Share Note
            </h2>
            <button class="btn-icon" onclick="closeShareModal()" style="display: none;"><i
                    class="fas fa-times"></i></button>
        </div>

        <div id="share-config">
            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.9rem;">Permissions</label>
                <select id="share-permissions"
                    style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #ddd; background: #fff;">
                    <option value="view">View Only</option>
                    <option value="edit">Can Edit</option>
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.9rem;">Expiration</label>
                <select id="share-expiry"
                    style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #ddd; background: #fff;">
                    <option value="never">Never</option>
                    <option value="1h">1 Hour</option>
                    <option value="1d">1 Day</option>
                    <option value="7d">7 Days</option>
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.9rem;">Access Code
                    (Optional)</label>
                <input type="text" id="share-code" placeholder="Leave blank for no code"
                    style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #ddd;">
            </div>

            <div style="margin-bottom: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                <label
                    style="display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.9rem; color: #ff4d6d;">
                    <i class="fas fa-gift"></i> Surprise Theme (Optional)
                </label>
                <select id="surprise-theme"
                    style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #ddd; background: #fff;">
                    <option value="none">Standard Note</option>
                    <option value="valentine">Valentine Surprise ‚ù§Ô∏è</option>
                    <option value="birthday">Birthday Surprise üéÇ</option>
                    <option value="anniversary">Anniversary Surprise üíç</option>
                    <option value="celebration">Celebration/Generic Surprise üéâ</option>
                </select>

                <div id="surprise-options"
                    style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #fff5f7; border-radius: 12px; border: 1px dashed #ff4d6d;">
                    <div style="margin-bottom: 0.75rem;">
                        <label
                            style="display: block; margin-bottom: 0.3rem; font-size: 0.85rem; font-weight: 600; color: #666;">
                            <i class="fas fa-image"></i> Personal Photo (Optional)
                        </label>
                        <input type="file" id="share-surprise-photo" accept="image/*"
                            style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ddd; font-size: 0.8rem; background: #fff;">
                    </div>
                    <div>
                        <label
                            style="display: block; margin-bottom: 0.3rem; font-size: 0.85rem; font-weight: 600; color: #666;">
                            <i class="fas fa-music"></i> Background Music (Optional)
                        </label>
                        <input type="file" id="share-surprise-audio" accept="audio/*"
                            style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ddd; font-size: 0.8rem; background: #fff;">
                    </div>
                    <div style="margin-top: 0.75rem;">
                        <label
                            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: 600; color: #666; cursor: pointer;">
                            <input type="checkbox" id="use-typewriter"
                                style="accent-color: #ff4d6d; width: 16px; height: 16px;">
                            <i class="fas fa-keyboard"></i> Typewriter Effect
                        </label>
                        <small style="color: #999; font-size: 0.75rem; margin-left: 1.6rem; display: block;">Text
                            reveals letter by letter for a personal touch</small>
                    </div>
                </div>
            </div>



            <div id="share-upload-progress" style="display: none; margin-bottom: 1rem;">
                <div style="height: 6px; background: #eee; border-radius: 3px; overflow: hidden;">
                    <div id="share-progress-bar"
                        style="width: 0%; height: 100%; background: #3e2217; transition: width 0.3s;"></div>
                </div>
                <div id="share-progress-text"
                    style="font-size: 0.75rem; color: #666; margin-top: 0.3rem; text-align: center;">Uploading: 0%</div>
            </div>

            <button id="generate-share-link" class="btn comment-btn"
                style="width: 100%; padding: 0.75rem; font-weight: 600; border-radius: 8px;">
                Generate Share Link
            </button>
        </div>

        <div id="active-shares-container" style="margin-top: 1.5rem; display: none;">
            <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 1rem;">Active
                Links</label>
            <div id="share-links-list"></div>
        </div>
    </div>
</div>

<!-- Note Deletion Mode Modal -->
<div id="delete-note-modal" class="custom-modal-overlay" onclick="if(event.target === this) closeDeleteModal()">
    <div class="custom-modal" style="max-width: 450px; text-align: left;">
        <div style="margin-bottom: 1.5rem;">
            <h3 style="color: #3e2217; margin-bottom: 0.5rem;"><i class="fas fa-trash-alt"></i> Delete Note</h3>
            <p id="delete-modal-msg" style="color: #666; font-size: 0.95rem; line-height: 1.4;"></p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <button id="confirm-delete-me" class="btn"
                style="padding: 0.8rem; background: #f8f9fa; color: #333; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; text-align: left; transition: background 0.2s;">
                <div style="font-weight: 600;"><i class="fas fa-user-minus"></i> Delete for Me</div>
                <div style="opacity: 0.7; font-size: 0.75rem; font-weight: 400; margin-left: 1.6rem;">Removes it
                    from your personal space only.</div>
            </button>
            <button id="confirm-delete-everyone" class="btn delete-btn"
                style="padding: 0.8rem; border-radius: 8px; cursor: pointer; text-align: left; display: none;">
                <div style="font-weight: 600;"><i class="fas fa-users-slash"></i> Delete for Everyone</div>
                <div style="opacity: 0.8; font-size: 0.75rem; font-weight: 400; margin-left: 1.6rem;">Purges
                    original and all saved copies platform-wide.</div>
            </button>
            <button onclick="closeDeleteModal()" class="btn edit-btn"
                style="margin-top: 0.5rem; padding: 0.6rem; border-radius: 8px; cursor: pointer;">Cancel</button>
        </div>
    </div>
</div>

<!-- Edit Note Modal -->
<div id="edit-note-modal" class="custom-modal-overlay" onclick="if(event.target === this) closeEditModal()">
    <div class="custom-modal" style="max-width: 600px; text-align: left;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0; color: #3e2217; font-size: 1.25rem;">
                <i class="fas fa-pen"></i> Edit Note
            </h2>
            <button class="btn-icon" onclick="closeEditModal()"><i class="fas fa-times"></i></button>
        </div>
        <textarea id="edit-note-content" class="edit-note-textarea" maxlength="8000" placeholder="Edit your note..."></textarea>
        <div class="edit-char-count"><span id="edit-char-count">0</span>/8000</div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
            <button onclick="closeEditModal()" class="btn edit-btn" style="padding: 0.6rem 1.2rem; border-radius: 8px;">Cancel</button>
            <button id="save-edit-btn" class="btn comment-btn" style="padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600;">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>
</div>

<!-- KaTeX for math rendering -->

<!-- Version History Modal -->
<div id="version-modal" class="custom-modal-overlay" onclick="if(event.target === this) closeVersionModal()">
        <div class="custom-modal" style="max-width: 600px; text-align: left; max-height: 80vh; overflow-y: auto;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: sticky; top: 0; background: white; padding-bottom: 0.5rem; border-bottom: 1px solid #eee;">
                <h2 style="margin: 0; color: #3e2217; font-size: 1.25rem;">
                    <i class="fas fa-clock-rotate-left"></i> Version History
                </h2>
                <button class="btn-icon" onclick="closeVersionModal()"><i class="fas fa-times"></i></button>
            </div>
            <div id="version-list" style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="text-align: center; color: #999; padding: 2rem;">Loading...</div>
            </div>
        </div>
    </div>

    <style>
        .version-card {
            background: #faf7f4;
            border-radius: 10px;
            padding: 1rem;
            border-left: 3px solid #3e2217;
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .version-editor {
            font-weight: 600;
            color: #3e2217;
            font-size: 0.9rem;
        }

        .version-time {
            font-size: 0.8rem;
            color: #999;
        }

        .version-preview {
            font-size: 0.85rem;
            color: #555;
            line-height: 1.5;
            max-height: 100px;
            overflow: hidden;
            white-space: pre-wrap;
            word-break: break-word;
            position: relative;
        }

        .version-preview.expanded {
            max-height: none;
        }

        .version-toggle {
            background: none;
            border: none;
            color: #3e2217;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.25rem 0;
            font-weight: 600;
        }

        .version-toggle:hover {
            text-decoration: underline;
        }

        .version-empty {
            text-align: center;
            color: #999;
            padding: 2rem;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Marked.js for markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <!-- DOMPurify for sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <script>
        // --- Immediate Event Handlers & Global Helpers ---
        (function () {
            // Helper Functions (Exposed to Window for global access)
            window.handleDeleteModalEsc = function (e) {
                if (e.key === 'Escape') window.closeDeleteModal();
            };

            window.openDeleteModal = function (hasShares, hasClones) {
                const modal = document.getElementById('delete-note-modal');
                const everyoneBtn = document.getElementById('confirm-delete-everyone');
                const msgEl = document.getElementById('delete-modal-msg');
                if (modal) {
                    // Show "Delete for Everyone" only if note has active shares or clones
                    const showEveryone = hasShares || hasClones;
                    if (everyoneBtn) everyoneBtn.style.display = showEveryone ? '' : 'none';
                    if (msgEl) {
                        msgEl.textContent = showEveryone
                            ? 'Choose how you want to delete this note. "Delete for Everyone" will attempt to purge all copies of this note that others may have saved.'
                            : 'Are you sure you want to delete this note? This action cannot be undone.';
                    }
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    document.addEventListener('keydown', window.handleDeleteModalEsc);
                }
            };

            window.closeDeleteModal = function () {
                const modal = document.getElementById('delete-note-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    document.removeEventListener('keydown', window.handleDeleteModalEsc);
                }
            };

            // Edit modal helpers
            window.handleEditModalEsc = function (e) {
                if (e.key === 'Escape') window.closeEditModal();
            };

            window.currentEditNoteId = null;

            window.openEditModal = function (noteId, content) {
                const modal = document.getElementById('edit-note-modal');
                const textarea = document.getElementById('edit-note-content');
                const charCount = document.getElementById('edit-char-count');
                if (modal && textarea) {
                    window.currentEditNoteId = noteId;
                    textarea.value = content;
                    if (charCount) charCount.textContent = content.length;
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    textarea.focus();
                    document.addEventListener('keydown', window.handleEditModalEsc);
                }
            };

            window.closeEditModal = function () {
                const modal = document.getElementById('edit-note-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    window.currentEditNoteId = null;
                    document.removeEventListener('keydown', window.handleEditModalEsc);
                }
            };

            window.openVersionModal = function (noteId) {
                const modal = document.getElementById('version-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    if (window.loadVersionHistory) window.loadVersionHistory(noteId);
                    document.addEventListener('keydown', window.handleVersionModalEsc);
                }
            };

            window.closeVersionModal = function () {
                const modal = document.getElementById('version-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    document.removeEventListener('keydown', window.handleVersionModalEsc);
                }
            };

            window.handleVersionModalEsc = function (e) {
                if (e.key === 'Escape') window.closeVersionModal();
            };

            window.loadVersionHistory = async function (noteId) {
                const list = document.getElementById('version-list');
                if (!list) return;

                list.innerHTML = '<div style="text-align: center; color: #999; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

                try {
                    const response = await fetch(`/personal_post/versions/${noteId}`);
                    const versions = await response.json();

                    if (!Array.isArray(versions) || versions.length === 0) {
                        list.innerHTML = '<div class="version-empty"><i class="fas fa-clock-rotate-left" style="font-size: 2rem; margin-bottom: 0.5rem; display: block; opacity: 0.4;"></i>No edit history yet.<br><small style="color: #bbb;">Versions are recorded when someone edits via a shared link.</small></div>';
                        return;
                    }

                    list.innerHTML = versions.map((v, i) => {
                        const ts = v.created_at ? new Date(v.created_at).toLocaleString() : 'Unknown';
                        const preview = (v.content || '').substring(0, 200);
                        const hasMore = (v.content || '').length > 200;
                        return `
                        <div class="version-card">
                            <div class="version-header">
                                <span class="version-editor"><i class="fas fa-user-edit"></i> ${v.editor_name}</span>
                                <span class="version-time">${ts}</span>
                            </div>
                            <div class="version-preview" id="vp-${i}">${preview.replace(/</g, '&lt;').replace(/>/g, '&gt;')}${hasMore ? '...' : ''}</div>
                            ${hasMore ? `<button class="version-toggle" onclick="window.toggleVersionPreview('${i}')">Show full content</button>` : ''}
                        </div>
                    `;
                    }).join('');

                    window._versionContents = {};
                    versions.forEach((v, i) => {
                        window._versionContents[i] = v.content || '';
                    });
                } catch (e) {
                    list.innerHTML = '<div class="version-empty" style="color: #d32f2f;">Failed to load version history.</div>';
                    console.error('Error loading versions:', e);
                }
            };

            window.toggleVersionPreview = function (index) {
                const el = document.getElementById(`vp-${index}`);
                const btn = el.parentElement.querySelector('.version-toggle');
                if (!el || !btn) return;

                if (el.classList.contains('expanded')) {
                    el.classList.remove('expanded');
                    const preview = (window._versionContents[index] || '').substring(0, 200);
                    el.textContent = preview + '...';
                    btn.textContent = 'Show full content';
                } else {
                    el.classList.add('expanded');
                    el.textContent = window._versionContents[index] || '';
                    btn.textContent = 'Show less';
                }
            };

            window.handleRevoke = async function (revokeBtn) {
                const shareId = revokeBtn.dataset.shareId;
                const confirmMsg = 'Revoke this link? It will immediately stop working.';

                const performRevoke = async () => {
                    revokeBtn.disabled = true;
                    try {
                        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                        const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

                        const response = await fetch(`/personal_post/revoke_share/${shareId}`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken
                            }
                        });
                        const result = await response.json();
                        if (result.success) {
                            // Try to reload shares if we know the note ID
                            // But we might be in a different context.
                            const row = revokeBtn.closest('.share-link-item');
                            if (row) {
                                row.style.opacity = '0.5';
                                row.style.pointerEvents = 'none';
                                setTimeout(() => row.remove(), 500);
                            }
                        } else {
                            alert(result.error || 'Failed to revoke link');
                            revokeBtn.disabled = false;
                        }
                    } catch (err) {
                        console.error('Revoke failed:', err);
                        alert('Network error. Please try again.');
                        revokeBtn.disabled = false;
                    }
                };

                if (typeof window.showCustomConfirm === 'function') {
                    window.showCustomConfirm(confirmMsg, confirmed => {
                        if (confirmed) performRevoke();
                    });
                } else if (confirm(confirmMsg)) {
                    performRevoke();
                }
            };


            // 1. Global Delegated Click Handler
            document.addEventListener('click', (e) => {
                // Edit Note
                const editBtn = e.target.closest('.edit-note-btn');
                if (editBtn) {
                    const noteId = editBtn.dataset.id;
                    const rawContent = editBtn.dataset.raw;
                    // Decode HTML entities
                    const tmp = document.createElement('textarea');
                    tmp.innerHTML = rawContent;
                    window.openEditModal(noteId, tmp.value);
                    return;
                }

                // Sync Note
                const syncBtn = e.target.closest('.sync-note-btn');
                if (syncBtn && !syncBtn.classList.contains('syncing')) {
                    const noteId = syncBtn.dataset.id;
                    window.syncNote(noteId, syncBtn);
                    return;
                }

                // Version History
                const versionBtn = e.target.closest('.version-history-btn');
                if (versionBtn) {
                    const noteId = versionBtn.dataset.id;
                    window.openVersionModal(noteId);
                    return;
                }

                // Copy Buttons
                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) {
                    const text = copyBtn.dataset.copyText;
                    if (text && window.copyShareUrl) window.copyShareUrl(text, copyBtn);
                    return;
                }

                // Share Link Dropdown Toggles
                const toggleBtn = e.target.closest('.active-link-toggle');
                if (toggleBtn) {
                    e.preventDefault();
                    const dropdown = toggleBtn.nextElementSibling;
                    if (!dropdown) return;
                    const isOpen = dropdown.style.display === 'block';
                    document.querySelectorAll('.share-dropdown').forEach(d => d.style.display = 'none');
                    dropdown.style.display = isOpen ? 'none' : 'block';
                    return;
                }

                // Share Revocation
                const revokeBtn = e.target.closest('.revoke-btn');
                if (revokeBtn) {
                    window.handleRevoke(revokeBtn);
                    return;
                }

                // Delete Confirmations (Delegated)
                if (e.target && e.target.id === 'confirm-delete-me' && window.pendingDeleteForm) {
                    const modeInput = document.createElement('input');
                    modeInput.type = 'hidden';
                    modeInput.name = 'mode';
                    modeInput.value = 'me';
                    window.pendingDeleteForm.appendChild(modeInput);
                    window.pendingDeleteForm.submit();
                }
                if (e.target && e.target.id === 'confirm-delete-everyone' && window.pendingDeleteForm) {
                    const modeInput = document.createElement('input');
                    modeInput.type = 'hidden';
                    modeInput.name = 'mode';
                    modeInput.value = 'everyone';
                    window.pendingDeleteForm.appendChild(modeInput);
                    window.pendingDeleteForm.submit();
                }

                // Close open dropdowns when clicking elsewhere
                if (!e.target.closest('.active-links-badge') && !toggleBtn) {
                    document.querySelectorAll('.share-dropdown').forEach(d => d.style.display = 'none');
                }
            });

            // 2. Delete Form Handler
            document.addEventListener('submit', (e) => {
                const form = e.target;
                if (form && form.classList.contains('delete-note-form')) {
                    e.preventDefault();
                    window.pendingDeleteForm = form;
                    const hasShares = form.dataset.hasShares === 'true';
                    const hasClones = form.dataset.hasClones === 'true';
                    if (typeof window.openDeleteModal === 'function') window.openDeleteModal(hasShares, hasClones);
                }
            });

            // Save Edit Handler
            window.saveNoteEdit = async function () {
                const noteId = window.currentEditNoteId;
                const textarea = document.getElementById('edit-note-content');
                const saveBtn = document.getElementById('save-edit-btn');
                if (!noteId || !textarea) return;

                const content = textarea.value.trim();
                if (!content) {
                    alert('Content cannot be empty.');
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

                    const response = await fetch(`/personal_post/edit/${noteId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ content: content })
                    });
                    const result = await response.json();
                    if (result.success) {
                        // Update the note card in-place
                        const noteCard = document.querySelector(`.note-card[data-note-id="${noteId}"]`);
                        if (noteCard) {
                            const contentEl = noteCard.querySelector('.note-content.rendered-note');
                            if (contentEl) {
                                contentEl.setAttribute('data-raw', content);
                                if (typeof renderMarkdownWithMath === 'function') {
                                    contentEl.innerHTML = renderMarkdownWithMath(content);
                                } else {
                                    contentEl.textContent = content;
                                }
                            }
                            // Update edit button data-raw
                            const editBtnEl = noteCard.querySelector('.edit-note-btn');
                            if (editBtnEl) {
                                const tmp = document.createElement('textarea');
                                tmp.textContent = content;
                                editBtnEl.dataset.raw = tmp.innerHTML;
                            }
                            // Update copy button
                            const copyBtnEl = noteCard.querySelector('.copy-btn');
                            if (copyBtnEl) copyBtnEl.dataset.copyText = content;
                        }
                        window.closeEditModal();
                    } else {
                        alert(result.error || 'Failed to save changes.');
                    }
                } catch (err) {
                    console.error('Edit failed:', err);
                    alert('Network error. Please try again.');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            };

            // Sync Note Handler
            window.syncNote = async function (noteId, btn) {
                const icon = btn.querySelector('i');
                btn.classList.add('syncing');
                if (icon) icon.className = 'fas fa-spinner fa-spin';

                try {
                    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

                    const response = await fetch(`/personal_post/sync/${noteId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    });
                    const result = await response.json();
                    if (result.success) {
                        // Update note content in-place
                        const noteCard = document.querySelector(`.note-card[data-note-id="${noteId}"]`);
                        if (noteCard && result.content) {
                            const contentEl = noteCard.querySelector('.note-content.rendered-note');
                            if (contentEl) {
                                contentEl.setAttribute('data-raw', result.content);
                                if (typeof renderMarkdownWithMath === 'function') {
                                    contentEl.innerHTML = renderMarkdownWithMath(result.content);
                                } else {
                                    contentEl.textContent = result.content;
                                }
                            }
                            // Update edit button data-raw
                            const editBtnEl = noteCard.querySelector('.edit-note-btn');
                            if (editBtnEl) {
                                const tmp = document.createElement('textarea');
                                tmp.textContent = result.content;
                                editBtnEl.dataset.raw = tmp.innerHTML;
                            }
                            // Update copy button
                            const copyBtnEl = noteCard.querySelector('.copy-btn');
                            if (copyBtnEl) copyBtnEl.dataset.copyText = result.content;
                        }
                        // Brief success flash
                        if (icon) {
                            icon.className = 'fas fa-check';
                            btn.style.color = '#2e7d32';
                            setTimeout(() => {
                                icon.className = 'fas fa-sync-alt';
                                btn.style.color = '';
                            }, 2000);
                        }
                    } else {
                        alert(result.error || 'Failed to sync note.');
                        if (icon) icon.className = 'fas fa-sync-alt';
                    }
                } catch (err) {
                    console.error('Sync failed:', err);
                    alert('Network error. Please try again.');
                    if (icon) icon.className = 'fas fa-sync-alt';
                } finally {
                    btn.classList.remove('syncing');
                }
            };
        })();

        document.addEventListener('DOMContentLoaded', function () {
            // Function to auto-detect and convert common math patterns to LaTeX
            function autoDetectMath(text) {
                if (!text) return text;



                // Protect code blocks
                const codeBlocks = [];
                text = text.replace(/```[\s\S]*?```/g, (m) => { codeBlocks.push(m); return `%%CODE${codeBlocks.length - 1}%%`; });
                text = text.replace(/`[^`]+`/g, (m) => { codeBlocks.push(m); return `%%CODE${codeBlocks.length - 1}%%`; });

                // Protect EXISTING $...$
                const existingMath = [];
                text = text.replace(/\$\$[\s\S]*?\$\$/g, (m) => { existingMath.push(m); return `%%EXISTING${existingMath.length - 1}%%`; });
                text = text.replace(/\$[^\$]+?\$/g, (m) => { existingMath.push(m); return `%%EXISTING${existingMath.length - 1}%%`; });

                const wrap = (content) => `$${content}$`;

                function extractBracedContent(str, startIndex) {
                    // Skip optional whitespace before the brace
                    let i = startIndex;
                    while (i < str.length && /\s/.test(str[i])) i++;

                    if (str[i] !== '{') return null;
                    let depth = 1;
                    for (let k = i + 1; k < str.length; k++) {
                        if (str[k] === '{') depth++;
                        else if (str[k] === '}') {
                            depth--;
                            if (depth === 0) return { content: str.substring(i + 1, k), endIndex: k };
                        }
                    }
                    return null;
                }

                // Commands sorted by length (longest first) to ensure greedy matching
                // Comprehensive list for math, physics, chemistry, and advanced notation
                const mathCmds = [
                    // === ARROWS & LOGIC ===
                    'longleftrightarrow', 'Longleftrightarrow', 'hookrightarrow', 'hookleftarrow',
                    'leftrightarrow', 'Leftrightarrow', 'longrightarrow', 'Longrightarrow',
                    'longleftarrow', 'Longleftarrow', 'rightarrow', 'Rightarrow', 'leftarrow', 'Leftarrow',
                    'uparrow', 'Uparrow', 'downarrow', 'Downarrow', 'updownarrow', 'Updownarrow',
                    'nearrow', 'searrow', 'swarrow', 'nwarrow', 'mapsto', 'longmapsto',
                    'rightharpoonup', 'rightharpoondown', 'leftharpoonup', 'leftharpoondown',
                    'rightleftharpoons', 'leftrightharpoons', 'curvearrowright', 'curvearrowleft',
                    'circlearrowright', 'circlearrowleft', 'looparrowright', 'looparrowleft',
                    'twoheadrightarrow', 'twoheadleftarrow', 'leadsto',
                    'iff', 'implies', 'impliedby', 'neg', 'lnot', 'wedge', 'land', 'vee', 'lor',
                    'oplus', 'otimes', 'odot', 'ominus', 'oslash',
                    'forall', 'exists', 'nexists', 'therefore', 'because', 'top', 'bot', 'vdash', 'dashv', 'models',

                    // === SET THEORY ===
                    'emptyset', 'varnothing', 'subset', 'subseteq', 'subsetneq', 'supset', 'supseteq', 'supsetneq',
                    'sqsubset', 'sqsubseteq', 'sqsupset', 'sqsupseteq',
                    'cup', 'cap', 'bigcup', 'bigcap', 'setminus', 'smallsetminus',
                    'in', 'notin', 'ni', 'owns',

                    // === RELATIONS & COMPARISONS ===
                    'neq', 'ne', 'leq', 'le', 'geq', 'ge', 'leqslant', 'geqslant',
                    'll', 'gg', 'lll', 'ggg', 'lesssim', 'gtrsim', 'lessgtr', 'gtrless',
                    'prec', 'succ', 'preceq', 'succeq', 'precneq', 'succneq',
                    'approx', 'approxeq', 'thickapprox', 'equiv', 'cong', 'ncong', 'sim', 'simeq', 'nsim',
                    'propto', 'varpropto', 'parallel', 'nparallel', 'perp', 'asymp',
                    'doteq', 'triangleq', 'circeq', 'bumpeq', 'Bumpeq',
                    'coloneq', 'eqcolon', 'coloncolon',

                    // === GREEK LETTERS (lowercase) ===
                    'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'varepsilon', 'zeta', 'eta', 'theta', 'vartheta',
                    'iota', 'kappa', 'varkappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'varpi',
                    'rho', 'varrho', 'sigma', 'varsigma', 'tau', 'upsilon', 'phi', 'varphi', 'chi', 'psi', 'omega',
                    // === GREEK LETTERS (uppercase) ===
                    'Gamma', 'Delta', 'Theta', 'Lambda', 'Xi', 'Pi', 'Sigma', 'Upsilon', 'Phi', 'Psi', 'Omega',

                    // === CALCULUS & ANALYSIS ===
                    'partial', 'nabla', 'grad', 'diverge', 'curl',
                    'int', 'iint', 'iiint', 'iiiint', 'oint', 'oiint', 'oiiint', 'intop', 'smallint',
                    'sum', 'prod', 'coprod', 'bigoplus', 'bigotimes', 'bigodot', 'biguplus', 'bigsqcup',
                    'lim', 'limsup', 'liminf', 'varlimsup', 'varliminf', 'injlim', 'projlim', 'varinjlim', 'varprojlim',
                    'to', 'gets', 'infty',

                    // === FUNCTIONS ===
                    'sin', 'cos', 'tan', 'cot', 'sec', 'csc',
                    'arcsin', 'arccos', 'arctan', 'arccot', 'arcsec', 'arccsc',
                    'sinh', 'cosh', 'tanh', 'coth', 'sech', 'csch',
                    'arcsinh', 'arccosh', 'arctanh', 'arccoth',
                    'log', 'ln', 'lg', 'exp', 'Re', 'Im',
                    'det', 'dim', 'ker', 'coker', 'image', 'rank', 'nullity',
                    'deg', 'gcd', 'lcm', 'hom', 'Hom', 'End', 'Aut', 'Ker', 'Im',
                    'min', 'max', 'sup', 'inf', 'arg', 'sgn', 'sign',
                    'mod', 'bmod', 'pmod',
                    'Pr', 'tr', 'Tr', 'diag', 'erf', 'erfc', 'sinc',

                    // === FRACTIONS & ROOTS ===
                    'frac', 'dfrac', 'tfrac', 'cfrac', 'sfrac', 'nicefrac',
                    'sqrt', 'cbrt', 'root',
                    'binom', 'dbinom', 'tbinom', 'choose',

                    // === ACCENTS & DECORATIONS ===
                    'hat', 'widehat', 'check', 'widecheck', 'tilde', 'widetilde',
                    'acute', 'grave', 'breve', 'bar', 'overline', 'underline',
                    'vec', 'overrightarrow', 'overleftarrow', 'overleftrightarrow',
                    'underrightarrow', 'underleftarrow', 'underleftrightarrow',
                    'dot', 'ddot', 'dddot', 'ddddot', 'mathring',
                    'overbrace', 'underbrace', 'overgroup', 'undergroup',
                    'overlinesegment', 'underlinesegment',
                    'boxed', 'cancel', 'bcancel', 'xcancel', 'cancelto', 'sout', 'not',

                    // === PHYSICS & VECTORS ===
                    'hbar', 'planck', 'hslash',
                    'ell', 'wp', 'aleph', 'beth', 'gimel', 'daleth',
                    'Angstrom', 'AA',
                    'degree', 'celsius', 'ohm', 'micro', 'angstrom',
                    'vec', 'bm', 'boldsymbol', 'pmb',
                    'tensor', 'ketbra', 'braket', 'Bra', 'Ket', 'bra', 'ket', 'dyad',
                    'mel', 'matrixel', 'ev', 'expectationvalue',
                    'commutator', 'anticommutator', 'poissonbracket',
                    'dd', 'dv', 'pdv', 'var', 'fdv', 'abs', 'norm', 'eval', 'order',
                    'gradient', 'divergence', 'laplacian',
                    'cross', 'vdot', 'vectorbold', 'vectorarrow', 'vectorunit',
                    'qty', 'quantity', 'pqty', 'bqty', 'vqty', 'Bqty', 'absolutevalue',

                    // === MATRICES & LINEAR ALGEBRA ===
                    'begin', 'end', 'matrix', 'pmatrix', 'bmatrix', 'Bmatrix', 'vmatrix', 'Vmatrix',
                    'smallmatrix', 'array', 'cases', 'rcases', 'dcases',
                    'aligned', 'gathered', 'split', 'multline', 'equation', 'align',

                    // === SPACING ===
                    'quad', 'qquad', 'thinspace', 'medspace', 'thickspace', 'negthinspace', 'negmedspace', 'negthickspace',
                    'enspace', 'space', 'nobreakspace',

                    // === DOTS & MISC SYMBOLS ===
                    'cdot', 'cdots', 'ldots', 'dots', 'vdots', 'ddots', 'iddots', 'dotsb', 'dotsc', 'dotsi', 'dotsm', 'dotso',
                    'times', 'div', 'pm', 'mp', 'ast', 'star', 'circ', 'bullet', 'diamond', 'lozenge',
                    'dagger', 'ddagger', 'amalg',
                    'triangle', 'triangledown', 'triangleleft', 'triangleright',
                    'bigtriangleup', 'bigtriangledown', 'vartriangle', 'blacktriangle', 'blacktriangledown',
                    'square', 'blacksquare', 'Box', 'Diamond',
                    'checkmark', 'maltese', 'clubsuit', 'diamondsuit', 'heartsuit', 'spadesuit',
                    'sharp', 'flat', 'natural',
                    'surd', 'angle', 'measuredangle', 'sphericalangle',
                    'prime', 'backprime', 'dprime', 'trprime', 'qprime',

                    // === DELIMITERS ===
                    'left', 'right', 'bigl', 'bigr', 'Bigl', 'Bigr', 'biggl', 'biggr', 'Biggl', 'Biggr',
                    'langle', 'rangle', 'lang', 'rang',
                    'lfloor', 'rfloor', 'lceil', 'rceil',
                    'lvert', 'rvert', 'lVert', 'rVert',
                    'lbrace', 'rbrace', 'lbrack', 'rbrack',
                    'ulcorner', 'urcorner', 'llcorner', 'lrcorner',
                    'llbracket', 'rrbracket', 'lmoustache', 'rmoustache',

                    // === TEXT & FORMATTING ===
                    'text', 'textbf', 'textit', 'textrm', 'textsf', 'texttt', 'textup', 'textsl', 'textsc',
                    'mathbf', 'mathit', 'mathrm', 'mathsf', 'mathtt', 'mathcal', 'mathbb', 'mathfrak', 'mathscr',
                    'bm', 'bold', 'boldsymbol', 'pmb',
                    'rm', 'bf', 'it', 'sf', 'tt', 'cal', 'scr', 'frak', 'Bbb',
                    'operatorname', 'DeclareMathOperator',
                    'displaystyle', 'textstyle', 'scriptstyle', 'scriptscriptstyle',
                    'tiny', 'small', 'normalsize', 'large', 'Large', 'LARGE', 'huge', 'Huge',
                    'color', 'textcolor', 'colorbox', 'fcolorbox',
                    'hspace', 'vspace', 'kern', 'mkern', 'mskip', 'hskip', 'rule', 'Rule', 'phantom', 'vphantom', 'hphantom',

                    // === CHEMISTRY (basic) ===
                    'ce', 'pu', 'bond', 'arrow',

                    // === NUMBER SETS ===
                    'N', 'Z', 'Q', 'R', 'C', 'H', 'O', 'F', 'P'
                ];
                const cmdRegex = new RegExp('\\\\{1,4}(' + mathCmds.join('|') + ')(?![a-zA-Z])', 'g');

                let result = '';
                let lastIdx = 0;
                let match;

                // Commands that take two braced arguments like \frac{a}{b}
                const twoArgCmds = ['frac', 'dfrac', 'tfrac', 'cfrac', 'binom', 'dbinom', 'tbinom', 'overset', 'underset', 'stackrel'];
                // Commands that take one braced argument (or optional + braced)
                const oneArgCmds = ['sqrt', 'cbrt', 'hat', 'bar', 'vec', 'dot', 'ddot', 'tilde', 'widehat', 'widetilde',
                    'overline', 'underline', 'overbrace', 'underbrace', 'boxed', 'cancel', 'bcancel', 'xcancel',
                    'text', 'textbf', 'textit', 'textrm', 'mathbf', 'mathit', 'mathrm', 'mathcal', 'mathbb', 'mathfrak', 'mathscr',
                    'bm', 'boldsymbol', 'operatorname', 'color', 'textcolor', 'phantom', 'abs', 'norm'];

                while ((match = cmdRegex.exec(text)) !== null) {
                    result += text.substring(lastIdx, match.index);
                    const cmd = match[1];
                    let matchedWhole = false;

                    if (twoArgCmds.includes(cmd)) {
                        // Handle two-argument commands like \frac{a}{b}
                        let j = match.index + match[0].length;
                        const first = extractBracedContent(text, j);
                        if (first) {
                            const second = extractBracedContent(text, first.endIndex + 1);
                            if (second) {
                                result += wrap(text.substring(match.index, second.endIndex + 1));
                                lastIdx = second.endIndex + 1;
                                cmdRegex.lastIndex = lastIdx;
                                matchedWhole = true;
                            }
                        }
                    } else if (cmd === 'sqrt' || cmd === 'cbrt' || cmd === 'root') {
                        // Handle sqrt with optional nth root: \sqrt[n]{x}
                        let j = match.index + match[0].length;
                        while (j < text.length && /\s/.test(text[j])) j++;
                        if (text[j] === '[') {
                            const endBrkt = text.indexOf(']', j);
                            if (endBrkt !== -1) j = endBrkt + 1;
                        }
                        const content = extractBracedContent(text, j);
                        if (content) {
                            result += wrap(text.substring(match.index, content.endIndex + 1));
                            lastIdx = content.endIndex + 1;
                            cmdRegex.lastIndex = lastIdx;
                            matchedWhole = true;
                        }
                    } else if (cmd === 'left') {
                        // Handle \left...\right pairs
                        const remaining = text.substring(match.index);
                        const leftRightMatch = remaining.match(/^\\{1,4}left[\s]*[\(\[\{\|\\][\s\S]*?\\{1,4}right[\s]*[\)\]\}\|\\]/);
                        if (leftRightMatch) {
                            result += wrap(leftRightMatch[0]);
                            lastIdx = match.index + leftRightMatch[0].length;
                            cmdRegex.lastIndex = lastIdx;
                            matchedWhole = true;
                        }
                    } else if (cmd === 'begin') {
                        // Handle \begin{env}...\end{env} blocks
                        const remaining = text.substring(match.index);
                        const envMatch = remaining.match(/^\\begin\{([^}]+)\}([\s\S]*?)\\end\{\1\}/);
                        if (envMatch) {
                            result += wrap(envMatch[0]);
                            lastIdx = match.index + envMatch[0].length;
                            cmdRegex.lastIndex = lastIdx;
                            matchedWhole = true;
                        }
                    } else {
                        let currentIdx = match.index + match[0].length;
                        const bracedArg = extractBracedContent(text, currentIdx);
                        if (bracedArg) currentIdx = bracedArg.endIndex + 1;

                        while (currentIdx < text.length) {
                            let i = currentIdx;
                            while (i < text.length && /\s/.test(text[i])) i++;
                            if (text[i] === '_' || text[i] === '^') {
                                i++;
                                const braced = extractBracedContent(text, i);
                                if (braced) currentIdx = braced.endIndex + 1;
                                else if (/[a-zA-Z0-9]/.test(text[i])) currentIdx = i + 1;
                                else break;
                            } else break;
                        }
                        result += wrap(text.substring(match.index, currentIdx));
                        lastIdx = currentIdx;
                        cmdRegex.lastIndex = lastIdx;
                        matchedWhole = true;
                    }

                    if (!matchedWhole) {
                        result += text.substring(match.index, match.index + match[0].length);
                        lastIdx = match.index + match[0].length;
                    }
                }
                result += text.substring(lastIdx);
                text = result;

                // Simple scripts with balanced parentheses
                const tempM = [];
                text = text.replace(/\$[^$]+\$/g, (m) => { tempM.push(m); return `%%TM${tempM.length - 1}%%`; });
                text = text.replace(/(\(([^\(\)]+|(?:\([^\(\)]*\)))\)|[A-Za-z0-9])([\^_])(\{([^}]+)\}|[A-Za-z0-9])/g, (m) => wrap(m));
                text = text.replace(/%%TM(\d+)%%/g, (m, i) => tempM[parseInt(i)]);

                // Numeric fractions like 1/2
                text = text.replace(/(^|[^\/\\\d])(\d+)\/(\d+)(?![\/\d])/g, (m, p, n, d) => p + wrap(`\\frac{${n}}{${d}}`));

                // Symbols
                text = text.replace(/¬±/g, wrap('\\pm'));
                text = text.replace(/‚Ñè/g, wrap('\\hbar'));
                text = text.replace(/√Ö/g, wrap('\\text{√Ö}'));
                text = text.replace(/(\d+)¬∞/g, (m, num) => wrap(`${num}^{\\circ}`));
                text = text.replace(/‚â†/g, wrap('\\neq'));
                text = text.replace(/‚â§/g, wrap('\\leq'));
                text = text.replace(/‚â•/g, wrap('\\geq'));
                text = text.replace(/‚âà/g, wrap('\\approx'));

                // Dirac Notation
                text = text.replace(/\|([A-Za-z0-9Œ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒºŒΩŒæœÄœÅœÉœÑœÖœÜœáœàœâ\s\+\-\*\/\^\_\{\}\\]+)‚ü©/g, (m, inner) => wrap(`|${inner}\\rangle`));
                text = text.replace(/‚ü®([A-Za-z0-9Œ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒºŒΩŒæœÄœÅœÉœÑœÖœÜœáœàœâ\s\+\-\*\/\^\_\{\}\\]+)\|/g, (m, inner) => wrap(`\\langle ${inner}|`));

                // Set/logic symbols
                text = text.replace(/‚àà/g, wrap('\\in'));
                text = text.replace(/‚àâ/g, wrap('\\notin'));
                text = text.replace(/‚äÇ/g, wrap('\\subset'));
                text = text.replace(/‚äÜ/g, wrap('\\subseteq'));
                text = text.replace(/‚äÉ/g, wrap('\\supset'));
                text = text.replace(/‚äá/g, wrap('\\supseteq'));
                text = text.replace(/‚à™/g, wrap('\\cup'));
                text = text.replace(/‚à©/g, wrap('\\cap'));
                text = text.replace(/‚àÖ/g, wrap('\\emptyset'));
                text = text.replace(/‚àÄ/g, wrap('\\forall'));
                text = text.replace(/‚àÉ/g, wrap('\\exists'));

                // Arrows
                text = text.replace(/‚Üí/g, wrap('\\rightarrow'));
                text = text.replace(/‚Üê/g, wrap('\\leftarrow'));
                text = text.replace(/‚Üî/g, wrap('\\leftrightarrow'));
                text = text.replace(/‚áí/g, wrap('\\Rightarrow'));
                text = text.replace(/‚áê/g, wrap('\\Leftarrow'));
                text = text.replace(/‚áî/g, wrap('\\Leftrightarrow'));
                text = text.replace(/‚Üë/g, wrap('\\uparrow'));
                text = text.replace(/‚Üì/g, wrap('\\downarrow'));

                // Calculus symbols
                text = text.replace(/‚àÇ/g, wrap('\\partial'));
                text = text.replace(/‚àá/g, wrap('\\nabla'));
                text = text.replace(/‚à´/g, wrap('\\int'));
                text = text.replace(/‚à¨/g, wrap('\\iint'));
                text = text.replace(/‚à≠/g, wrap('\\iiint'));
                text = text.replace(/‚àÆ/g, wrap('\\oint'));
                text = text.replace(/‚àë/g, wrap('\\sum'));
                text = text.replace(/‚àè/g, wrap('\\prod'));
                text = text.replace(/‚àû/g, wrap('\\infty'));

                // Greek letters (Unicode to LaTeX)
                text = text.replace(/Œ±/g, wrap('\\alpha'));
                text = text.replace(/Œ≤/g, wrap('\\beta'));
                text = text.replace(/Œ≥/g, wrap('\\gamma'));
                text = text.replace(/Œ¥/g, wrap('\\delta'));
                text = text.replace(/Œµ/g, wrap('\\epsilon'));
                text = text.replace(/Œ∂/g, wrap('\\zeta'));
                text = text.replace(/Œ∑/g, wrap('\\eta'));
                text = text.replace(/Œ∏/g, wrap('\\theta'));
                text = text.replace(/Œπ/g, wrap('\\iota'));
                text = text.replace(/Œ∫/g, wrap('\\kappa'));
                text = text.replace(/Œª/g, wrap('\\lambda'));
                text = text.replace(/Œº/g, wrap('\\mu'));
                text = text.replace(/ŒΩ/g, wrap('\\nu'));
                text = text.replace(/Œæ/g, wrap('\\xi'));
                text = text.replace(/œÄ/g, wrap('\\pi'));
                text = text.replace(/œÅ/g, wrap('\\rho'));
                text = text.replace(/œÉ/g, wrap('\\sigma'));
                text = text.replace(/œÑ/g, wrap('\\tau'));
                text = text.replace(/œÖ/g, wrap('\\upsilon'));
                text = text.replace(/œÜ/g, wrap('\\phi'));
                text = text.replace(/œá/g, wrap('\\chi'));
                text = text.replace(/œà/g, wrap('\\psi'));
                text = text.replace(/œâ/g, wrap('\\omega'));
                text = text.replace(/Œì/g, wrap('\\Gamma'));
                text = text.replace(/Œî/g, wrap('\\Delta'));
                text = text.replace(/Œò/g, wrap('\\Theta'));
                text = text.replace(/Œõ/g, wrap('\\Lambda'));
                text = text.replace(/Œû/g, wrap('\\Xi'));
                text = text.replace(/Œ†/g, wrap('\\Pi'));
                text = text.replace(/Œ£/g, wrap('\\Sigma'));
                text = text.replace(/Œ¶/g, wrap('\\Phi'));
                text = text.replace(/Œ®/g, wrap('\\Psi'));
                text = text.replace(/Œ©/g, wrap('\\Omega'));

                // Multiplication: √ó
                text = text.replace(/√ó/g, wrap('\\times'));

                // Division: √∑
                text = text.replace(/√∑/g, wrap('\\div'));;

                // Restore
                text = text.replace(/%%EXISTING(\d+)%%/g, (m, i) => existingMath[parseInt(i)]);
                text = text.replace(/%%CODE(\d+)%%/g, (m, i) => codeBlocks[parseInt(i)]);


                return text;
            }


            // Function to render markdown with math support
            function renderMarkdownWithMath(text) {
                if (!text) return '';

                // 1. Pre-process: strip trailing tab characters from every line
                // Many copy-pastes from spreadsheets/docs add trailing tabs to text lines,
                // which would incorrectly trigger table conversion
                const rawLines = text.split('\n');
                const lines = rawLines.map(line => line.replace(/\t+$/, ''));

                // 2. Convert only genuine tab-separated data into markdown tables
                // A line qualifies as a table row ONLY if it has tabs AND at least 2 cells with real content
                let inTabTable = false;
                let processedLines = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line.includes('\t')) {
                        if (inTabTable) processedLines.push(''); // blank line to close table in markdown
                        inTabTable = false;
                        processedLines.push(line);
                        continue;
                    }

                    const cells = line.split('\t');
                    const filledCells = cells.filter(c => c.trim().length > 0);

                    if (filledCells.length >= 2) {
                        const formattedCells = cells.map(c => c.trim() || ' ');
                        const mdLine = '| ' + formattedCells.join(' | ') + ' |';
                        if (!inTabTable) {
                            processedLines.push(mdLine);
                            processedLines.push('| ' + formattedCells.map(() => '---').join(' | ') + ' |');
                            inTabTable = true;
                        } else {
                            processedLines.push(mdLine);
                        }
                    } else {
                        // Line has tabs but only 1 cell with content ‚Äî treat as normal text (strip tabs)
                        if (inTabTable) processedLines.push('');
                        inTabTable = false;
                        processedLines.push(line.replace(/\t/g, ' '));
                    }
                }
                text = processedLines.join('\n');

                // 2. Run auto-detection to convert patterns to $...$ 
                let processedText = autoDetectMath(text);

                // 3. Protect code blocks and extract ALL math patterns
                const placeholders = [];

                // Protect code blocks (triple backticks)
                processedText = processedText.replace(/```[\s\S]*?```/g, (match) => {
                    placeholders.push({ type: 'code', content: match });
                    return `%%PLACEHOLDER${placeholders.length - 1}%%`;
                });

                // Protect inline code (single backticks)
                processedText = processedText.replace(/`[^`]+`/g, (match) => {
                    placeholders.push({ type: 'code', content: match });
                    return `%%PLACEHOLDER${placeholders.length - 1}%%`;
                });

                // Extract and render block math ($$...$$)
                processedText = processedText.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                    try {
                        if (typeof katex !== 'undefined') {
                            const rendered = katex.renderToString(math, { displayMode: true, throwOnError: false });
                            placeholders.push({ type: 'rendered', content: rendered });
                            return `%%PLACEHOLDER${placeholders.length - 1}%%`;
                        }
                    } catch (e) { }
                    return match;
                });

                // Extract and render inline math ($...$)
                // Restriction: Inline math should not span more than one newline to avoid capturing large text blocks
                processedText = processedText.replace(/\$([^\$\n]+?)\$/g, (match, math) => {
                    try {
                        if (typeof katex !== 'undefined') {
                            const rendered = katex.renderToString(math, { displayMode: false, throwOnError: false });
                            placeholders.push({ type: 'rendered', content: rendered });
                            return `%%PLACEHOLDER${placeholders.length - 1}%%`;
                        }
                    } catch (e) { }
                    return match;
                });

                // 4. Configure marked with custom table renderer
                if (typeof marked !== 'undefined') {
                    const renderer = new marked.Renderer();

                    // Wrap tables in a scrollable div
                    renderer.table = (header, body) => {
                        return `<div class="table-wrapper">
                        <table>
                            <thead>${header}</thead>
                            <tbody>${body}</tbody>
                        </table>
                    </div>`;
                    };

                    marked.setOptions({ renderer: renderer, breaks: true, gfm: true });
                    processedText = marked.parse(processedText);
                }

                // 5. Sanitize Markdown HTML BEFORE restoring KaTeX
                if (typeof DOMPurify !== 'undefined') {
                    processedText = DOMPurify.sanitize(processedText);
                }

                // 6. Restore ALL placeholders
                processedText = processedText.replace(/%%PLACEHOLDER(\d+)%%/g, (match, index) => {
                    const item = placeholders[parseInt(index)];
                    return item ? item.content : match;
                });

                return processedText;
            }

            // Render all saved notes on page load
            function renderAllNotes() {
                document.querySelectorAll('.rendered-note').forEach(el => {
                    const rawContent = el.dataset.raw || '';
                    const textarea = document.createElement('textarea');
                    textarea.innerHTML = rawContent;
                    const decoded = textarea.value;
                    el.innerHTML = renderMarkdownWithMath(decoded);
                });
            }

            // Wait for KaTeX to load, then render
            function waitForLibraries(callback, maxWait = 5000) {
                const start = Date.now();
                const check = () => {
                    if (typeof katex !== 'undefined' && typeof marked !== 'undefined') {
                        callback();
                    } else if (Date.now() - start < maxWait) {
                        setTimeout(check, 100);
                    } else {
                        console.warn('Libraries not loaded, rendering plain text');
                        document.querySelectorAll('.rendered-note').forEach(el => {
                            const rawContent = el.dataset.raw || '';
                            const textarea = document.createElement('textarea');
                            textarea.innerHTML = rawContent;
                            el.textContent = textarea.value;
                        });
                    }
                };
                check();
            }

            waitForLibraries(renderAllNotes);

            // Tab switching
            const tabButtons = document.querySelectorAll('.tab-nav button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            function switchToTab(tabId) {
                const button = Array.from(tabButtons).find(b => b.dataset.tab === tabId);
                if (button) {
                    tabButtons.forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    tabPanels.forEach(p => p.classList.remove('active'));
                    button.classList.add('active');
                    button.setAttribute('aria-selected', 'true');
                    document.getElementById('tab-' + tabId).classList.add('active');
                }
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchToTab(button.dataset.tab);
                });
            });

            // Quick create note button
            const quickCreateBtn = document.getElementById('quick-create-note');
            if (quickCreateBtn) {
                quickCreateBtn.addEventListener('click', () => {
                    switchToTab('notes');
                    const noteInput = document.getElementById('note-input');
                    if (noteInput) {
                        noteInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => noteInput.focus(), 500);
                    }
                });
            }

            // Character counter for notes
            const noteInput = document.getElementById('note-input');
            const charCount = document.getElementById('char-count');
            const charCountContainer = charCount?.parentElement;

            if (noteInput && charCount) {
                noteInput.addEventListener('input', () => {
                    const len = noteInput.value.length;
                    charCount.textContent = len;
                    charCountContainer.classList.remove('warning', 'danger');
                    if (len > 1800) {
                        charCountContainer.classList.add('danger');
                    } else if (len > 1500) {
                        charCountContainer.classList.add('warning');
                    }
                });
            }

            // Live preview toggle
            const previewToggle = document.getElementById('preview-toggle');
            const previewContainer = document.getElementById('note-preview');
            const previewContent = document.getElementById('preview-content');

            if (previewToggle && previewContainer && noteInput) {
                previewToggle.addEventListener('change', () => {
                    previewContainer.classList.toggle('active', previewToggle.checked);
                    if (previewToggle.checked) updatePreview();
                });

                let previewTimeout;
                noteInput.addEventListener('input', () => {
                    if (previewToggle.checked) {
                        clearTimeout(previewTimeout);
                        previewTimeout = setTimeout(updatePreview, 300);
                    }
                });

                function updatePreview() {
                    const text = noteInput.value;
                    if (text.trim()) {
                        previewContent.innerHTML = renderMarkdownWithMath(text);
                    } else {
                        previewContent.innerHTML = '<span style="color: #999; font-style: italic;">Preview will appear here...</span>';
                    }
                }
            }

            // Search saved posts
            const searchInput = document.getElementById('saved-search');
            const savedPosts = document.querySelectorAll('.saved-post-card');

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.toLowerCase().trim();
                    savedPosts.forEach(card => {
                        const title = card.dataset.title || '';
                        const author = card.dataset.author || '';
                        if (title.includes(query) || author.includes(query)) {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }

            // --- Note Search with Meilisearch ---
            const noteSearchInput = document.getElementById('note-search-input');
            const noteSearchClear = document.getElementById('note-search-clear');
            const noteSearchStatus = document.getElementById('note-search-status');
            const noteSearchStatusText = document.getElementById('note-search-status-text');
            const noteSearchStats = document.getElementById('note-search-stats');
            const searchResultsContainer = document.getElementById('search-results-container');
            const notesListContainer = document.getElementById('notes-list-container');

            let searchDebounceTimer = null;
            let searchAbortController = null;
            let isSearchActive = false;

            function clearNoteSearch() {
                if (noteSearchInput) noteSearchInput.value = '';
                if (noteSearchClear) noteSearchClear.classList.remove('visible');
                if (noteSearchStatus) noteSearchStatus.classList.remove('visible');
                if (searchResultsContainer) {
                    searchResultsContainer.classList.remove('visible');
                    searchResultsContainer.innerHTML = '';
                }
                if (notesListContainer) notesListContainer.style.display = '';
                isSearchActive = false;
                // Remove any active match highlights
                document.querySelectorAll('.note-card.search-active-match').forEach(
                    c => c.classList.remove('search-active-match')
                );
            }

            async function performNoteSearch(query) {
                if (!query || query.length < 2) {
                    clearNoteSearch();
                    if (noteSearchClear && query) noteSearchClear.classList.add('visible');
                    return;
                }

                // Cancel previous request
                if (searchAbortController) searchAbortController.abort();
                searchAbortController = new AbortController();

                // Show loading state
                isSearchActive = true;
                if (noteSearchStatus) {
                    noteSearchStatusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                    noteSearchStats.textContent = '';
                    noteSearchStatus.classList.add('visible');
                }
                if (notesListContainer) notesListContainer.style.display = 'none';

                try {
                    const resp = await fetch(`/personal_post/search?q=${encodeURIComponent(query)}`, {
                        signal: searchAbortController.signal
                    });
                    const data = await resp.json();

                    if (!isSearchActive) return; // User cleared search while request was in-flight

                    const total = data.total || 0;
                    const results = data.results || [];
                    const processingTime = data.processing_time_ms;

                    // Update status
                    if (noteSearchStatus) {
                        noteSearchStatusText.textContent = total === 0
                            ? `No notes found for "${query}"`
                            : `${total} note${total !== 1 ? 's' : ''} found`;
                        noteSearchStats.textContent = processingTime !== undefined
                            ? `${processingTime}ms`
                            : '';
                        noteSearchStatus.classList.add('visible');
                    }

                    if (searchResultsContainer) {
                        if (results.length === 0) {
                            searchResultsContainer.innerHTML = `
                                <div style="text-align: center; padding: 2rem 1rem; color: #888;">
                                    <i class="fas fa-search" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.75rem; display: block;"></i>
                                    <p style="margin: 0;">No notes match <strong>"${query.replace(/</g, '&lt;')}"</strong></p>
                                    <p style="font-size: 0.8rem; margin-top: 0.5rem; color: #aaa;">Try different keywords or use <code>"quotes"</code> for exact phrases</p>
                                </div>
                            `;
                        } else {
                            searchResultsContainer.innerHTML = results.map(r => {
                                const dateStr = r.created_at
                                    ? new Date(r.created_at).toLocaleDateString(undefined, {
                                        year: 'numeric', month: 'short', day: 'numeric',
                                        hour: '2-digit', minute: '2-digit'
                                    })
                                    : '';
                                // Use snippet (cropped + highlighted)
                                const snippet = r.snippet || r.content_highlighted || '';
                                return `
                                    <div class="search-result-card" data-note-id="${r.id}" onclick="window.scrollToNote('${r.id}')">
                                        <div class="search-result-snippet">${snippet}</div>
                                        <div class="search-result-meta">
                                            <span><i class="far fa-clock"></i> ${dateStr}</span>
                                            <span><i class="fas fa-arrow-right" style="font-size: 0.7rem;"></i> Jump to note</span>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        }
                        searchResultsContainer.classList.add('visible');
                    }
                } catch (err) {
                    if (err.name === 'AbortError') return; // Cancelled ‚Äî a new search is in progress
                    console.error('Note search error:', err);
                    if (noteSearchStatus) {
                        noteSearchStatusText.textContent = 'Search failed. Please try again.';
                        noteSearchStatus.classList.add('visible');
                    }
                }
            }

            // Scroll to & highlight a note card from search results
            window.scrollToNote = function(noteId) {
                // Show the notes list temporarily
                if (notesListContainer) notesListContainer.style.display = '';
                if (searchResultsContainer) searchResultsContainer.classList.remove('visible');

                const noteCard = document.querySelector(`.note-card[data-note-id="${noteId}"]`);
                if (noteCard) {
                    // Remove previous highlights
                    document.querySelectorAll('.note-card.search-active-match').forEach(
                        c => c.classList.remove('search-active-match')
                    );
                    noteCard.classList.add('search-active-match');
                    noteCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };

            if (noteSearchInput) {
                noteSearchInput.addEventListener('input', () => {
                    const val = noteSearchInput.value.trim();
                    if (noteSearchClear) {
                        noteSearchClear.classList.toggle('visible', val.length > 0);
                    }
                    clearTimeout(searchDebounceTimer);
                    if (val.length < 2) {
                        clearNoteSearch();
                        if (val.length > 0 && noteSearchClear) noteSearchClear.classList.add('visible');
                        return;
                    }
                    searchDebounceTimer = setTimeout(() => performNoteSearch(val), 300);
                });

                // Handle Enter key for immediate search
                noteSearchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        clearTimeout(searchDebounceTimer);
                        const val = noteSearchInput.value.trim();
                        if (val.length >= 2) performNoteSearch(val);
                    }
                    if (e.key === 'Escape') {
                        clearNoteSearch();
                        noteSearchInput.blur();
                    }
                });
            }

            if (noteSearchClear) {
                noteSearchClear.addEventListener('click', () => {
                    clearNoteSearch();
                    if (noteSearchInput) noteSearchInput.focus();
                });
            }

            // (Global click handler moved to top-level IIFE for performance)

            // (Delete logic moved to top-level IIFE)

            // Confirm unsave for posts
            document.querySelectorAll('.unsave-form').forEach(form => {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (typeof window.showCustomConfirm === 'function') {
                        window.showCustomConfirm('Remove this post from your saved list?', confirmed => {
                            if (confirmed) form.submit();
                        });
                    } else if (confirm('Remove this post from your saved list?')) {
                        form.submit();
                    }
                });
            });

            // Prevent double submission
            const noteForm = document.getElementById('create-note-form');
            const addNoteBtn = document.getElementById('add-note-btn');

            if (noteForm && addNoteBtn) {
                noteForm.addEventListener('submit', () => {
                    addNoteBtn.disabled = true;
                    addNoteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
                });
            }

            // --- Edit Note Modal Bindings ---
            const editTextarea = document.getElementById('edit-note-content');
            const editCharCount = document.getElementById('edit-char-count');
            const saveEditBtn = document.getElementById('save-edit-btn');

            if (editTextarea && editCharCount) {
                editTextarea.addEventListener('input', () => {
                    editCharCount.textContent = editTextarea.value.length;
                });
            }

            if (saveEditBtn) {
                saveEditBtn.addEventListener('click', () => {
                    if (typeof window.saveNoteEdit === 'function') window.saveNoteEdit();
                });
            }

            // --- Note Sharing Logic ---
            let currentShareNoteId = null;
            let lastShareNoteId = null;

            document.querySelectorAll('.share-note-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentShareNoteId = btn.dataset.id;
                    console.log('Opening share modal for note:', currentShareNoteId);
                    openShareModal();
                    loadExistingShares(currentShareNoteId);
                });
            });

            function openShareModal() {
                const modal = document.getElementById('share-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';

                    // Reset fields ONLY if opening a different note
                    if (currentShareNoteId !== lastShareNoteId) {
                        document.getElementById('share-permissions').value = 'view';
                        document.getElementById('share-expiry').value = 'never';
                        document.getElementById('share-code').value = '';
                        document.getElementById('surprise-theme').value = 'none';
                        document.getElementById('share-surprise-photo').value = '';
                        document.getElementById('share-surprise-audio').value = '';
                        document.getElementById('use-typewriter').checked = false;
                        document.getElementById('surprise-options').style.display = 'none';
                        lastShareNoteId = currentShareNoteId;
                    }

                    document.addEventListener('keydown', handleShareModalEsc);
                }
            }

            window.closeShareModal = function () {
                const modal = document.getElementById('share-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    document.removeEventListener('keydown', handleShareModalEsc);
                }
            };

            function handleShareModalEsc(e) {
                if (e.key === 'Escape') closeShareModal();
            }

            async function loadExistingShares(noteId) {
                const list = document.getElementById('share-links-list');
                const container = document.getElementById('active-shares-container');
                if (!list || !container) return;

                try {
                    const response = await fetch(`/personal_post/shares/${noteId}`);
                    const shares = await response.json();

                    if (shares.length > 0) {
                        container.style.display = 'block';
                        list.innerHTML = shares.map(s => `
                        <div class="share-link-item">
                            <div class="share-link-url">
                                <input type="text" value="${s.url}" readonly onclick="this.select()">
                                <button class="btn-icon copy-btn" data-copy-text="${s.url}" title="Copy Link">
                                    <i class="far fa-copy"></i>
                                </button>
                            </div>
                            <div class="share-link-meta">
                                <span>
                                    <i class="fas fa-${s.permissions === 'edit' ? 'pen' : 'eye'}"></i> ${s.permissions.charAt(0).toUpperCase() + s.permissions.slice(1)}
                                    ${s.expires_at ? ' | Exp: ' + new Date(s.expires_at).toLocaleDateString() : ''}
                                </span>
                                <button class="revoke-btn" style="color: #d9534f; background:none; border:none; padding:5px; font-size:0.8rem; cursor:pointer;" data-share-id="${s.share_id}" title="Revoke">
                                    <i class="fas fa-trash-alt"></i> Revoke
                                </button>
                            </div>
                        </div>
                    `).join('');
                    } else {
                        container.style.display = 'none';
                        list.innerHTML = '';
                    }
                } catch (e) {
                    console.error('Error loading shares:', e);
                }
            }

            // Surprise theme toggle listener
            const themeSelect = document.getElementById('surprise-theme');
            const themeOptions = document.getElementById('surprise-options');
            if (themeSelect && themeOptions) {
                themeSelect.addEventListener('change', () => {
                    themeOptions.style.display = themeSelect.value === 'none' ? 'none' : 'block';
                });
            }

            const generateBtn = document.getElementById('generate-share-link');
            if (generateBtn) {
                generateBtn.addEventListener('click', async () => {
                    const permissions = document.getElementById('share-permissions').value;
                    const expires_in = document.getElementById('share-expiry').value;
                    const access_code = document.getElementById('share-code').value;
                    const surprise_theme = document.getElementById('surprise-theme').value;
                    const valentine_photo = document.getElementById('share-surprise-photo').files[0];
                    const valentine_audio = document.getElementById('share-surprise-audio').files[0];

                    const progressArea = document.getElementById('share-upload-progress');
                    const progressBar = document.getElementById('share-progress-bar');
                    const progressText = document.getElementById('share-progress-text');

                    console.log('Generating share link for:', currentShareNoteId);

                    generateBtn.disabled = true;
                    const originalText = generateBtn.textContent;
                    generateBtn.textContent = 'Generating...';

                    try {
                        const formData = new FormData();
                        formData.append('permissions', permissions);
                        formData.append('expires_in', expires_in);
                        formData.append('access_code', access_code);
                        formData.append('surprise_theme', surprise_theme);
                        formData.append('use_typewriter', document.getElementById('use-typewriter').checked ? 'true' : 'false');
                        if (valentine_photo) formData.append('valentine_photo', valentine_photo);
                        if (valentine_audio) formData.append('valentine_audio', valentine_audio);

                        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                        const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

                        if (progressArea) progressArea.style.display = 'block';

                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', `/personal_post/share/${currentShareNoteId}`, true);
                        xhr.setRequestHeader('X-CSRFToken', csrfToken);

                        xhr.upload.onprogress = (e) => {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                if (progressBar) progressBar.style.width = percent + '%';
                                if (progressText) progressText.textContent = `Uploading: ${percent}%`;
                            }
                        };

                        xhr.onload = function () {
                            generateBtn.disabled = false;
                            generateBtn.textContent = originalText;
                            if (progressArea) progressArea.style.display = 'none';

                            if (xhr.status >= 200 && xhr.status < 300) {
                                const result = JSON.parse(xhr.responseText);
                                if (result.success) {
                                    loadExistingShares(currentShareNoteId);
                                    document.getElementById('share-code').value = '';
                                    if (progressBar) progressBar.style.width = '0%';
                                } else {
                                    alert('Error: ' + (result.error || 'Unknown error'));
                                }
                            } else {
                                alert('Server error: ' + xhr.status);
                            }
                        };

                        xhr.onerror = function () {
                            generateBtn.disabled = false;
                            generateBtn.textContent = originalText;
                            if (progressArea) progressArea.style.display = 'none';
                            alert('Network error. Try again.');
                        };

                        xhr.send(formData);

                    } catch (e) {
                        console.error('Error during share generation:', e);
                        generateBtn.disabled = false;
                        generateBtn.textContent = originalText;
                        if (progressArea) progressArea.style.display = 'none';
                        alert('An error occurred. Please try again.');
                    }
                });
            }



            window.copyShareUrl = function (text, btn) {
                // Unify legacy call path
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => showCopyFeedback(btn));
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showCopyFeedback(btn);
                }
            };

            function showCopyFeedback(btn) {
                if (!btn) return;
                const icon = btn.querySelector('i');
                if (icon) {
                    const originalClass = icon.className;
                    icon.className = 'fas fa-check';
                    setTimeout(() => { icon.className = originalClass; }, 1500);
                }
            }

            // (Version history logic moved to top-level IIFE)
        });
    </script>

    <script>
        // ========== Offline Notes Sync System ==========
        (function () {
            const DB_NAME = 'echowithin_offline';
            const STORE_NAME = 'pending_notes';
            const DB_VERSION = 1;
            const CSRF = '{{ csrf_token() }}';

            // --- IndexedDB Helpers ---
            function openDB() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }

            function getAllPending() {
                return openDB().then(db => {
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(STORE_NAME, 'readonly');
                        const store = tx.objectStore(STORE_NAME);
                        const req = store.getAll();
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => reject(req.error);
                    });
                });
            }

            function addPending(note) {
                return openDB().then(db => {
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        const req = store.add(note);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => reject(req.error);
                    });
                });
            }

            function deletePending(id) {
                return openDB().then(db => {
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        const req = store.delete(id);
                        req.onsuccess = () => resolve();
                        req.onerror = () => reject(req.error);
                    });
                });
            }

            function clearAllPending() {
                return openDB().then(db => {
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        const req = store.clear();
                        req.onsuccess = () => resolve();
                        req.onerror = () => reject(req.error);
                    });
                });
            }

            // --- UI Helpers ---
            const banner = document.getElementById('offline-banner');
            const bannerText = document.getElementById('offline-banner-text');
            const pendingContainer = document.getElementById('pending-notes-container');

            function setBanner(state) {
                banner.className = 'offline-banner';
                if (state === 'offline') {
                    banner.classList.add('offline');
                    banner.querySelector('i').className = 'fas fa-wifi';
                    bannerText.textContent = "You're offline ‚Äî notes will sync when you reconnect";
                    banner.style.display = 'flex';
                } else if (state === 'syncing') {
                    banner.classList.add('syncing');
                    banner.querySelector('i').className = 'fas fa-sync fa-spin';
                    bannerText.textContent = 'Syncing your offline notes...';
                    banner.style.display = 'flex';
                } else {
                    banner.style.display = 'none';
                }
            }

            function renderPendingNotes(notes) {
                if (!notes.length) {
                    pendingContainer.innerHTML = '';
                    return;
                }
                pendingContainer.innerHTML = notes.map(n => {
                    const escaped = (n.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const preview = escaped.substring(0, 300) + (escaped.length > 300 ? '...' : '');
                    const ts = new Date(n.created_at).toLocaleString();
                    return `
                    <div class="note-card pending-note">
                        <div class="note-content"><pre style="white-space:pre-wrap;margin:0;font-family:inherit;">${preview}</pre></div>
                        <div class="note-footer">
                            <span class="note-date">
                                <i class="far fa-clock"></i> ${ts}
                                <span class="pending-badge"><i class="fas fa-spinner"></i> Pending sync</span>
                            </span>
                        </div>
                    </div>
                `;
                }).join('');
            }

            // --- Form Intercept ---
            const form = document.getElementById('create-note-form');
            if (form) {
                form.addEventListener('submit', function (e) {
                    if (!navigator.onLine) {
                        e.preventDefault();
                        const textarea = document.getElementById('note-input');
                        const content = textarea.value.trim();
                        if (!content) return;

                        const note = {
                            content: content,
                            created_at: new Date().toISOString()
                        };

                        addPending(note).then(() => {
                            textarea.value = '';
                            document.getElementById('char-count').textContent = '0';
                            return getAllPending();
                        }).then(renderPendingNotes).catch(err => {
                            console.error('Failed to save offline note:', err);
                            alert('Failed to save note offline. Please try again.');
                        });
                    }
                    // If online, let the form submit normally
                });
            }

            // --- Sync Logic ---
            async function syncPendingNotes() {
                const pending = await getAllPending();
                if (!pending.length) return;

                setBanner('syncing');
                let allSynced = true;

                for (const note of pending) {
                    try {
                        const resp = await fetch('/personal_post/create_json', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': CSRF
                            },
                            body: JSON.stringify({ content: note.content })
                        });
                        if (resp.ok) {
                            await deletePending(note.id);
                        } else {
                            allSynced = false;
                        }
                    } catch {
                        allSynced = false;
                    }
                }

                if (allSynced) {
                    setBanner('hidden');
                    // Reload to show the synced notes from server
                    window.location.reload();
                } else {
                    setBanner('offline');
                    bannerText.textContent = 'Some notes failed to sync. Will retry when connection improves.';
                }
            }

            // --- Connectivity Events ---
            function updateOnlineStatus() {
                if (navigator.onLine) {
                    syncPendingNotes();
                } else {
                    getAllPending().then(notes => {
                        if (notes.length) setBanner('offline');
                        else setBanner('offline'); // Still show banner even if no pending notes, just to indicate offline
                        renderPendingNotes(notes);
                    });
                }
            }

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);

            // --- Init: show pending notes on load ---
            getAllPending().then(notes => {
                if (notes.length) {
                    renderPendingNotes(notes);
                    if (navigator.onLine) {
                        syncPendingNotes();
                    } else {
                        setBanner('offline');
                    }
                } else if (!navigator.onLine) {
                    setBanner('offline'); // Show offline banner even if no pending notes
                }
            });
            // Valentine toggle helper
            const vToggle = document.getElementById('share-valentine');
            if (vToggle) {
                vToggle.addEventListener('change', () => {
                    const opts = document.getElementById('valentine-options');
                    if (opts) opts.style.display = vToggle.checked ? 'block' : 'none';
                });
            }
        })();
    </script>
    {% endblock %}