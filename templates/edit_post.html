{% extends "base.html" %}

{% block title %}
    <title>{{ title }}</title>
    <meta name="description" content="{{ description }}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    {% if action == 'edit' %}
        <!-- Edit Post Form -->
        <div class="create-post-section" style="padding: 20px;">
            <h3>Edit Post</h3>
            <form action="{{ url_for('update_post', post_id=post._id) }}" method="POST" class="post-form" id="edit-post-form" enctype="multipart/form-data">
                <input type="text" name="title" class="form-input" placeholder="Post Title" value="{{ post.title }}" required>
                <textarea name="content" class="form-input" placeholder="What's on your mind?" rows="10" required>{{ post.content }}</textarea>
                
                <div>
                    <label for="image">Upload a New Image (Optional):</label>
                    <label for="image">Upload a New Image (Optional, max 10 MB):</label>
                    {% if post.image_url or post.image_filename %}
                        <p>Current image:</p>
                        {% if post.image_url %}
                            <img src="{{ post.image_url }}" alt="Current image" class="edit-post-image-preview">
                        {% else %}
                            <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" alt="Current image" class="edit-post-image-preview">
                        {% endif %}
                    {% endif %}
                    <input type="file" name="image" class="form-input" accept="image/*">
                </div>

                <div>
                    <label for="video">Upload a New Video (Optional, max 10 MB):</label>
                    {% if post.video_url or post.video_filename %}
                        <p>Current video:</p>
                        {% if post.video_url %}
                            <video controls class="edit-post-video-preview">
                                <source src="{{ post.video_url }}" type="video/{{ post.video_url.rsplit('.', 1)[1] if post.video_url and '.' in post.video_url else 'mp4' }}">
                                Your browser does not support the video tag.
                            </video>
                        {% else %}
                            <video controls class="edit-post-video-preview">
                                <source src="{{ url_for('uploaded_file', filename=post.video_filename) }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        {% endif %}
                    {% endif %}
                    <input type="file" name="video" class="form-input" accept="video/*">
                </div>

                <button type="submit" class="form-button" id="update-post-submit-btn">Update Post</button>
                <button type="button" class="form-button delete-btn" id="edit-cancel-upload-btn" style="display: none; margin-left: 10px;">Cancel</button>
                <small id="edit-upload-status" style="display: none; margin-top: 10px;"></small>
                <div id="edit-progress-container" style="display: none; width: 100%; background-color: #ddd; border-radius: 5px; margin-top: 10px;">
                    <div id="edit-progress-bar" style="width: 0%; height: 24px; background-color: #4CAF50; text-align: center; line-height: 24px; color: white; border-radius: 5px;">0%</div>
                </div>
            </form>
        </div>

    {% elif action == 'comment' %}
        <!-- View Post and Comments -->
        <div class="post-item" style="border-left: none; box-shadow: none; padding: 20px;">
            <h1>{{ post.title }}</h1>
            <div class="post-meta">
                Posted by <strong>{{ post.author }}</strong> on {{ post.timestamp.strftime('%b %d, %Y at %I:%M %p') }}
            </div>

            <!-- Media Display Logic: show video if present, otherwise image -->
            {% if post.video_url or post.video_filename %}
                <div class="post-media-container">
                    {% if post.video_url %}
                        <video class="post-video" controls preload="metadata">
                            <source src="{{ post.video_url }}" type="video/{{ post.video_url.rsplit('.', 1)[1] if post.video_url and '.' in post.video_url else 'mp4' }}">
                            Your browser does not support the video tag.
                        </video>
                    {% elif post.video_filename %}
                        <video class="post-video" controls preload="metadata">
                            <source src="{{ url_for('uploaded_file', filename=post.video_filename) }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% endif %}
                </div>
            {% elif post.image_url or post.image_filename %}
                <div class="post-image-container {% if post.image_status == 'processing' %}processing{% endif %}">
                    {% if post.image_url %}
                        {% if post.image_status == 'safe' %}
                            <img src="{{ post.image_url }}" alt="Post image for {{ post.title }}" class="post-image">
                        {% elif post.image_status == 'removed_nsfw' %}
                            <div class="nsfw-placeholder">Image removed for containing sensitive content.</div>
                        {% endif %}
                    {% elif post.image_filename %}
                        <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" alt="Post image for {{ post.title }}" class="post-image">
                    {% endif %}
                </div>
            {% endif %}

            <div class="post-content" style="white-space: pre-wrap;">{{ post.content|linkify|safe }}</div>

            <!-- Remark42 Comment Section -->
            <div class="comments-section" style="margin-top: 30px;">
                <h3>
                    Comments <span class="remark42__counter" data-remark-url="{{ url_for('view_post', slug=post.slug, _external=True) }}"></span>
                </h3>
                <div id="remark42"></div>
            </div>
            
        </div>
    {% endif %}
</div>

<script>
    // This configuration block must be defined before the Remark42 script is loaded.
    {% if action == 'comment' and remark42_host and remark42_site_id %}
        var remark_config = {
            host: "{{ remark42_host|safe }}",
            site_id: "{{ remark42_site_id|safe }}",
            url: "{{ url_for('view_post', slug=post.slug, _external=True) }}",
            theme: 'dark',
            components: ['embed', 'counter']
        };
    {% endif %}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const editPostForm = document.getElementById('edit-post-form');
    {% if action == 'edit' %}
    let xhr; // Define xhr in a scope accessible to the cancel handler
    const MAX_VIDEO_SIZE = 10 * 1024 * 1024; // 10 MB client-side check

    if (editPostForm) {
        editPostForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const videoInput = this.querySelector('input[name="video"]');
            const submitButton = document.getElementById('update-post-submit-btn');
            const cancelButton = document.getElementById('edit-cancel-upload-btn');
            const statusElement = document.getElementById('edit-upload-status');
            const progressContainer = document.getElementById('edit-progress-container');
            const progressBar = document.getElementById('edit-progress-bar');

            if (videoInput.files.length > 0) {
                const videoFile = videoInput.files[0];

                // Client-side basic checks
                if (videoFile.size > MAX_VIDEO_SIZE) {
                    statusElement.textContent = 'Video exceeds maximum allowed size of 10 MB.';
                    statusElement.style.display = 'block';
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = 'Uploading...';
                statusElement.textContent = 'Uploading video...';
                statusElement.style.display = 'block';
                cancelButton.style.display = 'inline-block';
                progressContainer.style.display = 'block';

                const formData = new FormData(this); // Grabs existing fields
                formData.set('video', videoFile, videoFile.name);

                xhr = new XMLHttpRequest();
                xhr.open('POST', this.action, true);

                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        progressBar.textContent = percentComplete + '%';
                    }
                };

                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        window.location.href = xhr.responseURL;
                    } else {
                        statusElement.textContent = 'Upload failed. Server responded with an error.';
                        resetEditUploadUI();
                    }
                };

                xhr.onabort = function() {
                    statusElement.textContent = 'Upload cancelled.';
                    resetEditUploadUI();
                };

                xhr.onerror = function() {
                    statusElement.textContent = 'Upload failed due to a network error.';
                    resetEditUploadUI();
                };

                cancelButton.onclick = function() {
                    if (xhr) xhr.abort();
                };

                xhr.send(formData);
            } else {
                this.submit();
            }
        });
    }

    function resetEditUploadUI(message) {
        const submitButton = document.getElementById('update-post-submit-btn');
        const cancelButton = document.getElementById('edit-cancel-upload-btn');
        const progressContainer = document.getElementById('edit-progress-container');
        const videoInput = document.querySelector('#edit-post-form input[name="video"]');
        const statusElement = document.getElementById('edit-upload-status');

        if (message) {
            statusElement.textContent = message;
            statusElement.style.display = 'block';
        }
        submitButton.disabled = false;
        submitButton.textContent = 'Update Post';
        cancelButton.style.display = 'none';
        progressContainer.style.display = 'none';
        // Clear the file input
        videoInput.value = '';
    }
    {% endif %}
});
</script>

{# Load the Remark42 script directly if we are on the comment page #}
{% if action == 'comment' and remark42_host and remark42_site_id %}
    <script src="{{ remark42_host|safe }}/web/embed.js" defer></script>
    <script src="{{ remark42_host|safe }}/web/counter.js" defer></script>
{% endif %}
{% endblock %}